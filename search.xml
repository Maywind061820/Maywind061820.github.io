<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Hello World</title>
    <url>/2025/08/07/Hello-World/</url>
    <content><![CDATA[<h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World!"></a>Hello World!</h2>]]></content>
  </entry>
  <entry>
    <title>R语言语法</title>
    <url>/2025/10/12/Rgrammar/</url>
    <content><![CDATA[<h1 id="R语言语法"><a href="#R语言语法" class="headerlink" title="R语言语法"></a>R语言语法</h1><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="注释（同python）"><a href="#注释（同python）" class="headerlink" title="注释（同python）"></a>注释（同python）</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 这是注释</span></span><br><span class="line">print<span class="punctuation">(</span><span class="string">&quot;hello world&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 利用不可执行进行多行注释</span></span><br><span class="line"><span class="keyword">if</span><span class="punctuation">(</span><span class="literal">FALSE</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;</span></span><br><span class="line"><span class="string">    R语言将会臭名昭著</span></span><br><span class="line"><span class="string">    Rubbish R,it is so stupid.</span></span><br><span class="line"><span class="string">    &quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="使用ls-来查看当前变量"><a href="#使用ls-来查看当前变量" class="headerlink" title="使用ls()来查看当前变量"></a>使用<code>ls()</code>来查看当前变量</h3><ul>
<li><p>使用<code>rm(变量名)</code>来删除变量</p>
 <figure class="highlight r"><table><tr><td class="code"><pre><span class="line">rm<span class="punctuation">(</span><span class="built_in">list</span> <span class="operator">=</span> ls<span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="comment"># 删除所有变量</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>使用<code>setwd()</code>设置工作目录</p>
</li>
<li><p>使用<code>getwd()</code>查看工作目录 </p>
</li>
</ul>
<h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><ul>
<li><p><strong>赋值运算符</strong></p>
<ul>
<li><p>使用’-&gt;’ ‘-&gt;&gt;’ ‘=’ ‘&lt;-‘ ‘&lt;&lt;-‘来赋值</p>
</li>
<li><p><strong>Warning</strong>：在某些场合<code>&lt;-</code>   和<code>=</code>不等价</p>
</li>
</ul>
</li>
<li><p><strong>数学运算符</strong></p>
<p>| 优先级 | 符号  |   含义   |<br>| :——: | :—-: | :———: |<br>|   1    |  ()   |   括号   |<br>|   2    |   ^   | 乘方运算 |<br>|   3    |  %%   |  模运算  |<br>|        |  %/%  |   整除   |<br>|   4    |   /   |   除法   |<br>|        |   *   |   乘法   |<br>|   5    |   +   |   加法   |<br>|        |   -   |   减法   |</p>
</li>
<li><p><strong>关系运算符</strong></p>
<p>  包括<code>== &gt; &lt; &lt;= &gt;= !=</code></p>
</li>
<li><p><strong>逻辑运算符</strong></p>
<p>  包括<code>&amp; | ! &amp;&amp; ||</code></p>
</li>
<li><p><strong>其他</strong></p>
<ul>
<li>冒号运算符<code>:</code>用于创建向量</li>
<li><code>A %in% P</code>判断A是否存在于P中</li>
<li><code>A %*% B</code> 矩阵A * B</li>
</ul>
</li>
</ul>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><h3 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h3><ul>
<li>数字<ul>
<li>一般</li>
<li>科学计数法</li>
</ul>
</li>
<li>逻辑</li>
<li>文本</li>
</ul>
<h3 id="向量-vector"><a href="#向量-vector" class="headerlink" title="向量(vector)"></a>向量(vector)</h3><ul>
<li><p>创建：</p>
<ul>
<li><p>使用<code>c()</code>创建向量</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">a <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">)</span></span><br><span class="line">b <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">)</span></span><br><span class="line">print<span class="punctuation">(</span>a <span class="operator">+</span> b<span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 将输出3 9</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>seq(m,n,d)</code>生成有空隔的数列</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">seq<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">)</span> <span class="comment"># 1,3,5,7,9</span></span><br><span class="line">seq<span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>length.out <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span> <span class="comment"># 0,0.5,1</span></span><br></pre></td></tr></table></figure></li>
<li>使用<code>rep(m,n)</code>生成重复序列<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">5</span><span class="punctuation">)</span> <span class="comment"># 0,0,0,0,0 </span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>取下标  <figure class="highlight r"><table><tr><td class="code"><pre><span class="line">a <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">)</span></span><br><span class="line">a<span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> <span class="comment"># 取第2项</span></span><br><span class="line">a<span class="punctuation">[</span><span class="number">1</span><span class="operator">:</span><span class="number">5</span><span class="punctuation">]</span> <span class="comment">#取第1-5项</span></span><br><span class="line">a<span class="punctuation">[</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="comment">#取第1,3,5项</span></span><br><span class="line">a<span class="punctuation">[</span><span class="built_in">c</span><span class="punctuation">(</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">5</span><span class="punctuation">)</span><span class="punctuation">]</span> <span class="comment">#取除了第1,5项</span></span><br></pre></td></tr></table></figure></li>
<li>标量运算  <figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="built_in">c</span><span class="punctuation">(</span><span class="number">3</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">,</span> <span class="number">5</span><span class="punctuation">)</span> <span class="operator">-</span> <span class="number">1</span></span><br><span class="line"><span class="comment"># 输出2 3 4</span></span><br><span class="line">a <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> <span class="number">2</span><span class="punctuation">)</span></span><br><span class="line">a <span class="operator">^</span> <span class="number">2</span></span><br><span class="line"><span class="comment"># 输出1 4</span></span><br></pre></td></tr></table></figure></li>
<li>排序<ul>
<li><code>sort(a,decreasing = FALSE,na.last = TRUE)</code><ul>
<li>其中 a 为待排序向量,decreasing默认为 F,F 为升序,T 为降序。</li>
<li>na.last 表示是否将缺失值放在最后，若F为最前</li>
</ul>
</li>
<li><code>order(a)</code><ul>
<li>返回排序后的索引位置</li>
</ul>
</li>
<li><code>rev(a)</code><ul>
<li>反转 a</li>
</ul>
</li>
</ul>
</li>
<li>统计函数<br>  | 函数名 |                 含义                 |<br>  | :——: | :—————————————————: |<br>  |  sum   |                 求和                 |<br>  |  mean  |               求平均值               |<br>  |  var   |                 方差                 |<br>  |   sd   |                标准差                |<br>  |  min   |                最小值                |<br>  |  max   |                最大值                |<br>  | range  | 取值范围（二维向量，最大值和最小值） |</li>
<li>其他<ul>
<li><code>which(表达式)</code><ul>
<li>返回表达式为真的下标向量</li>
</ul>
</li>
<li><pre><code class="lang-all()```">- 相当于对向量的所有元素进行 ```&amp;&amp;
</code></pre>
</li>
<li><pre><code class="lang-any()```">- 相当于对向量的所有元素进行 ```||
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 id="列表-list"><a href="#列表-list" class="headerlink" title="列表(list)"></a>列表(list)</h3><ul>
<li>和python差不多</li>
</ul>
<h3 id="矩阵-matrix"><a href="#矩阵-matrix" class="headerlink" title="矩阵(matrix)"></a>矩阵(matrix)</h3><p><del>2维数组</del></p>
<ul>
<li>创建<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">matrix<span class="punctuation">(</span>data <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> nrow <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> ncol <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> byrow <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span><span class="built_in">dimnames</span> <span class="operator">=</span> <span class="literal">NULL</span> or <span class="built_in">list</span><span class="punctuation">(</span>rownames<span class="punctuation">,</span>colnames<span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>分别是填充的数据(向量格式、行数、列数、按行填充、行列名称)</li>
</ul>
</li>
<li>访问矩阵的元素采用<code>[a,b]</code></li>
<li>矩阵运算，统统支持</li>
<li><code>t()</code>实现矩阵转置</li>
<li><code>solve(A,b)</code>解线性方程组 <code>solve(A)</code>直接矩阵求逆</li>
<li><code>apply(A,x,function())</code> 将矩阵按行或按列应用于function()，x=1按行操作，x=2按列操作。</li>
</ul>
<h3 id="数组-array"><a href="#数组-array" class="headerlink" title="数组(array)"></a>数组(array)</h3><p><del>3维数组</del></p>
<h3 id="因子-factor"><a href="#因子-factor" class="headerlink" title="因子(factor)"></a>因子(factor)</h3><h3 id="数据框-data-frame"><a href="#数据框-data-frame" class="headerlink" title="数据框(data.frame)"></a>数据框(data.frame)</h3><h2 id="循环与条件语句"><a href="#循环与条件语句" class="headerlink" title="循环与条件语句"></a>循环与条件语句</h2><h2 id="操作函数"><a href="#操作函数" class="headerlink" title="操作函数"></a>操作函数</h2>]]></content>
      <categories>
        <category>R</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>绘图</tag>
      </tags>
  </entry>
  <entry>
    <title>README</title>
    <url>/2025/08/07/README/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>R医学统计图形</title>
    <url>/2025/10/12/Rgraphics/</url>
    <content><![CDATA[<h1 id="R医学统计图形"><a href="#R医学统计图形" class="headerlink" title="R医学统计图形"></a>R医学统计图形</h1><h2 id="基础绘图包"><a href="#基础绘图包" class="headerlink" title="基础绘图包"></a>基础绘图包</h2><h3 id="par-函数"><a href="#par-函数" class="headerlink" title="par()函数"></a>par()函数</h3><figure class="highlight r"><table><tr><td class="code"><pre><span class="line">help<span class="punctuation">(</span><span class="string">&quot;par&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p>一共有60多个参数。</p>
<h2 id="颜色的选取"><a href="#颜色的选取" class="headerlink" title="颜色的选取"></a>颜色的选取</h2><h2 id="ggplot2"><a href="#ggplot2" class="headerlink" title="ggplot2"></a>ggplot2</h2><h2 id="其他静态图形的绘制"><a href="#其他静态图形的绘制" class="headerlink" title="其他静态图形的绘制"></a>其他静态图形的绘制</h2><h2 id="动态交互绘图系统"><a href="#动态交互绘图系统" class="headerlink" title="动态交互绘图系统"></a>动态交互绘图系统</h2>]]></content>
      <categories>
        <category>R</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>绘图</tag>
      </tags>
  </entry>
  <entry>
    <title>生信速通？？？</title>
    <url>/2025/10/12/test/</url>
    <content><![CDATA[<h1 id="生信速通"><a class="markdownIt-Anchor" href="#生信速通"></a> 生信速通？？？</h1>
<p><s>其实本人是比较反感不求甚解的</s></p>
<p><s>但是总不能速通生物学有关内容、计算机组成原理、数学、编程吧</s></p>
<p>我们希望学习以下内容：</p>
<ul>
<li>R语言语法</li>
<li>各种图形的绘制</li>
<li>TCGA的使用</li>
<li>COX回归分析</li>
<li>GO KEGG GESA富集分析</li>
<li>…</li>
</ul>
<p>R这个东西在我看来根本不是一门编程语言，而是一个工具。看各种教程所谓各种函数满天飞，各种包满天飞，编程没有逻辑性，没有美感，只剩下机械的记忆。</p>
<p>B站的教程大多讲不清原理，或多或少地进行了关键部分的模糊和隐藏。令人汗颜！</p>
<p>可恶，然而……</p>
<hr />
<p>本篇旨在介绍一些基础概念和流程。您可以查看其他文章以获取更详细的信息。</p>
<p>呐，要开始了哟！</p>
<hr />
<h2 id="0测序过程"><a class="markdownIt-Anchor" href="#0测序过程"></a> 0.测序过程</h2>
<p><a href="https://www.bilibili.com/video/BV1v34y147nj">illumina技术原理</a></p>
<h2 id="0几个术语"><a class="markdownIt-Anchor" href="#0几个术语"></a> 0.几个术语</h2>
<ul>
<li>reads: 一个 read 是落到某个基因的一个DNA测序片段</li>
<li>counts：一个基因的 reads 总数即为该基因的 counts</li>
<li>基因长度：目标基因非重叠外显子长度之和（有几个碱基对）</li>
<li>测序深度：测序得到的基因总量（bp）与基因组（测序目标区域、转录组）的比值。</li>
</ul>
<hr />
<ul>
<li>RPK(每千个碱基的read数)
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>RPK</mtext><mi>i</mi></msub><mo>=</mo><mn>1</mn><msup><mn>0</mn><mn>3</mn></msup><mo>⋅</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><msub><mi>n</mi><mi>i</mi></msub><msub><mi>l</mi><mi>i</mi></msub></mfrac></mstyle></mrow><annotation encoding="application/x-tex">\text{RPK}_i = 10 ^ 3 \cdot \dfrac{n_i}{l_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">RPK</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.94356em;vertical-align:-0.8360000000000001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1075599999999999em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></li>
<li>平衡掉基因长度的影响</li>
</ul>
</li>
</ul>
<hr />
<ul>
<li>RPKM
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>RPKM</mtext><mi>i</mi></msub><mo>=</mo><mn>1</mn><msup><mn>0</mn><mn>6</mn></msup><mo>⋅</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><msub><mtext>RPK</mtext><mi>i</mi></msub><mrow><msub><mo>∑</mo><mi>j</mi></msub><msub><mi>n</mi><mi>j</mi></msub></mrow></mfrac></mstyle></mrow><annotation encoding="application/x-tex">\text{RPKM}_i = 10 ^ 6 \cdot \dfrac{\text{RPK}_i}{\sum _j n_j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">RPKM</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.4821480000000005em;vertical-align:-1.1218180000000002em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16195399999999993em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord text"><span class="mord">RPK</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1218180000000002em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></li>
<li>在RPK的基础上平衡掉基因深度的影响</li>
<li>RPKM是单端测序的概念，FPKM是双端测序的概念</li>
<li><strong>可以组内比较，无法组间比较</strong></li>
</ul>
</li>
</ul>
<hr />
<ul>
<li>TPM
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>TPM</mtext><mi>i</mi></msub><mo>=</mo><mn>1</mn><msup><mn>0</mn><mn>6</mn></msup><mo>⋅</mo><msub><mstyle displaystyle="true" scriptlevel="0"><mfrac><msub><mtext>RPK</mtext><mi>i</mi></msub><mrow><msub><mo>∑</mo><mi>j</mi></msub><mtext>RPK</mtext></mrow></mfrac></mstyle><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\text{TPM}_i = 10 ^ 6 \cdot \dfrac{\text{RPK}_i}{\sum _j \text{RPK}}_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">TPM</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.667956em;vertical-align:-1.3076260000000002em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16195399999999993em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord text"><span class="mord">RPK</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord text"><span class="mord">RPK</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1218180000000002em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:-0.7098540000000002em;"><span style="top:-1.528482em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3076260000000002em;"><span></span></span></span></span></span></span></span></span></span></li>
<li><strong>既可组内比较，也可组间比较</strong></li>
</ul>
</li>
</ul>
<hr />
<ul>
<li>CPM
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext>CPM</mtext><mi>i</mi></msub><mo>=</mo><mn>1</mn><msup><mn>0</mn><mn>6</mn></msup><mo>⋅</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><msub><mi>n</mi><mi>i</mi></msub><mrow><msub><mo>∑</mo><mi>j</mi></msub><msub><mi>n</mi><mi>j</mi></msub></mrow></mfrac></mstyle></mrow><annotation encoding="application/x-tex">\text{CPM}_i = 10 ^ 6 \cdot \dfrac{n_i}{\sum _j n_j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord text"><span class="mord">CPM</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.229378em;vertical-align:-1.1218180000000002em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1075599999999999em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16195399999999993em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1218180000000002em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></li>
<li><strong>不可组内比较，可以组间比较</strong></li>
</ul>
</li>
</ul>
<h1 id="标题测试"><a class="markdownIt-Anchor" href="#标题测试"></a> 标题测试</h1>
<h2 id="第一部分estimate评分计算"><a class="markdownIt-Anchor" href="#第一部分estimate评分计算"></a> 第一部分：ESTIMATE评分计算</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### Day3 ####</span></span><br><span class="line"><span class="comment">#### ESTIMATE ####</span></span><br><span class="line"><span class="comment"># 计算患者免疫评分与肿瘤纯度</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/ESTIMATE&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次性加载所有需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>utils<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>estimate<span class="punctuation">)</span>    <span class="comment"># 用于计算ESTIMATE评分</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span>   <span class="comment"># 数据清洗和整理</span></span><br><span class="line">library<span class="punctuation">(</span>survival<span class="punctuation">)</span>    <span class="comment"># 生存分析</span></span><br><span class="line">library<span class="punctuation">(</span>survminer<span class="punctuation">)</span>   <span class="comment"># 生存分析可视化</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取肿瘤患者01A表达谱</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                  check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：这部分是肿瘤微环境分析，通过ESTIMATE算法计算肿瘤纯度、免疫细胞和基质细胞评分。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>setwd()</code>: 设置工作目录</li>
<li><code>read.table()</code>: 读取表格文件，参数<code>row.names=1</code>表示第一列作为行名</li>
<li><code>check.names=F</code>: 保持列名原样，不自动修改特殊字符</li>
</ul>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 计算免疫评分</span></span><br><span class="line">filterCommonGenes<span class="punctuation">(</span>input.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  output.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  id <span class="operator">=</span> <span class="string">&quot;GeneSymbol&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">estimateScore<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">              platform <span class="operator">=</span> <span class="string">&quot;affymetrix&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：ESTIMATE算法需要特定的基因集，第一步过滤共同基因，第二步计算评分。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li>这些都是<code>estimate</code>包的专用函数</li>
<li><code>platform=&quot;affymetrix&quot;</code>: 指定芯片平台类型</li>
</ul>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 提取结果并整理</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span>  <span class="comment"># 删除第一列</span></span><br><span class="line">colnames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span>  <span class="comment"># 第一行作为列名</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>t<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">[</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span>  <span class="comment"># 转置并删除第一行</span></span><br><span class="line">rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> colnames<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span>  <span class="comment"># 设置样本名为行名</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：整理ESTIMATE输出结果，使其成为标准的样本×评分的数据框。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>[,-1]</code>: 删除第一列</li>
<li><code>t()</code>: 矩阵转置</li>
<li><code>colnames()</code>, <code>rownames()</code>: 设置列名和行名</li>
</ul>
<hr />
<h2 id="第二部分生存数据整合"><a class="markdownIt-Anchor" href="#第二部分生存数据整合"></a> 第二部分：生存数据整合</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### 生存信息整理 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../Survival_data&quot;</span><span class="punctuation">)</span>  <span class="comment"># 切换到上级目录的Survival_data文件夹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理生存数据</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span>  <span class="comment"># 只保留第2-3列</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival <span class="operator">%&gt;%</span> rownames_to_column<span class="punctuation">(</span><span class="string">&#x27;sample&#x27;</span><span class="punctuation">)</span>  <span class="comment"># 行名转为列</span></span><br><span class="line">survival<span class="operator">$</span>name <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span>survival<span class="operator">$</span>sample<span class="punctuation">,</span> <span class="string">&#x27;A&#x27;</span><span class="punctuation">)</span>  <span class="comment"># 添加&#x27;A&#x27;后缀匹配表达数据</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：临床生存数据通常需要与分子数据进行样本匹配。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>%&gt;%</code>: 管道操作符，将左侧结果传递给右侧函数</li>
<li><code>rownames_to_column()</code>: 将行名转为数据框的一列</li>
<li><code>paste0()</code>: 字符串连接函数</li>
</ul>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 合并生存信息与表达谱</span></span><br><span class="line">tpms01A_log2 <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                           check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">a <span class="operator">&lt;-</span> intersect<span class="punctuation">(</span>colnames<span class="punctuation">(</span>tpms01A_log2<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>survival<span class="punctuation">)</span><span class="punctuation">)</span>  <span class="comment"># 找共同样本</span></span><br><span class="line">exp_01A <span class="operator">&lt;-</span> tpms01A_log2<span class="punctuation">[</span><span class="punctuation">,</span>a<span class="punctuation">]</span>  <span class="comment"># 提取共同样本的表达数据</span></span><br><span class="line">surv_01A <span class="operator">&lt;-</span> survival<span class="punctuation">[</span>a<span class="punctuation">,</span><span class="punctuation">]</span>     <span class="comment"># 提取共同样本的生存数据</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：确保表达数据和生存数据的样本完全对应，避免样本不匹配问题。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>intersect()</code>: 取两个向量的交集</li>
<li><code>[a]</code>: 按向量a中的元素进行子集选择</li>
</ul>
<hr />
<h2 id="第三部分生存分析"><a class="markdownIt-Anchor" href="#第三部分生存分析"></a> 第三部分：生存分析</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### 根据ESTIMATE_result高低组做生存分析 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../survival&quot;</span><span class="punctuation">)</span></span><br><span class="line">surv <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;ESTIMATE_result_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                   check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">surv<span class="operator">$</span>OS.time <span class="operator">&lt;-</span> surv<span class="operator">$</span>OS.time <span class="operator">/</span> <span class="number">365</span>  <span class="comment"># 将天数转换为年</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：将生存时间从天数转换为年，便于理解和可视化。</p>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建生存分析函数避免重复代码</span></span><br><span class="line">perform_survival_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">,</span> score_type<span class="punctuation">,</span> title<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 根据中位数分组</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&gt;</span> median<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Low&quot;</span><span class="punctuation">)</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>data<span class="operator">$</span>group<span class="punctuation">,</span> levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 生存差异检验</span></span><br><span class="line">  fitd <span class="operator">&lt;-</span> survdiff<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> data<span class="punctuation">,</span> na.action <span class="operator">=</span> na.exclude<span class="punctuation">)</span></span><br><span class="line">  pValue <span class="operator">&lt;-</span> 1 <span class="operator">-</span> pchisq<span class="punctuation">(</span>fitd<span class="operator">$</span>chisq<span class="punctuation">,</span> <span class="built_in">length</span><span class="punctuation">(</span>fitd<span class="operator">$</span>n<span class="punctuation">)</span> <span class="operator">-</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 拟合生存曲线</span></span><br><span class="line">  fit <span class="operator">&lt;-</span> survfit<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> data<span class="punctuation">)</span></span><br><span class="line">  p.lab <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;P&quot;</span><span class="punctuation">,</span> ifelse<span class="punctuation">(</span>pValue <span class="operator">&lt;</span> <span class="number">0.001</span><span class="punctuation">,</span> <span class="string">&quot; &lt; 0.001&quot;</span><span class="punctuation">,</span> paste0<span class="punctuation">(</span><span class="string">&quot; = &quot;</span><span class="punctuation">,</span> <span class="built_in">round</span><span class="punctuation">(</span>pValue<span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制生存曲线</span></span><br><span class="line">  ggsurvplot<span class="punctuation">(</span>fit<span class="punctuation">,</span></span><br><span class="line">             data <span class="operator">=</span> data<span class="punctuation">,</span></span><br><span class="line">             pval <span class="operator">=</span> p.lab<span class="punctuation">,</span></span><br><span class="line">             conf.int <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span>  <span class="comment"># 显示置信区间</span></span><br><span class="line">             risk.table <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span>  <span class="comment"># 显示风险表</span></span><br><span class="line">             palette <span class="operator">=</span> <span class="string">&quot;jco&quot;</span><span class="punctuation">,</span>  <span class="comment"># JCO杂志配色</span></span><br><span class="line">             legend.title <span class="operator">=</span> title<span class="punctuation">,</span></span><br><span class="line">             surv.median.line <span class="operator">=</span> <span class="string">&quot;hv&quot;</span><span class="punctuation">,</span>  <span class="comment"># 显示中位生存期</span></span><br><span class="line">             ylab <span class="operator">=</span> <span class="string">&quot;Survival probability (%)&quot;</span><span class="punctuation">,</span></span><br><span class="line">             xlab <span class="operator">=</span> <span class="string">&quot;Time (Years)&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：封装生存分析流程，便于对多个评分重复分析。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>function()</code>: 定义函数</li>
<li><code>data[[score_type]]</code>: 动态选择数据框的列</li>
<li><code>Surv()</code>: 创建生存对象</li>
<li><code>survdiff()</code>: 生存差异检验（log-rank test）</li>
<li><code>survfit()</code>: 拟合生存曲线</li>
</ul>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 对三个评分进行生存分析</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">)</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">)</span> </span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：分别分析免疫评分、基质评分和总评分对患者生存的影响。</p>
<p><strong>整体研究意义</strong>：通过这种分析可以评估肿瘤微环境特征（免疫细胞浸润、基质成分等）对肺癌患者预后的影响，为免疫治疗提供理论依据。</p>
<h2 id="完整代码"><a class="markdownIt-Anchor" href="#完整代码"></a> 完整代码</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### ESTIMATE ####</span></span><br><span class="line"><span class="comment"># 计算患者免疫评分与肿瘤纯度</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/ESTIMATE&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次性加载所有需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>utils<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>estimate<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>survival<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>survminer<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取肿瘤患者01A表达谱</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                  check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算免疫评分</span></span><br><span class="line">filterCommonGenes<span class="punctuation">(</span>input.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  output.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  id <span class="operator">=</span> <span class="string">&quot;GeneSymbol&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">estimateScore<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">              platform <span class="operator">=</span> <span class="string">&quot;affymetrix&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取结果并整理</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span></span><br><span class="line">colnames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>t<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">[</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> colnames<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">            row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 生存信息整理 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../Survival_data&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载生存信息</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival <span class="operator">%&gt;%</span> rownames_to_column<span class="punctuation">(</span><span class="string">&#x27;sample&#x27;</span><span class="punctuation">)</span></span><br><span class="line">survival<span class="operator">$</span>name <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span>survival<span class="operator">$</span>sample<span class="punctuation">,</span> <span class="string">&#x27;A&#x27;</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>substring<span class="punctuation">(</span>survival<span class="operator">$</span>name<span class="punctuation">,</span> <span class="number">14</span><span class="punctuation">,</span> <span class="number">16</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>survival<span class="punctuation">)</span> <span class="operator">&lt;-</span> survival<span class="operator">$</span>name</span><br><span class="line">survival <span class="operator">&lt;-</span> survival<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并生存信息与表达谱</span></span><br><span class="line">tpms01A_log2 <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                           check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">a <span class="operator">&lt;-</span> intersect<span class="punctuation">(</span>colnames<span class="punctuation">(</span>tpms01A_log2<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>survival<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>substr<span class="punctuation">(</span>a<span class="punctuation">,</span> <span class="number">14</span><span class="punctuation">,</span> <span class="number">16</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">exp_01A <span class="operator">&lt;-</span> tpms01A_log2<span class="punctuation">[</span><span class="punctuation">,</span>a<span class="punctuation">]</span></span><br><span class="line">surv_01A <span class="operator">&lt;-</span> survival<span class="punctuation">[</span>a<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">exp_01A <span class="operator">&lt;-</span> exp_01A <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>exp_01A<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>surv_01A<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">exp_surv_01A <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>surv_01A<span class="punctuation">,</span> exp_01A<span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>exp_surv_01A<span class="punctuation">,</span> <span class="string">&quot;exp_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span></span><br><span class="line">            col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并生存信息与ESTIMATE</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>surv_01A<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">ESTIMATE_result_surv_01A <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>surv_01A<span class="punctuation">,</span> ESTIMATE_result<span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>ESTIMATE_result_surv_01A<span class="punctuation">,</span> <span class="string">&quot;ESTIMATE_result_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">            row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 根据ESTIMATE_result高低组做生存分析 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../survival&quot;</span><span class="punctuation">)</span></span><br><span class="line">surv <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;ESTIMATE_result_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                   check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">surv<span class="operator">$</span>OS.time <span class="operator">&lt;-</span> surv<span class="operator">$</span>OS.time <span class="operator">/</span> <span class="number">365</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建生存分析函数避免重复代码</span></span><br><span class="line">perform_survival_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">,</span> score_type<span class="punctuation">,</span> title<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&gt;</span> median<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Low&quot;</span><span class="punctuation">)</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>data<span class="operator">$</span>group<span class="punctuation">,</span> levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  fitd <span class="operator">&lt;-</span> survdiff<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span></span><br><span class="line">                   data <span class="operator">=</span> data<span class="punctuation">,</span></span><br><span class="line">                   na.action <span class="operator">=</span> na.exclude<span class="punctuation">)</span></span><br><span class="line">  pValue <span class="operator">&lt;-</span> 1 <span class="operator">-</span> pchisq<span class="punctuation">(</span>fitd<span class="operator">$</span>chisq<span class="punctuation">,</span> <span class="built_in">length</span><span class="punctuation">(</span>fitd<span class="operator">$</span>n<span class="punctuation">)</span> <span class="operator">-</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  fit <span class="operator">&lt;-</span> survfit<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> data<span class="punctuation">)</span></span><br><span class="line">  p.lab <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;P&quot;</span><span class="punctuation">,</span> ifelse<span class="punctuation">(</span>pValue <span class="operator">&lt;</span> <span class="number">0.001</span><span class="punctuation">,</span> <span class="string">&quot; &lt; 0.001&quot;</span><span class="punctuation">,</span> paste0<span class="punctuation">(</span><span class="string">&quot; = &quot;</span><span class="punctuation">,</span> <span class="built_in">round</span><span class="punctuation">(</span>pValue<span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  ggsurvplot<span class="punctuation">(</span>fit<span class="punctuation">,</span></span><br><span class="line">             data <span class="operator">=</span> data<span class="punctuation">,</span></span><br><span class="line">             pval <span class="operator">=</span> p.lab<span class="punctuation">,</span></span><br><span class="line">             conf.int <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             risk.table <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             risk.table.col <span class="operator">=</span> <span class="string">&quot;strata&quot;</span><span class="punctuation">,</span></span><br><span class="line">             palette <span class="operator">=</span> <span class="string">&quot;jco&quot;</span><span class="punctuation">,</span></span><br><span class="line">             legend.labs <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">             size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">             xlim <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">20</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">             break.time.by <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">             legend.title <span class="operator">=</span> title<span class="punctuation">,</span></span><br><span class="line">             surv.median.line <span class="operator">=</span> <span class="string">&quot;hv&quot;</span><span class="punctuation">,</span></span><br><span class="line">             ylab <span class="operator">=</span> <span class="string">&quot;Survival probability (%)&quot;</span><span class="punctuation">,</span></span><br><span class="line">             xlab <span class="operator">=</span> <span class="string">&quot;Time (Years)&quot;</span><span class="punctuation">,</span></span><br><span class="line">             ncensor.plot <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             ncensor.plot.height <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span></span><br><span class="line">             risk.table.y.text <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对三个评分进行生存分析</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">)</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">)</span> </span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<h2 id="最后让我们高呼"><a class="markdownIt-Anchor" href="#最后让我们高呼"></a> 最后，让我们高呼：</h2>
<h1 id="r你乱搞-和的事迹将会被天下的使用者怀恨在心"><a class="markdownIt-Anchor" href="#r你乱搞-和的事迹将会被天下的使用者怀恨在心"></a> R，你乱搞&lt;-和=的事迹将会被天下的使用者怀恨在心！！！</h1>
<h1 id="r语言将会臭名昭著"><a class="markdownIt-Anchor" href="#r语言将会臭名昭著"></a> <s>R语言将会臭名昭著</s></h1>
]]></content>
      <categories>
        <category>生物信息学</category>
      </categories>
      <tags>
        <tag>生物信息学</tag>
        <tag>TCGA</tag>
        <tag>极速版</tag>
      </tags>
  </entry>
  <entry>
    <title>生信分析之二 ESTIMATE生存分析</title>
    <url>/2025/10/13/Homework1/</url>
    <content><![CDATA[<h2 id="第一部分estimate评分计算"><a class="markdownIt-Anchor" href="#第一部分estimate评分计算"></a> 第一部分：ESTIMATE评分计算</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### Day3 ####</span></span><br><span class="line"><span class="comment">#### ESTIMATE ####</span></span><br><span class="line"><span class="comment"># 计算患者免疫评分与肿瘤纯度</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/ESTIMATE&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次性加载所有需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>utils<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>estimate<span class="punctuation">)</span>    <span class="comment"># 用于计算ESTIMATE评分</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span>   <span class="comment"># 数据清洗和整理</span></span><br><span class="line">library<span class="punctuation">(</span>survival<span class="punctuation">)</span>    <span class="comment"># 生存分析</span></span><br><span class="line">library<span class="punctuation">(</span>survminer<span class="punctuation">)</span>   <span class="comment"># 生存分析可视化</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取肿瘤患者01A表达谱</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                  check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：这部分是肿瘤微环境分析，通过ESTIMATE算法计算肿瘤纯度、免疫细胞和基质细胞评分。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>setwd()</code>: 设置工作目录</li>
<li><code>read.table()</code>: 读取表格文件，参数<code>row.names=1</code>表示第一列作为行名</li>
<li><code>check.names=F</code>: 保持列名原样，不自动修改特殊字符</li>
</ul>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 计算免疫评分</span></span><br><span class="line">filterCommonGenes<span class="punctuation">(</span>input.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  output.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  id <span class="operator">=</span> <span class="string">&quot;GeneSymbol&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">estimateScore<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">              platform <span class="operator">=</span> <span class="string">&quot;affymetrix&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：ESTIMATE算法需要特定的基因集，第一步过滤共同基因，第二步计算评分。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li>这些都是<code>estimate</code>包的专用函数</li>
<li><code>platform=&quot;affymetrix&quot;</code>: 指定芯片平台类型</li>
</ul>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 提取结果并整理</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span>  <span class="comment"># 删除第一列</span></span><br><span class="line">colnames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span>  <span class="comment"># 第一行作为列名</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>t<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">[</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span>  <span class="comment"># 转置并删除第一行</span></span><br><span class="line">rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> colnames<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span>  <span class="comment"># 设置样本名为行名</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：整理ESTIMATE输出结果，使其成为标准的样本×评分的数据框。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>[,-1]</code>: 删除第一列</li>
<li><code>t()</code>: 矩阵转置</li>
<li><code>colnames()</code>, <code>rownames()</code>: 设置列名和行名</li>
</ul>
<hr />
<h2 id="第二部分生存数据整合"><a class="markdownIt-Anchor" href="#第二部分生存数据整合"></a> 第二部分：生存数据整合</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### 生存信息整理 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../Survival_data&quot;</span><span class="punctuation">)</span>  <span class="comment"># 切换到上级目录的Survival_data文件夹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理生存数据</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span>  <span class="comment"># 只保留第2-3列</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival <span class="operator">%&gt;%</span> rownames_to_column<span class="punctuation">(</span><span class="string">&#x27;sample&#x27;</span><span class="punctuation">)</span>  <span class="comment"># 行名转为列</span></span><br><span class="line">survival<span class="operator">$</span>name <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span>survival<span class="operator">$</span>sample<span class="punctuation">,</span> <span class="string">&#x27;A&#x27;</span><span class="punctuation">)</span>  <span class="comment"># 添加&#x27;A&#x27;后缀匹配表达数据</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：临床生存数据通常需要与分子数据进行样本匹配。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>%&gt;%</code>: 管道操作符，将左侧结果传递给右侧函数</li>
<li><code>rownames_to_column()</code>: 将行名转为数据框的一列</li>
<li><code>paste0()</code>: 字符串连接函数</li>
</ul>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 合并生存信息与表达谱</span></span><br><span class="line">tpms01A_log2 <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                           check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">a <span class="operator">&lt;-</span> intersect<span class="punctuation">(</span>colnames<span class="punctuation">(</span>tpms01A_log2<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>survival<span class="punctuation">)</span><span class="punctuation">)</span>  <span class="comment"># 找共同样本</span></span><br><span class="line">exp_01A <span class="operator">&lt;-</span> tpms01A_log2<span class="punctuation">[</span><span class="punctuation">,</span>a<span class="punctuation">]</span>  <span class="comment"># 提取共同样本的表达数据</span></span><br><span class="line">surv_01A <span class="operator">&lt;-</span> survival<span class="punctuation">[</span>a<span class="punctuation">,</span><span class="punctuation">]</span>     <span class="comment"># 提取共同样本的生存数据</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：确保表达数据和生存数据的样本完全对应，避免样本不匹配问题。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>intersect()</code>: 取两个向量的交集</li>
<li><code>[a]</code>: 按向量a中的元素进行子集选择</li>
</ul>
<hr />
<h2 id="第三部分生存分析"><a class="markdownIt-Anchor" href="#第三部分生存分析"></a> 第三部分：生存分析</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### 根据ESTIMATE_result高低组做生存分析 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../survival&quot;</span><span class="punctuation">)</span></span><br><span class="line">surv <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;ESTIMATE_result_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                   check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">surv<span class="operator">$</span>OS.time <span class="operator">&lt;-</span> surv<span class="operator">$</span>OS.time <span class="operator">/</span> <span class="number">365</span>  <span class="comment"># 将天数转换为年</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：将生存时间从天数转换为年，便于理解和可视化。</p>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建生存分析函数避免重复代码</span></span><br><span class="line">perform_survival_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">,</span> score_type<span class="punctuation">,</span> title<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 根据中位数分组</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&gt;</span> median<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Low&quot;</span><span class="punctuation">)</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>data<span class="operator">$</span>group<span class="punctuation">,</span> levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 生存差异检验</span></span><br><span class="line">  fitd <span class="operator">&lt;-</span> survdiff<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> data<span class="punctuation">,</span> na.action <span class="operator">=</span> na.exclude<span class="punctuation">)</span></span><br><span class="line">  pValue <span class="operator">&lt;-</span> 1 <span class="operator">-</span> pchisq<span class="punctuation">(</span>fitd<span class="operator">$</span>chisq<span class="punctuation">,</span> <span class="built_in">length</span><span class="punctuation">(</span>fitd<span class="operator">$</span>n<span class="punctuation">)</span> <span class="operator">-</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 拟合生存曲线</span></span><br><span class="line">  fit <span class="operator">&lt;-</span> survfit<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> data<span class="punctuation">)</span></span><br><span class="line">  p.lab <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;P&quot;</span><span class="punctuation">,</span> ifelse<span class="punctuation">(</span>pValue <span class="operator">&lt;</span> <span class="number">0.001</span><span class="punctuation">,</span> <span class="string">&quot; &lt; 0.001&quot;</span><span class="punctuation">,</span> paste0<span class="punctuation">(</span><span class="string">&quot; = &quot;</span><span class="punctuation">,</span> <span class="built_in">round</span><span class="punctuation">(</span>pValue<span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制生存曲线</span></span><br><span class="line">  ggsurvplot<span class="punctuation">(</span>fit<span class="punctuation">,</span></span><br><span class="line">             data <span class="operator">=</span> data<span class="punctuation">,</span></span><br><span class="line">             pval <span class="operator">=</span> p.lab<span class="punctuation">,</span></span><br><span class="line">             conf.int <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span>  <span class="comment"># 显示置信区间</span></span><br><span class="line">             risk.table <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span>  <span class="comment"># 显示风险表</span></span><br><span class="line">             palette <span class="operator">=</span> <span class="string">&quot;jco&quot;</span><span class="punctuation">,</span>  <span class="comment"># JCO杂志配色</span></span><br><span class="line">             legend.title <span class="operator">=</span> title<span class="punctuation">,</span></span><br><span class="line">             surv.median.line <span class="operator">=</span> <span class="string">&quot;hv&quot;</span><span class="punctuation">,</span>  <span class="comment"># 显示中位生存期</span></span><br><span class="line">             ylab <span class="operator">=</span> <span class="string">&quot;Survival probability (%)&quot;</span><span class="punctuation">,</span></span><br><span class="line">             xlab <span class="operator">=</span> <span class="string">&quot;Time (Years)&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：封装生存分析流程，便于对多个评分重复分析。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>function()</code>: 定义函数</li>
<li><code>data[[score_type]]</code>: 动态选择数据框的列</li>
<li><code>Surv()</code>: 创建生存对象</li>
<li><code>survdiff()</code>: 生存差异检验（log-rank test）</li>
<li><code>survfit()</code>: 拟合生存曲线</li>
</ul>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 对三个评分进行生存分析</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">)</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">)</span> </span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：分别分析免疫评分、基质评分和总评分对患者生存的影响。</p>
<p><strong>整体研究意义</strong>：通过这种分析可以评估肿瘤微环境特征（免疫细胞浸润、基质成分等）对肺癌患者预后的影响，为免疫治疗提供理论依据。</p>
<h2 id="完整代码"><a class="markdownIt-Anchor" href="#完整代码"></a> 完整代码</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### ESTIMATE ####</span></span><br><span class="line"><span class="comment"># 计算患者免疫评分与肿瘤纯度</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/ESTIMATE&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次性加载所有需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>utils<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>estimate<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>survival<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>survminer<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取肿瘤患者01A表达谱</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                  check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算免疫评分</span></span><br><span class="line">filterCommonGenes<span class="punctuation">(</span>input.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  output.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  id <span class="operator">=</span> <span class="string">&quot;GeneSymbol&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">estimateScore<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">              platform <span class="operator">=</span> <span class="string">&quot;affymetrix&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取结果并整理</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span></span><br><span class="line">colnames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>t<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">[</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> colnames<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">            row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 生存信息整理 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../Survival_data&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载生存信息</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival <span class="operator">%&gt;%</span> rownames_to_column<span class="punctuation">(</span><span class="string">&#x27;sample&#x27;</span><span class="punctuation">)</span></span><br><span class="line">survival<span class="operator">$</span>name <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span>survival<span class="operator">$</span>sample<span class="punctuation">,</span> <span class="string">&#x27;A&#x27;</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>substring<span class="punctuation">(</span>survival<span class="operator">$</span>name<span class="punctuation">,</span> <span class="number">14</span><span class="punctuation">,</span> <span class="number">16</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>survival<span class="punctuation">)</span> <span class="operator">&lt;-</span> survival<span class="operator">$</span>name</span><br><span class="line">survival <span class="operator">&lt;-</span> survival<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并生存信息与表达谱</span></span><br><span class="line">tpms01A_log2 <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                           check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">a <span class="operator">&lt;-</span> intersect<span class="punctuation">(</span>colnames<span class="punctuation">(</span>tpms01A_log2<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>survival<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>substr<span class="punctuation">(</span>a<span class="punctuation">,</span> <span class="number">14</span><span class="punctuation">,</span> <span class="number">16</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">exp_01A <span class="operator">&lt;-</span> tpms01A_log2<span class="punctuation">[</span><span class="punctuation">,</span>a<span class="punctuation">]</span></span><br><span class="line">surv_01A <span class="operator">&lt;-</span> survival<span class="punctuation">[</span>a<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">exp_01A <span class="operator">&lt;-</span> exp_01A <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>exp_01A<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>surv_01A<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">exp_surv_01A <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>surv_01A<span class="punctuation">,</span> exp_01A<span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>exp_surv_01A<span class="punctuation">,</span> <span class="string">&quot;exp_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span></span><br><span class="line">            col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并生存信息与ESTIMATE</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>surv_01A<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">ESTIMATE_result_surv_01A <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>surv_01A<span class="punctuation">,</span> ESTIMATE_result<span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>ESTIMATE_result_surv_01A<span class="punctuation">,</span> <span class="string">&quot;ESTIMATE_result_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">            row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 根据ESTIMATE_result高低组做生存分析 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../survival&quot;</span><span class="punctuation">)</span></span><br><span class="line">surv <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;ESTIMATE_result_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                   check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">surv<span class="operator">$</span>OS.time <span class="operator">&lt;-</span> surv<span class="operator">$</span>OS.time <span class="operator">/</span> <span class="number">365</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建生存分析函数避免重复代码</span></span><br><span class="line">perform_survival_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">,</span> score_type<span class="punctuation">,</span> title<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&gt;</span> median<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Low&quot;</span><span class="punctuation">)</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>data<span class="operator">$</span>group<span class="punctuation">,</span> levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  fitd <span class="operator">&lt;-</span> survdiff<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span></span><br><span class="line">                   data <span class="operator">=</span> data<span class="punctuation">,</span></span><br><span class="line">                   na.action <span class="operator">=</span> na.exclude<span class="punctuation">)</span></span><br><span class="line">  pValue <span class="operator">&lt;-</span> 1 <span class="operator">-</span> pchisq<span class="punctuation">(</span>fitd<span class="operator">$</span>chisq<span class="punctuation">,</span> <span class="built_in">length</span><span class="punctuation">(</span>fitd<span class="operator">$</span>n<span class="punctuation">)</span> <span class="operator">-</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  fit <span class="operator">&lt;-</span> survfit<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> data<span class="punctuation">)</span></span><br><span class="line">  p.lab <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;P&quot;</span><span class="punctuation">,</span> ifelse<span class="punctuation">(</span>pValue <span class="operator">&lt;</span> <span class="number">0.001</span><span class="punctuation">,</span> <span class="string">&quot; &lt; 0.001&quot;</span><span class="punctuation">,</span> paste0<span class="punctuation">(</span><span class="string">&quot; = &quot;</span><span class="punctuation">,</span> <span class="built_in">round</span><span class="punctuation">(</span>pValue<span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  ggsurvplot<span class="punctuation">(</span>fit<span class="punctuation">,</span></span><br><span class="line">             data <span class="operator">=</span> data<span class="punctuation">,</span></span><br><span class="line">             pval <span class="operator">=</span> p.lab<span class="punctuation">,</span></span><br><span class="line">             conf.int <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             risk.table <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             risk.table.col <span class="operator">=</span> <span class="string">&quot;strata&quot;</span><span class="punctuation">,</span></span><br><span class="line">             palette <span class="operator">=</span> <span class="string">&quot;jco&quot;</span><span class="punctuation">,</span></span><br><span class="line">             legend.labs <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">             size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">             xlim <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">20</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">             break.time.by <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">             legend.title <span class="operator">=</span> title<span class="punctuation">,</span></span><br><span class="line">             surv.median.line <span class="operator">=</span> <span class="string">&quot;hv&quot;</span><span class="punctuation">,</span></span><br><span class="line">             ylab <span class="operator">=</span> <span class="string">&quot;Survival probability (%)&quot;</span><span class="punctuation">,</span></span><br><span class="line">             xlab <span class="operator">=</span> <span class="string">&quot;Time (Years)&quot;</span><span class="punctuation">,</span></span><br><span class="line">             ncensor.plot <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             ncensor.plot.height <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span></span><br><span class="line">             risk.table.y.text <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对三个评分进行生存分析</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">)</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">)</span> </span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>生物信息学</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>生物信息学</tag>
      </tags>
  </entry>
  <entry>
    <title>生信速通之四 差异分析和富集分析</title>
    <url>/2025/10/13/Homework4/</url>
    <content><![CDATA[<h2 id="tcga差异分析和富集分析代码详解"><a class="markdownIt-Anchor" href="#tcga差异分析和富集分析代码详解"></a> TCGA差异分析和富集分析代码详解</h2>
<h3 id="第一部分免疫评分差异分析"><a class="markdownIt-Anchor" href="#第一部分免疫评分差异分析"></a> 第一部分：免疫评分差异分析</h3>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">####差异分析####</span></span><br><span class="line"><span class="comment">####免疫评分####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;Immune_DEG&quot;</span><span class="punctuation">)</span> </span><br><span class="line">library<span class="punctuation">(</span>BiocManager<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#BiocManager::install(&#x27;DESeq2&#x27;)</span></span><br><span class="line">library<span class="punctuation">(</span>DESeq2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#TCGA差异分析用counts来做 因为是把01A患者分组做差异分析所以读取01A</span></span><br><span class="line">counts_01A <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;counts01A.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#因为是用免疫评分分组所以读取ESTIMATE_result</span></span><br><span class="line">estimate <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#整理分组信息</span></span><br><span class="line">x <span class="operator">&lt;-</span> <span class="string">&quot;ImmuneScore&quot;</span></span><br><span class="line">med <span class="operator">&lt;-</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>median<span class="punctuation">(</span>estimate<span class="punctuation">[</span><span class="punctuation">,</span>x<span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">estimate <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>t<span class="punctuation">(</span>estimate<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>colnames<span class="punctuation">(</span>counts_01A<span class="punctuation">)</span><span class="punctuation">,</span>colnames<span class="punctuation">(</span>estimate<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">conditions<span class="operator">=</span>data.frame<span class="punctuation">(</span>sample<span class="operator">=</span>colnames<span class="punctuation">(</span>counts_01A<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                      group<span class="operator">=</span>factor<span class="punctuation">(</span>ifelse<span class="punctuation">(</span>estimate<span class="punctuation">[</span>x<span class="punctuation">,</span><span class="punctuation">]</span><span class="operator">&gt;</span>med<span class="punctuation">,</span><span class="string">&quot;high&quot;</span><span class="punctuation">,</span><span class="string">&quot;low&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;low&quot;</span><span class="punctuation">,</span><span class="string">&quot;high&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  column_to_rownames<span class="punctuation">(</span><span class="string">&quot;sample&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：根据免疫评分中位数将患者分为高免疫组和低免疫组，为差异表达分析准备分组信息。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>median()</code>: 计算中位数作为分组阈值</li>
<li><code>ifelse()</code>: 条件判断，根据评分高低分组</li>
<li><code>factor(levels = c(&quot;low&quot;,&quot;high&quot;))</code>: 设置因子水平，确保low组作为参照</li>
</ul>
<hr />
<h3 id="第二部分deseq2差异分析流程"><a class="markdownIt-Anchor" href="#第二部分deseq2差异分析流程"></a> 第二部分：DESeq2差异分析流程</h3>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#差异分析准备工作</span></span><br><span class="line">dds <span class="operator">&lt;-</span> DESeqDataSetFromMatrix<span class="punctuation">(</span></span><br><span class="line">  countData <span class="operator">=</span> counts_01A<span class="punctuation">,</span></span><br><span class="line">  colData <span class="operator">=</span> conditions<span class="punctuation">,</span></span><br><span class="line">  design <span class="operator">=</span> <span class="operator">~</span> group<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#开始差异分析</span></span><br><span class="line">dds <span class="operator">&lt;-</span> DESeq<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#这句很重要</span></span><br><span class="line">resultsNames<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#提取结果</span></span><br><span class="line">res <span class="operator">&lt;-</span> results<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>res<span class="punctuation">,</span>file<span class="operator">=</span><span class="string">&quot;DEG_ImmuneScore.Rda&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：使用DESeq2进行RNA-seq数据的差异表达分析，识别高免疫组vs低免疫组的差异表达基因。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>DESeqDataSetFromMatrix()</code>: 创建DESeq2数据对象</li>
<li><code>DESeq()</code>: 执行差异分析流程（标准化、离散度估计、统计检验）</li>
<li><code>resultsNames()</code>: 查看可提取的结果类型</li>
<li><code>results()</code>: 提取差异分析结果</li>
</ul>
<hr />
<h3 id="第三部分差异基因热图可视化"><a class="markdownIt-Anchor" href="#第三部分差异基因热图可视化"></a> 第三部分：差异基因热图可视化</h3>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">####热图绘制####</span></span><br><span class="line">DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>res<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#读取表达谱</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#添加上下调信息</span></span><br><span class="line">logFC_cutoff <span class="operator">&lt;-</span> 1</span><br><span class="line">type1 <span class="operator">=</span> <span class="punctuation">(</span>DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">)</span><span class="operator">&amp;</span><span class="punctuation">(</span>DEG<span class="operator">$</span>log2FoldChange <span class="operator">&lt;</span> <span class="operator">-</span>logFC_cutoff<span class="punctuation">)</span></span><br><span class="line">type2 <span class="operator">=</span> <span class="punctuation">(</span>DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">)</span><span class="operator">&amp;</span><span class="punctuation">(</span>DEG<span class="operator">$</span>log2FoldChange <span class="operator">&gt;</span> logFC_cutoff<span class="punctuation">)</span></span><br><span class="line">DEG<span class="operator">$</span>change <span class="operator">=</span> ifelse<span class="punctuation">(</span>type1<span class="punctuation">,</span><span class="string">&quot;DOWN&quot;</span><span class="punctuation">,</span>ifelse<span class="punctuation">(</span>type2<span class="punctuation">,</span><span class="string">&quot;UP&quot;</span><span class="punctuation">,</span><span class="string">&quot;NOT&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>DEG<span class="operator">$</span>change<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>pheatmap<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#提取差异基因表达谱</span></span><br><span class="line">a <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>DEG<span class="punctuation">,</span>change <span class="operator">==</span> <span class="string">&#x27;UP&#x27;</span><span class="punctuation">)</span></span><br><span class="line">b <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>DEG<span class="punctuation">,</span>change <span class="operator">==</span> <span class="string">&#x27;DOWN&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">c</span> <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span>a<span class="punctuation">,</span>b<span class="punctuation">)</span></span><br><span class="line">d <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">)</span></span><br><span class="line">exp_diff <span class="operator">&lt;-</span> <span class="built_in">exp</span><span class="punctuation">[</span>d<span class="punctuation">,</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：筛选显著差异基因（|logFC|&gt;1且padj&lt;0.05）并提取其表达数据用于热图展示。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>padj</code>: 校正后的p值，控制假阳性率</li>
<li><code>log2FoldChange</code>: 对数倍变化，表示表达量差异程度</li>
<li><code>filter()</code>: 按条件筛选数据行</li>
</ul>
<hr />
<h3 id="第四部分热图绘制和美化"><a class="markdownIt-Anchor" href="#第四部分热图绘制和美化"></a> 第四部分：热图绘制和美化</h3>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#设置分组信息</span></span><br><span class="line">annotation_col <span class="operator">&lt;-</span> conditions</span><br><span class="line"><span class="comment">#对exp_diff 列的顺序进行处理</span></span><br><span class="line">a <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>annotation_col<span class="punctuation">,</span>group <span class="operator">==</span> <span class="string">&#x27;high&#x27;</span><span class="punctuation">)</span></span><br><span class="line">b <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>annotation_col<span class="punctuation">,</span>group <span class="operator">==</span> <span class="string">&#x27;low&#x27;</span><span class="punctuation">)</span></span><br><span class="line">exp_diff_high <span class="operator">&lt;-</span> exp_diff<span class="punctuation">[</span><span class="punctuation">,</span>rownames<span class="punctuation">(</span>a<span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">exp_diff_low <span class="operator">&lt;-</span> exp_diff<span class="punctuation">[</span><span class="punctuation">,</span>rownames<span class="punctuation">(</span>b<span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">exp_diff <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>exp_diff_high<span class="punctuation">,</span>exp_diff_low<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#开始画图</span></span><br><span class="line">pheatmap<span class="punctuation">(</span>exp_diff<span class="punctuation">,</span></span><br><span class="line">         annotation_col<span class="operator">=</span>annotation_col<span class="punctuation">,</span></span><br><span class="line">         scale <span class="operator">=</span> <span class="string">&quot;row&quot;</span><span class="punctuation">,</span></span><br><span class="line">         show_rownames <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         show_colnames <span class="operator">=</span><span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         color <span class="operator">=</span> colorRampPalette<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;navy&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">(</span><span class="number">50</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         cluster_cols <span class="operator">=</span><span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         cluster_rows <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span></span><br><span class="line">         fontsize <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">         fontsize_row<span class="operator">=</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">         fontsize_col<span class="operator">=</span><span class="number">3</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：绘制分组热图，直观展示差异基因在不同免疫评分组中的表达模式。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>scale = &quot;row&quot;</code>: 按行标准化，便于观察基因表达模式</li>
<li><code>colorRampPalette()</code>: 创建颜色梯度</li>
<li><code>cluster_cols = F</code>: 不对列聚类，保持分组顺序</li>
</ul>
<hr />
<h3 id="第五部分重复流程分析基质评分"><a class="markdownIt-Anchor" href="#第五部分重复流程分析基质评分"></a> 第五部分：重复流程分析基质评分</h3>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">####基质评分####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;Stromal_DEG&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#...与免疫评分相同的分析流程...</span></span><br><span class="line">x <span class="operator">&lt;-</span> <span class="string">&quot;StromalScore&quot;</span></span><br><span class="line">med <span class="operator">&lt;-</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>median<span class="punctuation">(</span>estimate<span class="punctuation">[</span><span class="punctuation">,</span>x<span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#...其余代码相同...</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：重复差异分析流程，但基于基质评分分组，识别与肿瘤基质微环境相关的差异基因。</p>
<hr />
<h3 id="第六部分差异基因交集分析"><a class="markdownIt-Anchor" href="#第六部分差异基因交集分析"></a> 第六部分：差异基因交集分析</h3>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">####将两次差异分析的差异基因取交集####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;Immune_Stromal_DEG&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#打开DEG_ImmuneScore.rda</span></span><br><span class="line">DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>res<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#添加上下调信息</span></span><br><span class="line">logFC_cutoff <span class="operator">&lt;-</span> 1</span><br><span class="line">type1 <span class="operator">=</span> <span class="punctuation">(</span>DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">)</span><span class="operator">&amp;</span><span class="punctuation">(</span>DEG<span class="operator">$</span>log2FoldChange <span class="operator">&lt;</span> <span class="operator">-</span>logFC_cutoff<span class="punctuation">)</span></span><br><span class="line">type2 <span class="operator">=</span> <span class="punctuation">(</span>DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">)</span><span class="operator">&amp;</span><span class="punctuation">(</span>DEG<span class="operator">$</span>log2FoldChange <span class="operator">&gt;</span> logFC_cutoff<span class="punctuation">)</span></span><br><span class="line">DEG<span class="operator">$</span>change <span class="operator">=</span> ifelse<span class="punctuation">(</span>type1<span class="punctuation">,</span><span class="string">&quot;DOWN&quot;</span><span class="punctuation">,</span>ifelse<span class="punctuation">(</span>type2<span class="punctuation">,</span><span class="string">&quot;UP&quot;</span><span class="punctuation">,</span><span class="string">&quot;NOT&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>DEG<span class="operator">$</span>change<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#提取上下调基因</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">a <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>DEG<span class="punctuation">,</span>change <span class="operator">==</span> <span class="string">&#x27;UP&#x27;</span><span class="punctuation">)</span></span><br><span class="line">b <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>DEG<span class="punctuation">,</span>change <span class="operator">==</span> <span class="string">&#x27;DOWN&#x27;</span><span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>a<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;Immune_up.csv&quot;</span><span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>b<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;Immune_down.csv&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：分别保存免疫评分和基质评分相关的差异基因，为后续交集分析做准备。</p>
<hr />
<h3 id="第七部分功能富集分析"><a class="markdownIt-Anchor" href="#第七部分功能富集分析"></a> 第七部分：功能富集分析</h3>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">####用交集差异基因做富集分析####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;FUJI_Immune_Stromal_DEG&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span><span class="string">&quot;BiocManager&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>org.Hs.eg.db<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>clusterProfiler<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#导入DEG_final.txt</span></span><br><span class="line"><span class="comment">#导入immune或stromal差异分析结果 均可</span></span><br><span class="line">DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>res<span class="punctuation">)</span></span><br><span class="line">DEG <span class="operator">&lt;-</span> DEG<span class="punctuation">[</span>DEG_final<span class="operator">$</span>SYMBOL<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">DEG <span class="operator">&lt;-</span> rownames_to_column<span class="punctuation">(</span>DEG<span class="punctuation">,</span><span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">)</span></span><br><span class="line">genelist <span class="operator">&lt;-</span> bitr<span class="punctuation">(</span>DEG<span class="operator">$</span>SYMBOL<span class="punctuation">,</span> fromType<span class="operator">=</span><span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                 toType<span class="operator">=</span><span class="string">&quot;ENTREZID&quot;</span><span class="punctuation">,</span> OrgDb<span class="operator">=</span><span class="string">&#x27;org.Hs.eg.db&#x27;</span><span class="punctuation">)</span></span><br><span class="line">DEG <span class="operator">&lt;-</span> inner_join<span class="punctuation">(</span>DEG<span class="punctuation">,</span>genelist<span class="punctuation">,</span>by<span class="operator">=</span><span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：将基因符号转换为ENTREZ ID，为GO和KEGG富集分析准备数据。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>bitr()</code>: 基因ID转换函数</li>
<li><code>inner_join()</code>: 内连接，保留两个数据框共有的行</li>
</ul>
<hr />
<h3 id="第八部分go和kegg富集分析"><a class="markdownIt-Anchor" href="#第八部分go和kegg富集分析"></a> 第八部分：GO和KEGG富集分析</h3>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">####GO####</span></span><br><span class="line">ego <span class="operator">&lt;-</span> enrichGO<span class="punctuation">(</span>gene <span class="operator">=</span> DEG<span class="operator">$</span>ENTREZID<span class="punctuation">,</span></span><br><span class="line">                OrgDb <span class="operator">=</span> org.Hs.eg.db<span class="punctuation">,</span> </span><br><span class="line">                ont <span class="operator">=</span> <span class="string">&quot;all&quot;</span><span class="punctuation">,</span></span><br><span class="line">                pAdjustMethod <span class="operator">=</span> <span class="string">&quot;BH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                minGSSize <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                pvalueCutoff <span class="operator">=</span><span class="number">0.05</span><span class="punctuation">,</span> </span><br><span class="line">                qvalueCutoff <span class="operator">=</span><span class="number">0.05</span><span class="punctuation">,</span></span><br><span class="line">                readable <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ego_res <span class="operator">&lt;-</span> ego<span class="operator">@</span>result</span><br><span class="line">save<span class="punctuation">(</span>ego<span class="punctuation">,</span>ego_res<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;GO_DEG_final.Rda&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">####KEGG####</span></span><br><span class="line">kk <span class="operator">&lt;-</span> enrichKEGG<span class="punctuation">(</span>gene         <span class="operator">=</span> DEG<span class="operator">$</span>ENTREZID<span class="punctuation">,</span></span><br><span class="line">                 organism     <span class="operator">=</span> <span class="string">&#x27;hsa&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                 pvalueCutoff <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span></span><br><span class="line">                 qvalueCutoff <span class="operator">=</span><span class="number">0.1</span><span class="punctuation">)</span></span><br><span class="line">kk_res <span class="operator">&lt;-</span> kk<span class="operator">@</span>result</span><br><span class="line">save<span class="punctuation">(</span>kk<span class="punctuation">,</span>kk_res<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;KEGG_DEG_final.Rda&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：识别差异基因显著富集的生物学过程和通路，揭示其潜在功能。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>enrichGO()</code>: GO富集分析，ont=&quot;all&quot;包含BP、CC、MF三个本体</li>
<li><code>enrichKEGG()</code>: KEGG通路富集分析</li>
<li><code>pAdjustMethod = &quot;BH&quot;</code>: Benjamini-Hochberg多重检验校正</li>
</ul>
<hr />
<h3 id="第九部分富集网络可视化"><a class="markdownIt-Anchor" href="#第九部分富集网络可视化"></a> 第九部分：富集网络可视化</h3>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#网络图</span></span><br><span class="line">library<span class="punctuation">(</span>ggnewscale<span class="punctuation">)</span></span><br><span class="line">List <span class="operator">=</span> DEG<span class="operator">$</span>log2FoldChange</span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>List<span class="punctuation">)</span><span class="operator">=</span> DEG<span class="operator">$</span>ENTREZID</span><br><span class="line">head<span class="punctuation">(</span>List<span class="punctuation">)</span></span><br><span class="line">List <span class="operator">=</span> sort<span class="punctuation">(</span>List<span class="punctuation">,</span>decreasing <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#GO</span></span><br><span class="line">cnetplot<span class="punctuation">(</span>ego<span class="punctuation">,</span> foldChange <span class="operator">=</span> List<span class="punctuation">,</span> circular <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> colorEdge <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#KEGG</span></span><br><span class="line">cnetplot<span class="punctuation">(</span>kk<span class="punctuation">,</span> foldChange <span class="operator">=</span> List<span class="punctuation">,</span> circular <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> colorEdge <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：绘制基因-功能网络图，展示差异基因与富集功能项之间的关系。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>cnetplot()</code>: 基因-概念网络图</li>
<li><code>foldChange</code>: 添加基因表达变化信息</li>
<li><code>circular = TRUE</code>: 圆形布局，更美观</li>
</ul>
<hr />
<h2 id="完整代码"><a class="markdownIt-Anchor" href="#完整代码"></a> 完整代码</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### Day5 ####</span></span><br><span class="line"><span class="comment">#### 差异分析和富集分析 ####</span></span><br><span class="line">library<span class="punctuation">(</span>BiocManager<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>DESeq2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>pheatmap<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>clusterProfiler<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>org.Hs.eg.db<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggnewscale<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置差异分析函数</span></span><br><span class="line">perform_DEG_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>score_type<span class="punctuation">,</span> output_dir<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">  setwd<span class="punctuation">(</span>output_dir<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 读取数据</span></span><br><span class="line">  counts_01A <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;counts01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                           check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">  estimate <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                         check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 整理分组信息</span></span><br><span class="line">  med <span class="operator">&lt;-</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>median<span class="punctuation">(</span>estimate<span class="punctuation">[</span><span class="punctuation">,</span> score_type<span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  estimate_t <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>t<span class="punctuation">(</span>estimate<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span>identical<span class="punctuation">(</span>colnames<span class="punctuation">(</span>counts_01A<span class="punctuation">)</span><span class="punctuation">,</span> colnames<span class="punctuation">(</span>estimate_t<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    stop<span class="punctuation">(</span><span class="string">&quot;表达数据和评分数据样本不匹配！&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  conditions <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span></span><br><span class="line">    sample <span class="operator">=</span> colnames<span class="punctuation">(</span>counts_01A<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    group <span class="operator">=</span> factor<span class="punctuation">(</span>ifelse<span class="punctuation">(</span>estimate_t<span class="punctuation">[</span>score_type<span class="punctuation">,</span> <span class="punctuation">]</span> <span class="operator">&gt;</span> med<span class="punctuation">,</span> <span class="string">&quot;high&quot;</span><span class="punctuation">,</span> <span class="string">&quot;low&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                   levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;high&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">%&gt;%</span> column_to_rownames<span class="punctuation">(</span><span class="string">&quot;sample&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># DESeq2差异分析</span></span><br><span class="line">  dds <span class="operator">&lt;-</span> DESeqDataSetFromMatrix<span class="punctuation">(</span></span><br><span class="line">    countData <span class="operator">=</span> counts_01A<span class="punctuation">,</span></span><br><span class="line">    colData <span class="operator">=</span> conditions<span class="punctuation">,</span></span><br><span class="line">    design <span class="operator">=</span> <span class="operator">~</span> group</span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  dds <span class="operator">&lt;-</span> DESeq<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line">  res <span class="operator">&lt;-</span> results<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line">  save<span class="punctuation">(</span>res<span class="punctuation">,</span> file <span class="operator">=</span> paste0<span class="punctuation">(</span><span class="string">&quot;DEG_&quot;</span><span class="punctuation">,</span> score_type<span class="punctuation">,</span> <span class="string">&quot;.Rda&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span><span class="built_in">list</span><span class="punctuation">(</span>res <span class="operator">=</span> res<span class="punctuation">,</span> conditions <span class="operator">=</span> conditions<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 热图绘制函数</span></span><br><span class="line">plot_heatmap <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>DEG_result<span class="punctuation">,</span> conditions<span class="punctuation">,</span> score_type<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>DEG_result<span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                   check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 筛选差异基因</span></span><br><span class="line">  logFC_cutoff <span class="operator">&lt;-</span> 1</span><br><span class="line">  DEG<span class="operator">$</span>change <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span></span><br><span class="line">    DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span> <span class="operator">&amp;</span> DEG<span class="operator">$</span>log2FoldChange <span class="operator">&lt;</span> <span class="operator">-</span>logFC_cutoff<span class="punctuation">,</span> <span class="string">&quot;DOWN&quot;</span><span class="punctuation">,</span></span><br><span class="line">    ifelse<span class="punctuation">(</span>DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span> <span class="operator">&amp;</span> DEG<span class="operator">$</span>log2FoldChange <span class="operator">&gt;</span> logFC_cutoff<span class="punctuation">,</span> <span class="string">&quot;UP&quot;</span><span class="punctuation">,</span> <span class="string">&quot;NOT&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  cat<span class="punctuation">(</span>score_type<span class="punctuation">,</span> <span class="string">&quot;差异基因统计:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">  print<span class="punctuation">(</span>table<span class="punctuation">(</span>DEG<span class="operator">$</span>change<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 提取差异基因表达谱</span></span><br><span class="line">  diff_genes <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>DEG<span class="punctuation">,</span> change <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;UP&quot;</span><span class="punctuation">,</span> <span class="string">&quot;DOWN&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  exp_diff <span class="operator">&lt;-</span> <span class="built_in">exp</span><span class="punctuation">[</span>rownames<span class="punctuation">(</span>diff_genes<span class="punctuation">)</span><span class="punctuation">,</span> <span class="punctuation">]</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 按分组排序</span></span><br><span class="line">  high_samples <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>filter<span class="punctuation">(</span>conditions<span class="punctuation">,</span> group <span class="operator">==</span> <span class="string">&#x27;high&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  low_samples <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>filter<span class="punctuation">(</span>conditions<span class="punctuation">,</span> group <span class="operator">==</span> <span class="string">&#x27;low&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  exp_diff_ordered <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>exp_diff<span class="punctuation">[</span><span class="punctuation">,</span> high_samples<span class="punctuation">]</span><span class="punctuation">,</span> exp_diff<span class="punctuation">[</span><span class="punctuation">,</span> low_samples<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制热图</span></span><br><span class="line">  pheatmap<span class="punctuation">(</span>exp_diff_ordered<span class="punctuation">,</span></span><br><span class="line">           annotation_col <span class="operator">=</span> conditions<span class="punctuation">,</span></span><br><span class="line">           scale <span class="operator">=</span> <span class="string">&quot;row&quot;</span><span class="punctuation">,</span></span><br><span class="line">           show_rownames <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           show_colnames <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           color <span class="operator">=</span> colorRampPalette<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;navy&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">(</span><span class="number">50</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           cluster_cols <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           cluster_rows <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">           fontsize <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">           main <span class="operator">=</span> paste<span class="punctuation">(</span>score_type<span class="punctuation">,</span> <span class="string">&quot;DEG Heatmap&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行免疫评分和基质评分差异分析</span></span><br><span class="line">immune_result <span class="operator">&lt;-</span> perform_DEG_analysis<span class="punctuation">(</span><span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Immune_DEG&quot;</span><span class="punctuation">)</span></span><br><span class="line">stromal_result <span class="operator">&lt;-</span> perform_DEG_analysis<span class="punctuation">(</span><span class="string">&quot;StromalScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Stromal_DEG&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制热图</span></span><br><span class="line">plot_heatmap<span class="punctuation">(</span>immune_result<span class="operator">$</span>res<span class="punctuation">,</span> immune_result<span class="operator">$</span>conditions<span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">)</span></span><br><span class="line">plot_heatmap<span class="punctuation">(</span>stromal_result<span class="operator">$</span>res<span class="punctuation">,</span> stromal_result<span class="operator">$</span>conditions<span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存差异基因结果</span></span><br><span class="line">save_DEG_results <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>DEG_result<span class="punctuation">,</span> prefix<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>DEG_result<span class="punctuation">)</span></span><br><span class="line">  logFC_cutoff <span class="operator">&lt;-</span> 1</span><br><span class="line">  DEG<span class="operator">$</span>change <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span></span><br><span class="line">    DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span> <span class="operator">&amp;</span> DEG<span class="operator">$</span>log2FoldChange <span class="operator">&lt;</span> <span class="operator">-</span>logFC_cutoff<span class="punctuation">,</span> <span class="string">&quot;DOWN&quot;</span><span class="punctuation">,</span></span><br><span class="line">    ifelse<span class="punctuation">(</span>DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span> <span class="operator">&amp;</span> DEG<span class="operator">$</span>log2FoldChange <span class="operator">&gt;</span> logFC_cutoff<span class="punctuation">,</span> <span class="string">&quot;UP&quot;</span><span class="punctuation">,</span> <span class="string">&quot;NOT&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  up_genes <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>DEG<span class="punctuation">,</span> change <span class="operator">==</span> <span class="string">&#x27;UP&#x27;</span><span class="punctuation">)</span></span><br><span class="line">  down_genes <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>DEG<span class="punctuation">,</span> change <span class="operator">==</span> <span class="string">&#x27;DOWN&#x27;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  write.csv<span class="punctuation">(</span>up_genes<span class="punctuation">,</span> file <span class="operator">=</span> paste0<span class="punctuation">(</span>prefix<span class="punctuation">,</span> <span class="string">&quot;_up.csv&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  write.csv<span class="punctuation">(</span>down_genes<span class="punctuation">,</span> file <span class="operator">=</span> paste0<span class="punctuation">(</span>prefix<span class="punctuation">,</span> <span class="string">&quot;_down.csv&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/Immune_Stromal_DEG&quot;</span><span class="punctuation">)</span></span><br><span class="line">save_DEG_results<span class="punctuation">(</span>immune_result<span class="operator">$</span>res<span class="punctuation">,</span> <span class="string">&quot;Immune&quot;</span><span class="punctuation">)</span></span><br><span class="line">save_DEG_results<span class="punctuation">(</span>stromal_result<span class="operator">$</span>res<span class="punctuation">,</span> <span class="string">&quot;Stromal&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 富集分析函数</span></span><br><span class="line">perform_enrichment_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>DEG_result<span class="punctuation">,</span> gene_symbols<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>DEG_result<span class="punctuation">)</span></span><br><span class="line">  DEG <span class="operator">&lt;-</span> DEG<span class="punctuation">[</span>gene_symbols<span class="punctuation">,</span> <span class="punctuation">]</span></span><br><span class="line">  DEG <span class="operator">&lt;-</span> rownames_to_column<span class="punctuation">(</span>DEG<span class="punctuation">,</span> <span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ID转换</span></span><br><span class="line">  genelist <span class="operator">&lt;-</span> bitr<span class="punctuation">(</span>DEG<span class="operator">$</span>SYMBOL<span class="punctuation">,</span> fromType <span class="operator">=</span> <span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   toType <span class="operator">=</span> <span class="string">&quot;ENTREZID&quot;</span><span class="punctuation">,</span> OrgDb <span class="operator">=</span> <span class="string">&#x27;org.Hs.eg.db&#x27;</span><span class="punctuation">)</span></span><br><span class="line">  DEG <span class="operator">&lt;-</span> inner_join<span class="punctuation">(</span>DEG<span class="punctuation">,</span> genelist<span class="punctuation">,</span> by <span class="operator">=</span> <span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># GO富集分析</span></span><br><span class="line">  ego <span class="operator">&lt;-</span> enrichGO<span class="punctuation">(</span>gene <span class="operator">=</span> DEG<span class="operator">$</span>ENTREZID<span class="punctuation">,</span></span><br><span class="line">                  OrgDb <span class="operator">=</span> org.Hs.eg.db<span class="punctuation">,</span></span><br><span class="line">                  ont <span class="operator">=</span> <span class="string">&quot;all&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  pAdjustMethod <span class="operator">=</span> <span class="string">&quot;BH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  pvalueCutoff <span class="operator">=</span> <span class="number">0.05</span><span class="punctuation">,</span></span><br><span class="line">                  qvalueCutoff <span class="operator">=</span> <span class="number">0.05</span><span class="punctuation">,</span></span><br><span class="line">                  readable <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># KEGG富集分析</span></span><br><span class="line">  kk <span class="operator">&lt;-</span> enrichKEGG<span class="punctuation">(</span>gene <span class="operator">=</span> DEG<span class="operator">$</span>ENTREZID<span class="punctuation">,</span></span><br><span class="line">                   organism <span class="operator">=</span> <span class="string">&#x27;hsa&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                   pvalueCutoff <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span></span><br><span class="line">                   qvalueCutoff <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span><span class="built_in">list</span><span class="punctuation">(</span>ego <span class="operator">=</span> ego<span class="punctuation">,</span> kk <span class="operator">=</span> kk<span class="punctuation">,</span> DEG <span class="operator">=</span> DEG<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行富集分析（需要先定义DEG_final）</span></span><br><span class="line"><span class="comment"># enrichment_results &lt;- perform_enrichment_analysis(res, DEG_final$SYMBOL)</span></span><br><span class="line"></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;差异分析和富集分析流程完成！\n&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>整体研究意义</strong>：这套流程系统分析了肿瘤微环境（免疫和基质成分）相关的分子特征，识别关键差异基因并揭示其生物学功能，为理解肿瘤微环境调控机制和发现潜在治疗靶点提供重要线索。</p>
]]></content>
      <categories>
        <category>生物信息学</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>生物信息学</tag>
      </tags>
  </entry>
  <entry>
    <title>生信速通之五 PPI和COX分析</title>
    <url>/2025/10/13/Homework5/</url>
    <content><![CDATA[<h1 id="tcga生存分析和ppi网络"><a class="markdownIt-Anchor" href="#tcga生存分析和ppi网络"></a> TCGA生存分析和PPI网络</h1>
<h2 id="第一部分ppi网络分析准备"><a class="markdownIt-Anchor" href="#第一部分ppi网络分析准备"></a> 第一部分：PPI网络分析准备</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">####PPI####</span></span><br><span class="line"><span class="comment">#String：https://cn.string-db.org/cgi/input?sessionId=bXmYsv7CnUrH&amp;input_page_active_form=multiple_identifiers</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：准备进行蛋白质-蛋白质相互作用网络分析，使用STRING数据库在线工具。</p>
<p><strong>研究意义</strong>：PPI分析有助于识别差异基因在蛋白质相互作用网络中的核心节点和功能模块，发现潜在的调控枢纽基因。</p>
<hr />
<h2 id="第二部分单变量cox回归分析"><a class="markdownIt-Anchor" href="#第二部分单变量cox回归分析"></a> 第二部分：单变量Cox回归分析</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">####COX####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;COX&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#安装加载R包</span></span><br><span class="line"><span class="comment">#install.packages(&quot;survival&quot;)</span></span><br><span class="line"><span class="comment">#install.packages(&quot;forestplot&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>survival<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>forestplot<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#读取文件</span></span><br><span class="line">exp_surv_01A <span class="operator">=</span> read.table<span class="punctuation">(</span><span class="string">&quot;exp_surv_01A.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#手动读取DEG_final.txt </span></span><br><span class="line"><span class="comment">#提取DEG_final</span></span><br><span class="line">surv.expr <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>exp_surv_01A<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">,</span>exp_surv_01A<span class="punctuation">[</span><span class="punctuation">,</span>DEG_final<span class="operator">$</span>SYMBOL<span class="punctuation">]</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：整合生存数据和差异基因表达数据，为Cox比例风险模型准备输入数据。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>cbind()</code>: 按列合并数据框，将生存时间/状态与基因表达数据合并</li>
<li><code>DEG_final$SYMBOL</code>: 假设DEG_final包含筛选出的差异基因符号</li>
</ul>
<hr />
<h2 id="第三部分批量单变量cox分析"><a class="markdownIt-Anchor" href="#第三部分批量单变量cox分析"></a> 第三部分：批量单变量Cox分析</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#Cox分析</span></span><br><span class="line">Coxoutput <span class="operator">&lt;-</span> <span class="literal">NULL</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span><span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">3</span><span class="operator">:</span>ncol<span class="punctuation">(</span>surv.expr<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  g <span class="operator">&lt;-</span> colnames<span class="punctuation">(</span>surv.expr<span class="punctuation">)</span><span class="punctuation">[</span>i<span class="punctuation">]</span></span><br><span class="line">  cox <span class="operator">&lt;-</span> coxph<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span>OS<span class="punctuation">)</span> <span class="operator">~</span> surv.expr<span class="punctuation">[</span><span class="punctuation">,</span>i<span class="punctuation">]</span><span class="punctuation">,</span> data <span class="operator">=</span> surv.expr<span class="punctuation">)</span> <span class="comment"># 单变量cox模型</span></span><br><span class="line">  coxSummary <span class="operator">=</span> summary<span class="punctuation">(</span>cox<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  Coxoutput <span class="operator">&lt;-</span> rbind.data.frame<span class="punctuation">(</span>Coxoutput<span class="punctuation">,</span></span><br><span class="line">                                data.frame<span class="punctuation">(</span>gene <span class="operator">=</span> g<span class="punctuation">,</span></span><br><span class="line">                                           HR <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>coefficients<span class="punctuation">[</span><span class="punctuation">,</span><span class="string">&quot;exp(coef)&quot;</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                           z <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>coefficients<span class="punctuation">[</span><span class="punctuation">,</span><span class="string">&quot;z&quot;</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                           pvalue <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>coefficients<span class="punctuation">[</span><span class="punctuation">,</span><span class="string">&quot;Pr(&gt;|z|)&quot;</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                           lower <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>conf.int<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                                           upper <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>conf.int<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                                           stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                                stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">Coxoutput <span class="operator">&lt;-</span> arrange<span class="punctuation">(</span>Coxoutput<span class="punctuation">,</span>pvalue<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：对每个差异基因进行单变量Cox回归分析，评估其对患者生存的影响。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>coxph(Surv(OS.time,OS) ~ surv.expr[,i])</code>: Cox比例风险模型</li>
<li><code>exp(coef)</code>: 风险比(HR)，HR&gt;1表示风险因素，HR&lt;1表示保护因素</li>
<li><code>conf.int</code>: 置信区间，评估HR估计的精确度</li>
<li><code>arrange(pvalue)</code>: 按p值升序排列，便于识别最显著的基因</li>
</ul>
<hr />
<h2 id="第四部分显著基因筛选"><a class="markdownIt-Anchor" href="#第四部分显著基因筛选"></a> 第四部分：显著基因筛选</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">###筛选top基因</span></span><br><span class="line">gene_sig <span class="operator">&lt;-</span> Coxoutput<span class="punctuation">[</span>Coxoutput<span class="operator">$</span>pvalue <span class="operator">&lt;</span> <span class="number">0.005</span><span class="punctuation">,</span><span class="punctuation">]</span> <span class="comment"># 取出p值小于0.05的基因</span></span><br><span class="line">write.csv<span class="punctuation">(</span>gene_sig<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;gene_sig.csv&quot;</span><span class="punctuation">)</span></span><br><span class="line">topgene <span class="operator">&lt;-</span> gene_sig <span class="comment">#为了下面不改topgene</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：筛选具有显著预后价值的基因（p &lt; 0.005），用于后续可视化。</p>
<p><strong>研究意义</strong>：识别与患者总生存期显著相关的基因，这些基因可能作为潜在的预后标志物。</p>
<hr />
<h2 id="第五部分森林图数据准备"><a class="markdownIt-Anchor" href="#第五部分森林图数据准备"></a> 第五部分：森林图数据准备</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#3. 绘制森林图</span></span><br><span class="line"><span class="comment">##3.1 输入表格的制作</span></span><br><span class="line">tabletext <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Gene&quot;</span><span class="punctuation">,</span>topgene<span class="operator">$</span>gene<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;HR&quot;</span><span class="punctuation">,</span>format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>topgene<span class="operator">$</span>HR<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span>nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;lower 95%CI&quot;</span><span class="punctuation">,</span>format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>topgene<span class="operator">$</span>lower<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span>nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;upper 95%CI&quot;</span><span class="punctuation">,</span>format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>topgene<span class="operator">$</span>upper<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span>nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;pvalue&quot;</span><span class="punctuation">,</span>format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>topgene<span class="operator">$</span>p<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span>nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：准备森林图所需的文本标签，包括基因名、HR值、置信区间和p值。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>cbind()</code>: 按列组合向量创建矩阵</li>
<li><code>format(round(), nsmall = 3)</code>: 统一数字格式，保留3位小数</li>
<li><code>tabletext</code>: 森林图左侧的文本表格</li>
</ul>
<hr />
<h3 id="第六部分森林图绘制"><a class="markdownIt-Anchor" href="#第六部分森林图绘制"></a> 第六部分：森林图绘制</h3>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">##3.2 绘制森林图</span></span><br><span class="line">forestplot<span class="punctuation">(</span>labeltext<span class="operator">=</span>tabletext<span class="punctuation">,</span></span><br><span class="line">           mean<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>topgene<span class="operator">$</span>HR<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           lower<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>topgene<span class="operator">$</span>lower<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">           upper<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>topgene<span class="operator">$</span>upper<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           graph.pos<span class="operator">=</span><span class="number">5</span><span class="punctuation">,</span><span class="comment"># 图在表中的列位置</span></span><br><span class="line">           graphwidth <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">.25</span><span class="punctuation">,</span><span class="string">&quot;npc&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="comment"># 图在表中的宽度比</span></span><br><span class="line">           fn.ci_norm<span class="operator">=</span><span class="string">&quot;fpDrawDiamondCI&quot;</span><span class="punctuation">,</span><span class="comment"># box类型选择钻石</span></span><br><span class="line">           col<span class="operator">=</span>fpColors<span class="punctuation">(</span>box<span class="operator">=</span><span class="string">&quot;#00A896&quot;</span><span class="punctuation">,</span> lines<span class="operator">=</span><span class="string">&quot;#02C39A&quot;</span><span class="punctuation">,</span> zero <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="comment"># box颜色</span></span><br><span class="line">           </span><br><span class="line">           boxsize<span class="operator">=</span><span class="number">0.4</span><span class="punctuation">,</span><span class="comment"># box大小固定</span></span><br><span class="line">           lwd.ci<span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">           ci.vertices.height <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span>ci.vertices<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">,</span><span class="comment"># 显示区间</span></span><br><span class="line">           zero<span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span><span class="comment"># zero线横坐标</span></span><br><span class="line">           lwd.zero<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">,</span><span class="comment"># zero线宽</span></span><br><span class="line">           xticks <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.5</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">1.5</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="comment"># 横坐标刻度根据需要可随意设置</span></span><br><span class="line">           lwd.xaxis<span class="operator">=</span><span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">           xlab<span class="operator">=</span><span class="string">&quot;Hazard ratios&quot;</span><span class="punctuation">,</span></span><br><span class="line">           txt_gp<span class="operator">=</span>fpTxtGp<span class="punctuation">(</span>label<span class="operator">=</span>gpar<span class="punctuation">(</span>cex<span class="operator">=</span><span class="number">1.2</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="comment"># 各种字体大小设置</span></span><br><span class="line">                          ticks<span class="operator">=</span>gpar<span class="punctuation">(</span>cex<span class="operator">=</span><span class="number">0.85</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                          xlab<span class="operator">=</span>gpar<span class="punctuation">(</span>cex<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                          title<span class="operator">=</span>gpar<span class="punctuation">(</span>cex<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           hrzl_lines<span class="operator">=</span><span class="built_in">list</span><span class="punctuation">(</span><span class="string">&quot;1&quot;</span> <span class="operator">=</span> gpar<span class="punctuation">(</span>lwd<span class="operator">=</span><span class="number">2</span><span class="punctuation">,</span> col<span class="operator">=</span><span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># 在第一行上面画黑色实线</span></span><br><span class="line">                           <span class="string">&quot;2&quot;</span> <span class="operator">=</span> gpar<span class="punctuation">(</span>lwd<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">,</span> col<span class="operator">=</span><span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># 在第一行标题行下画黑色实线</span></span><br><span class="line">                           <span class="string">&quot;53&quot;</span> <span class="operator">=</span> gpar<span class="punctuation">(</span>lwd<span class="operator">=</span><span class="number">2</span><span class="punctuation">,</span> col<span class="operator">=</span><span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># 在最后一行上画黑色实线</span></span><br><span class="line">           lineheight <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">.75</span><span class="punctuation">,</span><span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="comment"># 固定行高</span></span><br><span class="line">           colgap <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.3</span><span class="punctuation">,</span><span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           mar<span class="operator">=</span>unit<span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1.5</span><span class="punctuation">,</span> times <span class="operator">=</span> <span class="number">4</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           new_page <span class="operator">=</span> <span class="built_in">F</span></span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：绘制专业发表级的森林图，直观展示各基因的风险比及其置信区间。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>forestplot()</code>: 创建森林图的主要函数</li>
<li><code>graph.pos=5</code>: 森林图在第5列显示</li>
<li><code>fn.ci_norm=&quot;fpDrawDiamondCI&quot;</code>: 使用菱形表示点估计和置信区间</li>
<li><code>zero=1</code>: 参考线在HR=1的位置</li>
<li><code>hrzl_lines</code>: 添加水平分隔线增强可读性</li>
</ul>
<hr />
<h2 id="完整代码"><a class="markdownIt-Anchor" href="#完整代码"></a> 完整代码</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### Day6 ####</span></span><br><span class="line"><span class="comment">#### PPI和COX生存分析 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/COX&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载所需包</span></span><br><span class="line">library<span class="punctuation">(</span>survival<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>forestplot<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取整合的生存和表达数据</span></span><br><span class="line">exp_surv_01A <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;exp_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                          check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 单变量Cox回归分析函数</span></span><br><span class="line">perform_univariate_cox <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>surv_data<span class="punctuation">,</span> gene_symbols<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 提取生存数据和目标基因</span></span><br><span class="line">  surv.expr <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>surv_data<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">,</span> surv_data<span class="punctuation">[</span><span class="punctuation">,</span> gene_symbols<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  Coxoutput <span class="operator">&lt;-</span> <span class="literal">NULL</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span><span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">3</span><span class="operator">:</span>ncol<span class="punctuation">(</span>surv.expr<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    g <span class="operator">&lt;-</span> colnames<span class="punctuation">(</span>surv.expr<span class="punctuation">)</span><span class="punctuation">[</span>i<span class="punctuation">]</span></span><br><span class="line">    cox <span class="operator">&lt;-</span> coxph<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> surv.expr<span class="punctuation">[</span><span class="punctuation">,</span> i<span class="punctuation">]</span><span class="punctuation">,</span> data <span class="operator">=</span> surv.expr<span class="punctuation">)</span></span><br><span class="line">    coxSummary <span class="operator">&lt;-</span> summary<span class="punctuation">(</span>cox<span class="punctuation">)</span></span><br><span class="line">    </span><br><span class="line">    Coxoutput <span class="operator">&lt;-</span> rbind.data.frame<span class="punctuation">(</span></span><br><span class="line">      Coxoutput<span class="punctuation">,</span></span><br><span class="line">      data.frame<span class="punctuation">(</span></span><br><span class="line">        gene <span class="operator">=</span> g<span class="punctuation">,</span></span><br><span class="line">        HR <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>coefficients<span class="punctuation">[</span><span class="punctuation">,</span> <span class="string">&quot;exp(coef)&quot;</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        z <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>coefficients<span class="punctuation">[</span><span class="punctuation">,</span> <span class="string">&quot;z&quot;</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        pvalue <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>coefficients<span class="punctuation">[</span><span class="punctuation">,</span> <span class="string">&quot;Pr(&gt;|z|)&quot;</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        lower <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>conf.int<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        upper <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>conf.int<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span></span><br><span class="line">      <span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">      stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span></span><br><span class="line">    <span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  Coxoutput <span class="operator">&lt;-</span> arrange<span class="punctuation">(</span>Coxoutput<span class="punctuation">,</span> pvalue<span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>Coxoutput<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 森林图绘制函数</span></span><br><span class="line">create_forest_plot <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>coxx_results<span class="punctuation">,</span> p_threshold <span class="operator">=</span> <span class="number">0.005</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 筛选显著基因</span></span><br><span class="line">  gene_sig <span class="operator">&lt;-</span> coxx_results<span class="punctuation">[</span>coxx_results<span class="operator">$</span>pvalue <span class="operator">&lt;</span> p_threshold<span class="punctuation">,</span> <span class="punctuation">]</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span><span class="punctuation">(</span>nrow<span class="punctuation">(</span>gene_sig<span class="punctuation">)</span> <span class="operator">==</span> <span class="number">0</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    warning<span class="punctuation">(</span><span class="string">&quot;没有找到符合显著性阈值的基因&quot;</span><span class="punctuation">)</span></span><br><span class="line">    <span class="built_in">return</span><span class="punctuation">(</span><span class="literal">NULL</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 准备森林图数据</span></span><br><span class="line">  tabletext <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span></span><br><span class="line">    <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Gene&quot;</span><span class="punctuation">,</span> gene_sig<span class="operator">$</span>gene<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;HR&quot;</span><span class="punctuation">,</span> format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>gene_sig<span class="operator">$</span>HR<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span> nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;lower 95%CI&quot;</span><span class="punctuation">,</span> format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>gene_sig<span class="operator">$</span>lower<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span> nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;upper 95%CI&quot;</span><span class="punctuation">,</span> format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>gene_sig<span class="operator">$</span>upper<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span> nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;pvalue&quot;</span><span class="punctuation">,</span> format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>gene_sig<span class="operator">$</span>pvalue<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span> nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制森林图</span></span><br><span class="line">  forestplot<span class="punctuation">(</span></span><br><span class="line">    labeltext <span class="operator">=</span> tabletext<span class="punctuation">,</span></span><br><span class="line">    mean <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>gene_sig<span class="operator">$</span>HR<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    lower <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>gene_sig<span class="operator">$</span>lower<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    upper <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>gene_sig<span class="operator">$</span>upper<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    graph.pos <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    graphwidth <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.25</span><span class="punctuation">,</span> <span class="string">&quot;npc&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    fn.ci_norm <span class="operator">=</span> <span class="string">&quot;fpDrawDiamondCI&quot;</span><span class="punctuation">,</span></span><br><span class="line">    col <span class="operator">=</span> fpColors<span class="punctuation">(</span>box <span class="operator">=</span> <span class="string">&quot;#00A896&quot;</span><span class="punctuation">,</span> lines <span class="operator">=</span> <span class="string">&quot;#02C39A&quot;</span><span class="punctuation">,</span> zero <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    boxsize <span class="operator">=</span> <span class="number">0.4</span><span class="punctuation">,</span></span><br><span class="line">    lwd.ci <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    ci.vertices <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">    ci.vertices.height <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span></span><br><span class="line">    zero <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    lwd.zero <span class="operator">=</span> <span class="number">1.5</span><span class="punctuation">,</span></span><br><span class="line">    xticks <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.5</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">1.5</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    lwd.xaxis <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    xlab <span class="operator">=</span> <span class="string">&quot;Hazard ratios&quot;</span><span class="punctuation">,</span></span><br><span class="line">    txt_gp <span class="operator">=</span> fpTxtGp<span class="punctuation">(</span></span><br><span class="line">      label <span class="operator">=</span> gpar<span class="punctuation">(</span>cex <span class="operator">=</span> <span class="number">1.2</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">      ticks <span class="operator">=</span> gpar<span class="punctuation">(</span>cex <span class="operator">=</span> <span class="number">0.85</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">      xlab <span class="operator">=</span> gpar<span class="punctuation">(</span>cex <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">      title <span class="operator">=</span> gpar<span class="punctuation">(</span>cex <span class="operator">=</span> <span class="number">1.5</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    hrzl_lines <span class="operator">=</span> <span class="built_in">list</span><span class="punctuation">(</span></span><br><span class="line">      <span class="string">&quot;1&quot;</span> <span class="operator">=</span> gpar<span class="punctuation">(</span>lwd <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> col <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;2&quot;</span> <span class="operator">=</span> gpar<span class="punctuation">(</span>lwd <span class="operator">=</span> <span class="number">1.5</span><span class="punctuation">,</span> col <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">      paste0<span class="punctuation">(</span>nrow<span class="punctuation">(</span>gene_sig<span class="punctuation">)</span> <span class="operator">+</span> <span class="number">2</span><span class="punctuation">)</span> <span class="operator">=</span> gpar<span class="punctuation">(</span>lwd <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> col <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    lineheight <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.75</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    colgap <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.3</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    mar <span class="operator">=</span> unit<span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1.5</span><span class="punctuation">,</span> times <span class="operator">=</span> <span class="number">4</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    new_page <span class="operator">=</span> <span class="literal">FALSE</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>gene_sig<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行分析流程</span></span><br><span class="line"><span class="comment"># 假设DEG_final已加载</span></span><br><span class="line"><span class="keyword">if</span><span class="punctuation">(</span>exists<span class="punctuation">(</span><span class="string">&quot;DEG_final&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 单变量Cox分析</span></span><br><span class="line">  cox_results <span class="operator">&lt;-</span> perform_univariate_cox<span class="punctuation">(</span>exp_surv_01A<span class="punctuation">,</span> DEG_final<span class="operator">$</span>SYMBOL<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 保存显著基因</span></span><br><span class="line">  write.csv<span class="punctuation">(</span>cox_results<span class="punctuation">,</span> <span class="string">&quot;all_coxx_genes.csv&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制森林图</span></span><br><span class="line">  significant_genes <span class="operator">&lt;-</span> create_forest_plot<span class="punctuation">(</span>cox_results<span class="punctuation">,</span> p_threshold <span class="operator">=</span> <span class="number">0.005</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span><span class="built_in">is.null</span><span class="punctuation">(</span>significant_genes<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    write.csv<span class="punctuation">(</span>significant_genes<span class="punctuation">,</span> <span class="string">&quot;gene_sig.csv&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">    cat<span class="punctuation">(</span><span class="string">&quot;发现&quot;</span><span class="punctuation">,</span> nrow<span class="punctuation">(</span>significant_genes<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;个显著预后基因\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line"><span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="punctuation">&#123;</span></span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&quot;请先加载DEG_final数据\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;PPI和COX分析完成！\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;下一步：将显著基因列表上传至STRING数据库进行PPI网络分析\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;STRING网址: https://cn.string-db.org/\n&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>整体研究意义</strong>：这套流程通过单变量Cox回归识别具有独立预后价值的基因，并通过森林图直观展示结果。显著基因可进一步用于构建预后模型或作为PPI网络分析的输入，为理解肿瘤发生发展的分子机制和发现治疗靶点提供重要线索。</p>
]]></content>
      <categories>
        <category>生物信息学</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>生物信息学</tag>
      </tags>
  </entry>
  <entry>
    <title>生信分析之三 TCGA信息整理</title>
    <url>/2025/10/13/Homework3/</url>
    <content><![CDATA[<h2 id="完整代码"><a class="markdownIt-Anchor" href="#完整代码"></a> 完整代码</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### 整理TCGA临床信息 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/clinical&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;luad.gdc_2022.rda&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取临床信息</span></span><br><span class="line">clinical <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>expquery2<span class="operator">@</span>colData<span class="punctuation">)</span> <span class="operator">%&gt;%</span>   </span><br><span class="line">  .<span class="punctuation">[</span><span class="operator">!</span>duplicated<span class="punctuation">(</span>.<span class="operator">$</span>sample<span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取需要的临床信息数据</span></span><br><span class="line">clinical <span class="operator">&lt;-</span> clinical<span class="punctuation">[</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;gender&quot;</span><span class="punctuation">,</span> <span class="string">&quot;age_at_index&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_stage&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="string">&quot;ajcc_pathologic_t&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_n&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_m&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量检查变量类型和频数</span></span><br><span class="line">check_clinical_variables <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">,</span> vars<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="keyword">for</span><span class="punctuation">(</span>var <span class="keyword">in</span> vars<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    cat<span class="punctuation">(</span><span class="string">&quot;Variable:&quot;</span><span class="punctuation">,</span> var<span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">    cat<span class="punctuation">(</span><span class="string">&quot;Class:&quot;</span><span class="punctuation">,</span> <span class="built_in">class</span><span class="punctuation">(</span>data<span class="punctuation">[[</span>var<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">    cat<span class="punctuation">(</span><span class="string">&quot;Table:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">    print<span class="punctuation">(</span>table<span class="punctuation">(</span>data<span class="punctuation">[[</span>var<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> useNA <span class="operator">=</span> <span class="string">&quot;always&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">    cat<span class="punctuation">(</span><span class="string">&quot;\n&quot;</span> <span class="operator">+</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="string">&quot;-&quot;</span><span class="punctuation">,</span> <span class="number">50</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="string">&quot;\n\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查所有临床变量</span></span><br><span class="line">clinical_vars <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;gender&quot;</span><span class="punctuation">,</span> <span class="string">&quot;age_at_index&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_stage&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="string">&quot;ajcc_pathologic_t&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_n&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_m&quot;</span><span class="punctuation">)</span></span><br><span class="line">check_clinical_variables<span class="punctuation">(</span>clinical<span class="punctuation">,</span> clinical_vars<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量清理临床分期数据</span></span><br><span class="line">clean_clinical_data <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 移除分期中的A/B子分类</span></span><br><span class="line">  data<span class="operator">$</span>ajcc_pathologic_stage <span class="operator">&lt;-</span> gsub<span class="punctuation">(</span><span class="string">&quot;[AB]&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> data<span class="operator">$</span>ajcc_pathologic_stage<span class="punctuation">)</span></span><br><span class="line">  <span class="comment"># 移除T/N/M分期中的a/b子分类</span></span><br><span class="line">  data<span class="operator">$</span>ajcc_pathologic_t <span class="operator">&lt;-</span> gsub<span class="punctuation">(</span><span class="string">&quot;[ab]&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> data<span class="operator">$</span>ajcc_pathologic_t<span class="punctuation">)</span></span><br><span class="line">  data<span class="operator">$</span>ajcc_pathologic_n <span class="operator">&lt;-</span> gsub<span class="punctuation">(</span><span class="string">&quot;[ab]&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> data<span class="operator">$</span>ajcc_pathologic_n<span class="punctuation">)</span> </span><br><span class="line">  data<span class="operator">$</span>ajcc_pathologic_m <span class="operator">&lt;-</span> gsub<span class="punctuation">(</span><span class="string">&quot;[ab]&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> data<span class="operator">$</span>ajcc_pathologic_m<span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>data<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">clinical <span class="operator">&lt;-</span> clean_clinical_data<span class="punctuation">(</span>clinical<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取01A临床数据</span></span><br><span class="line">rownames<span class="punctuation">(</span>clinical<span class="punctuation">)</span> <span class="operator">&lt;-</span> substring<span class="punctuation">(</span>rownames<span class="punctuation">(</span>clinical<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">16</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 将基因表达谱和临床数据合并并保存</span></span><br><span class="line">exp01A <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                     check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">clinical01A <span class="operator">&lt;-</span> clinical<span class="punctuation">[</span>colnames<span class="punctuation">(</span>exp01A<span class="punctuation">)</span><span class="punctuation">,</span> <span class="punctuation">]</span>   </span><br><span class="line">exp01A <span class="operator">&lt;-</span> exp01A <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证样本匹配</span></span><br><span class="line"><span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span>identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>clinical01A<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>exp01A<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  warning<span class="punctuation">(</span><span class="string">&quot;临床数据和表达数据样本不匹配！&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="punctuation">&#123;</span></span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&quot;临床数据和表达数据样本完全匹配\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">clinical.expr01A <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>clinical01A<span class="punctuation">,</span> exp01A<span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>clinical.expr01A<span class="punctuation">,</span> <span class="string">&quot;clinical.expr01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 将ESTIMATE_result和临床数据合并并保存</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证样本匹配</span></span><br><span class="line"><span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span>identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>clinical01A<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  warning<span class="punctuation">(</span><span class="string">&quot;临床数据和ESTIMATE结果样本不匹配！&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="punctuation">&#123;</span></span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&quot;临床数据和ESTIMATE结果样本完全匹配\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">clinical.ESTIMATE_result01A <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>clinical01A<span class="punctuation">,</span> ESTIMATE_result<span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>clinical.ESTIMATE_result01A<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;clinical.ESTIMATE_result01A.csv&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;数据处理完成！\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;生成的文件：\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- clinical.expr01A.txt: 临床数据+表达谱\n&quot;</span><span class="punctuation">)</span> </span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- clinical.ESTIMATE_result01A.csv: 临床数据+ESTIMATE评分\n&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>生物信息学</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>生物信息学</tag>
      </tags>
  </entry>
  <entry>
    <title></title>
    <url>/2025/10/13/Homework6/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title></title>
    <url>/2025/10/13/homework7/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>生信分析之二 ESTIMATE生存分析</title>
    <url>/2025/10/13/homework2/</url>
    <content><![CDATA[<h2 id="第一部分estimate评分计算"><a class="markdownIt-Anchor" href="#第一部分estimate评分计算"></a> 第一部分：ESTIMATE评分计算</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### Day3 ####</span></span><br><span class="line"><span class="comment">#### ESTIMATE ####</span></span><br><span class="line"><span class="comment"># 计算患者免疫评分与肿瘤纯度</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/ESTIMATE&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次性加载所有需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>utils<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>estimate<span class="punctuation">)</span>    <span class="comment"># 用于计算ESTIMATE评分</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span>   <span class="comment"># 数据清洗和整理</span></span><br><span class="line">library<span class="punctuation">(</span>survival<span class="punctuation">)</span>    <span class="comment"># 生存分析</span></span><br><span class="line">library<span class="punctuation">(</span>survminer<span class="punctuation">)</span>   <span class="comment"># 生存分析可视化</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取肿瘤患者01A表达谱</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                  check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：这部分是肿瘤微环境分析，通过ESTIMATE算法计算肿瘤纯度、免疫细胞和基质细胞评分。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>setwd()</code>: 设置工作目录</li>
<li><code>read.table()</code>: 读取表格文件，参数<code>row.names=1</code>表示第一列作为行名</li>
<li><code>check.names=F</code>: 保持列名原样，不自动修改特殊字符</li>
</ul>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 计算免疫评分</span></span><br><span class="line">filterCommonGenes<span class="punctuation">(</span>input.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  output.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  id <span class="operator">=</span> <span class="string">&quot;GeneSymbol&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">estimateScore<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">              platform <span class="operator">=</span> <span class="string">&quot;affymetrix&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：ESTIMATE算法需要特定的基因集，第一步过滤共同基因，第二步计算评分。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li>这些都是<code>estimate</code>包的专用函数</li>
<li><code>platform=&quot;affymetrix&quot;</code>: 指定芯片平台类型</li>
</ul>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 提取结果并整理</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span>  <span class="comment"># 删除第一列</span></span><br><span class="line">colnames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span>  <span class="comment"># 第一行作为列名</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>t<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">[</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span>  <span class="comment"># 转置并删除第一行</span></span><br><span class="line">rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> colnames<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span>  <span class="comment"># 设置样本名为行名</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：整理ESTIMATE输出结果，使其成为标准的样本×评分的数据框。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>[,-1]</code>: 删除第一列</li>
<li><code>t()</code>: 矩阵转置</li>
<li><code>colnames()</code>, <code>rownames()</code>: 设置列名和行名</li>
</ul>
<hr />
<h2 id="第二部分生存数据整合"><a class="markdownIt-Anchor" href="#第二部分生存数据整合"></a> 第二部分：生存数据整合</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### 生存信息整理 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../Survival_data&quot;</span><span class="punctuation">)</span>  <span class="comment"># 切换到上级目录的Survival_data文件夹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理生存数据</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span>  <span class="comment"># 只保留第2-3列</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival <span class="operator">%&gt;%</span> rownames_to_column<span class="punctuation">(</span><span class="string">&#x27;sample&#x27;</span><span class="punctuation">)</span>  <span class="comment"># 行名转为列</span></span><br><span class="line">survival<span class="operator">$</span>name <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span>survival<span class="operator">$</span>sample<span class="punctuation">,</span> <span class="string">&#x27;A&#x27;</span><span class="punctuation">)</span>  <span class="comment"># 添加&#x27;A&#x27;后缀匹配表达数据</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：临床生存数据通常需要与分子数据进行样本匹配。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>%&gt;%</code>: 管道操作符，将左侧结果传递给右侧函数</li>
<li><code>rownames_to_column()</code>: 将行名转为数据框的一列</li>
<li><code>paste0()</code>: 字符串连接函数</li>
</ul>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 合并生存信息与表达谱</span></span><br><span class="line">tpms01A_log2 <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                           check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">a <span class="operator">&lt;-</span> intersect<span class="punctuation">(</span>colnames<span class="punctuation">(</span>tpms01A_log2<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>survival<span class="punctuation">)</span><span class="punctuation">)</span>  <span class="comment"># 找共同样本</span></span><br><span class="line">exp_01A <span class="operator">&lt;-</span> tpms01A_log2<span class="punctuation">[</span><span class="punctuation">,</span>a<span class="punctuation">]</span>  <span class="comment"># 提取共同样本的表达数据</span></span><br><span class="line">surv_01A <span class="operator">&lt;-</span> survival<span class="punctuation">[</span>a<span class="punctuation">,</span><span class="punctuation">]</span>     <span class="comment"># 提取共同样本的生存数据</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：确保表达数据和生存数据的样本完全对应，避免样本不匹配问题。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>intersect()</code>: 取两个向量的交集</li>
<li><code>[a]</code>: 按向量a中的元素进行子集选择</li>
</ul>
<hr />
<h2 id="第三部分生存分析"><a class="markdownIt-Anchor" href="#第三部分生存分析"></a> 第三部分：生存分析</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### 根据ESTIMATE_result高低组做生存分析 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../survival&quot;</span><span class="punctuation">)</span></span><br><span class="line">surv <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;ESTIMATE_result_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                   check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">surv<span class="operator">$</span>OS.time <span class="operator">&lt;-</span> surv<span class="operator">$</span>OS.time <span class="operator">/</span> <span class="number">365</span>  <span class="comment"># 将天数转换为年</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：将生存时间从天数转换为年，便于理解和可视化。</p>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建生存分析函数避免重复代码</span></span><br><span class="line">perform_survival_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">,</span> score_type<span class="punctuation">,</span> title<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 根据中位数分组</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&gt;</span> median<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Low&quot;</span><span class="punctuation">)</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>data<span class="operator">$</span>group<span class="punctuation">,</span> levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 生存差异检验</span></span><br><span class="line">  fitd <span class="operator">&lt;-</span> survdiff<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> data<span class="punctuation">,</span> na.action <span class="operator">=</span> na.exclude<span class="punctuation">)</span></span><br><span class="line">  pValue <span class="operator">&lt;-</span> 1 <span class="operator">-</span> pchisq<span class="punctuation">(</span>fitd<span class="operator">$</span>chisq<span class="punctuation">,</span> <span class="built_in">length</span><span class="punctuation">(</span>fitd<span class="operator">$</span>n<span class="punctuation">)</span> <span class="operator">-</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 拟合生存曲线</span></span><br><span class="line">  fit <span class="operator">&lt;-</span> survfit<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> data<span class="punctuation">)</span></span><br><span class="line">  p.lab <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;P&quot;</span><span class="punctuation">,</span> ifelse<span class="punctuation">(</span>pValue <span class="operator">&lt;</span> <span class="number">0.001</span><span class="punctuation">,</span> <span class="string">&quot; &lt; 0.001&quot;</span><span class="punctuation">,</span> paste0<span class="punctuation">(</span><span class="string">&quot; = &quot;</span><span class="punctuation">,</span> <span class="built_in">round</span><span class="punctuation">(</span>pValue<span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制生存曲线</span></span><br><span class="line">  ggsurvplot<span class="punctuation">(</span>fit<span class="punctuation">,</span></span><br><span class="line">             data <span class="operator">=</span> data<span class="punctuation">,</span></span><br><span class="line">             pval <span class="operator">=</span> p.lab<span class="punctuation">,</span></span><br><span class="line">             conf.int <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span>  <span class="comment"># 显示置信区间</span></span><br><span class="line">             risk.table <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span>  <span class="comment"># 显示风险表</span></span><br><span class="line">             palette <span class="operator">=</span> <span class="string">&quot;jco&quot;</span><span class="punctuation">,</span>  <span class="comment"># JCO杂志配色</span></span><br><span class="line">             legend.title <span class="operator">=</span> title<span class="punctuation">,</span></span><br><span class="line">             surv.median.line <span class="operator">=</span> <span class="string">&quot;hv&quot;</span><span class="punctuation">,</span>  <span class="comment"># 显示中位生存期</span></span><br><span class="line">             ylab <span class="operator">=</span> <span class="string">&quot;Survival probability (%)&quot;</span><span class="punctuation">,</span></span><br><span class="line">             xlab <span class="operator">=</span> <span class="string">&quot;Time (Years)&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：封装生存分析流程，便于对多个评分重复分析。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>function()</code>: 定义函数</li>
<li><code>data[[score_type]]</code>: 动态选择数据框的列</li>
<li><code>Surv()</code>: 创建生存对象</li>
<li><code>survdiff()</code>: 生存差异检验（log-rank test）</li>
<li><code>survfit()</code>: 拟合生存曲线</li>
</ul>
<hr />
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 对三个评分进行生存分析</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">)</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">)</span> </span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：分别分析免疫评分、基质评分和总评分对患者生存的影响。</p>
<p><strong>整体研究意义</strong>：通过这种分析可以评估肿瘤微环境特征（免疫细胞浸润、基质成分等）对肺癌患者预后的影响，为免疫治疗提供理论依据。</p>
<h2 id="完整代码"><a class="markdownIt-Anchor" href="#完整代码"></a> 完整代码</h2>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment">#### ESTIMATE ####</span></span><br><span class="line"><span class="comment"># 计算患者免疫评分与肿瘤纯度</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/ESTIMATE&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次性加载所有需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>utils<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>estimate<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>survival<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>survminer<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取肿瘤患者01A表达谱</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                  check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算免疫评分</span></span><br><span class="line">filterCommonGenes<span class="punctuation">(</span>input.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  output.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  id <span class="operator">=</span> <span class="string">&quot;GeneSymbol&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">estimateScore<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">              platform <span class="operator">=</span> <span class="string">&quot;affymetrix&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取结果并整理</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span></span><br><span class="line">colnames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>t<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">[</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> colnames<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">            row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 生存信息整理 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../Survival_data&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载生存信息</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival <span class="operator">%&gt;%</span> rownames_to_column<span class="punctuation">(</span><span class="string">&#x27;sample&#x27;</span><span class="punctuation">)</span></span><br><span class="line">survival<span class="operator">$</span>name <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span>survival<span class="operator">$</span>sample<span class="punctuation">,</span> <span class="string">&#x27;A&#x27;</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>substring<span class="punctuation">(</span>survival<span class="operator">$</span>name<span class="punctuation">,</span> <span class="number">14</span><span class="punctuation">,</span> <span class="number">16</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>survival<span class="punctuation">)</span> <span class="operator">&lt;-</span> survival<span class="operator">$</span>name</span><br><span class="line">survival <span class="operator">&lt;-</span> survival<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并生存信息与表达谱</span></span><br><span class="line">tpms01A_log2 <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                           check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">a <span class="operator">&lt;-</span> intersect<span class="punctuation">(</span>colnames<span class="punctuation">(</span>tpms01A_log2<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>survival<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>substr<span class="punctuation">(</span>a<span class="punctuation">,</span> <span class="number">14</span><span class="punctuation">,</span> <span class="number">16</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">exp_01A <span class="operator">&lt;-</span> tpms01A_log2<span class="punctuation">[</span><span class="punctuation">,</span>a<span class="punctuation">]</span></span><br><span class="line">surv_01A <span class="operator">&lt;-</span> survival<span class="punctuation">[</span>a<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">exp_01A <span class="operator">&lt;-</span> exp_01A <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>exp_01A<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>surv_01A<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">exp_surv_01A <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>surv_01A<span class="punctuation">,</span> exp_01A<span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>exp_surv_01A<span class="punctuation">,</span> <span class="string">&quot;exp_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span></span><br><span class="line">            col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并生存信息与ESTIMATE</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>surv_01A<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">ESTIMATE_result_surv_01A <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>surv_01A<span class="punctuation">,</span> ESTIMATE_result<span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>ESTIMATE_result_surv_01A<span class="punctuation">,</span> <span class="string">&quot;ESTIMATE_result_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">            row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 根据ESTIMATE_result高低组做生存分析 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../survival&quot;</span><span class="punctuation">)</span></span><br><span class="line">surv <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;ESTIMATE_result_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                   check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">surv<span class="operator">$</span>OS.time <span class="operator">&lt;-</span> surv<span class="operator">$</span>OS.time <span class="operator">/</span> <span class="number">365</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建生存分析函数避免重复代码</span></span><br><span class="line">perform_survival_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">,</span> score_type<span class="punctuation">,</span> title<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&gt;</span> median<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Low&quot;</span><span class="punctuation">)</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>data<span class="operator">$</span>group<span class="punctuation">,</span> levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  fitd <span class="operator">&lt;-</span> survdiff<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span></span><br><span class="line">                   data <span class="operator">=</span> data<span class="punctuation">,</span></span><br><span class="line">                   na.action <span class="operator">=</span> na.exclude<span class="punctuation">)</span></span><br><span class="line">  pValue <span class="operator">&lt;-</span> 1 <span class="operator">-</span> pchisq<span class="punctuation">(</span>fitd<span class="operator">$</span>chisq<span class="punctuation">,</span> <span class="built_in">length</span><span class="punctuation">(</span>fitd<span class="operator">$</span>n<span class="punctuation">)</span> <span class="operator">-</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  fit <span class="operator">&lt;-</span> survfit<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> data<span class="punctuation">)</span></span><br><span class="line">  p.lab <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;P&quot;</span><span class="punctuation">,</span> ifelse<span class="punctuation">(</span>pValue <span class="operator">&lt;</span> <span class="number">0.001</span><span class="punctuation">,</span> <span class="string">&quot; &lt; 0.001&quot;</span><span class="punctuation">,</span> paste0<span class="punctuation">(</span><span class="string">&quot; = &quot;</span><span class="punctuation">,</span> <span class="built_in">round</span><span class="punctuation">(</span>pValue<span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  ggsurvplot<span class="punctuation">(</span>fit<span class="punctuation">,</span></span><br><span class="line">             data <span class="operator">=</span> data<span class="punctuation">,</span></span><br><span class="line">             pval <span class="operator">=</span> p.lab<span class="punctuation">,</span></span><br><span class="line">             conf.int <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             risk.table <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             risk.table.col <span class="operator">=</span> <span class="string">&quot;strata&quot;</span><span class="punctuation">,</span></span><br><span class="line">             palette <span class="operator">=</span> <span class="string">&quot;jco&quot;</span><span class="punctuation">,</span></span><br><span class="line">             legend.labs <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">             size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">             xlim <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">20</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">             break.time.by <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">             legend.title <span class="operator">=</span> title<span class="punctuation">,</span></span><br><span class="line">             surv.median.line <span class="operator">=</span> <span class="string">&quot;hv&quot;</span><span class="punctuation">,</span></span><br><span class="line">             ylab <span class="operator">=</span> <span class="string">&quot;Survival probability (%)&quot;</span><span class="punctuation">,</span></span><br><span class="line">             xlab <span class="operator">=</span> <span class="string">&quot;Time (Years)&quot;</span><span class="punctuation">,</span></span><br><span class="line">             ncensor.plot <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             ncensor.plot.height <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span></span><br><span class="line">             risk.table.y.text <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对三个评分进行生存分析</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">)</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">)</span> </span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>生物信息学</category>
      </categories>
      <tags>
        <tag>R</tag>
        <tag>生物信息学</tag>
      </tags>
  </entry>
</search>
