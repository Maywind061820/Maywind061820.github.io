<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.23.2","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":null},"fold":{"enable":true,"height":500},"language":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="生信速通之零：？？？其实本人是比较反感不求甚解的 但是总不能速通生物学有关内容、计算机组成原理、数学、编程吧 我们希望学习以下内容：  R语言语法 各种图形的绘制 TCGA的使用 COX回归分析 GO KEGG GESA富集分析 ……  R这个东西在我看来根本不是一门编程语言，而是一个工具。看各种教程所谓各种函数满天飞，各种包满天飞，编程没有逻辑性，没有美感，只剩下机械的记忆。 B站的教程大多讲不">
<meta property="og:type" content="article">
<meta property="og:title" content="生信速通">
<meta property="og:url" content="http://example.com/2025/10/12/EasyBioinformatics/index.html">
<meta property="og:site_name" content="May_wind&#39;s Blog">
<meta property="og:description" content="生信速通之零：？？？其实本人是比较反感不求甚解的 但是总不能速通生物学有关内容、计算机组成原理、数学、编程吧 我们希望学习以下内容：  R语言语法 各种图形的绘制 TCGA的使用 COX回归分析 GO KEGG GESA富集分析 ……  R这个东西在我看来根本不是一门编程语言，而是一个工具。看各种教程所谓各种函数满天飞，各种包满天飞，编程没有逻辑性，没有美感，只剩下机械的记忆。 B站的教程大多讲不">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-10-12T02:00:00.000Z">
<meta property="article:modified_time" content="2025-10-13T07:20:55.861Z">
<meta property="article:author" content="May_wind">
<meta property="article:tag" content="生物信息学">
<meta property="article:tag" content="TCGA">
<meta property="article:tag" content="极速版">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2025/10/12/EasyBioinformatics/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2025/10/12/EasyBioinformatics/","path":"2025/10/12/EasyBioinformatics/","title":"生信速通"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>生信速通 | May_wind's Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js" defer></script>



  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">May_wind's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">原来那天的天空从未改变</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%9F%E4%BF%A1%E9%80%9F%E9%80%9A%E4%B9%8B%E9%9B%B6%EF%BC%9A%EF%BC%9F%EF%BC%9F%EF%BC%9F"><span class="nav-number">1.</span> <span class="nav-text">生信速通之零：？？？</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#0-0%E6%B5%8B%E5%BA%8F%E8%BF%87%E7%A8%8B"><span class="nav-number">1.1.</span> <span class="nav-text">0.0测序过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0-1%E5%87%A0%E4%B8%AA%E6%9C%AF%E8%AF%AD"><span class="nav-number">1.2.</span> <span class="nav-text">0.1几个术语</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%9F%E4%BF%A1%E9%80%9F%E9%80%9A%E4%B9%8B%E4%B8%80-TCGA%E6%95%B0%E6%8D%AE%E4%B8%8B%E8%BD%BD%E5%92%8C%E9%A2%84%E5%A4%84%E7%90%86"><span class="nav-number">2.</span> <span class="nav-text">生信速通之一 TCGA数据下载和预处理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9ATCGA%E6%95%B0%E6%8D%AE%E4%B8%8B%E8%BD%BD"><span class="nav-number">2.1.</span> <span class="nav-text">第一部分：TCGA数据下载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%9A%E5%9F%BA%E5%9B%A0%E6%B3%A8%E9%87%8A%E4%BF%A1%E6%81%AF%E6%8F%90%E5%8F%96"><span class="nav-number">2.2.</span> <span class="nav-text">第二部分：基因注释信息提取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%EF%BC%9ACounts%E6%95%B0%E6%8D%AE%E6%8F%90%E5%8F%96%E5%92%8C%E5%A4%84%E7%90%86"><span class="nav-number">2.3.</span> <span class="nav-text">第三部分：Counts数据提取和处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%EF%BC%9A%E6%A0%B7%E6%9C%AC%E7%B1%BB%E5%9E%8B%E7%AD%9B%E9%80%89"><span class="nav-number">2.4.</span> <span class="nav-text">第四部分：样本类型筛选</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%EF%BC%9ATPM%E6%95%B0%E6%8D%AE%E6%8F%90%E5%8F%96%E5%92%8C%E5%A4%84%E7%90%86"><span class="nav-number">2.5.</span> <span class="nav-text">第五部分：TPM数据提取和处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%EF%BC%9A%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81%E5%92%8C%E5%90%88%E5%B9%B6"><span class="nav-number">2.6.</span> <span class="nav-text">第六部分：数据验证和合并</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%EF%BC%9A%E6%95%B0%E6%8D%AE%E6%A0%87%E5%87%86%E5%8C%96%E5%92%8C%E4%BF%9D%E5%AD%98"><span class="nav-number">2.7.</span> <span class="nav-text">第七部分：数据标准化和保存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="nav-number">2.8.</span> <span class="nav-text">完整代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%9F%E4%BF%A1%E9%80%9F%E9%80%9A%E4%B9%8B%E4%BA%8C-ESTIMATE%E7%94%9F%E5%AD%98%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">生信速通之二 ESTIMATE生存分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9AESTIMATE%E8%AF%84%E5%88%86%E8%AE%A1%E7%AE%97"><span class="nav-number">3.1.</span> <span class="nav-text">第一部分：ESTIMATE评分计算</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%9A%E7%94%9F%E5%AD%98%E6%95%B0%E6%8D%AE%E6%95%B4%E5%90%88"><span class="nav-number">3.2.</span> <span class="nav-text">第二部分：生存数据整合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%EF%BC%9A%E7%94%9F%E5%AD%98%E5%88%86%E6%9E%90"><span class="nav-number">3.3.</span> <span class="nav-text">第三部分：生存分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81-1"><span class="nav-number">3.4.</span> <span class="nav-text">完整代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%9F%E4%BF%A1%E9%80%9F%E9%80%9A%E4%B9%8B%E4%B8%89-TCGA%E4%B8%B4%E5%BA%8A%E4%BF%A1%E6%81%AF%E6%95%B4%E7%90%86"><span class="nav-number">4.</span> <span class="nav-text">生信速通之三 TCGA临床信息整理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#TCGA%E4%B8%B4%E5%BA%8A%E6%95%B0%E6%8D%AE%E6%95%B4%E7%90%86%E4%BB%A3%E7%A0%81%E8%AF%A6%E8%A7%A3"><span class="nav-number">4.1.</span> <span class="nav-text">TCGA临床数据整理代码详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E5%92%8C%E5%9F%BA%E7%A1%80%E5%A4%84%E7%90%86"><span class="nav-number">4.1.1.</span> <span class="nav-text">第一部分：数据加载和基础处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%9A%E6%95%B0%E6%8D%AE%E8%B4%A8%E9%87%8F%E6%A3%80%E6%9F%A5"><span class="nav-number">4.1.2.</span> <span class="nav-text">第二部分：数据质量检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%EF%BC%9A%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97%E5%92%8C%E6%A0%87%E5%87%86%E5%8C%96"><span class="nav-number">4.1.3.</span> <span class="nav-text">第三部分：数据清洗和标准化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%EF%BC%9A%E8%A1%A8%E8%BE%BE%E6%95%B0%E6%8D%AE%E6%95%B4%E5%90%88"><span class="nav-number">4.1.4.</span> <span class="nav-text">第四部分：表达数据整合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%EF%BC%9AESTIMATE%E8%AF%84%E5%88%86%E6%95%B4%E5%90%88"><span class="nav-number">4.1.5.</span> <span class="nav-text">第五部分：ESTIMATE评分整合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%EF%BC%9A%E5%A4%84%E7%90%86%E5%AE%8C%E6%88%90%E6%8F%90%E7%A4%BA"><span class="nav-number">4.1.6.</span> <span class="nav-text">第六部分：处理完成提示</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BC%98%E5%8C%96%E4%BB%A3%E7%A0%81"><span class="nav-number">4.2.</span> <span class="nav-text">完整优化代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%9F%E4%BF%A1%E9%80%9F%E9%80%9A%E4%B9%8B%E5%9B%9B-TCGA%E5%B7%AE%E5%BC%82%E5%88%86%E6%9E%90%E5%92%8C%E5%AF%8C%E9%9B%86%E5%88%86%E6%9E%90"><span class="nav-number">5.</span> <span class="nav-text">生信速通之四 TCGA差异分析和富集分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9A%E5%85%8D%E7%96%AB%E8%AF%84%E5%88%86%E5%B7%AE%E5%BC%82%E5%88%86%E6%9E%90"><span class="nav-number">5.1.</span> <span class="nav-text">第一部分：免疫评分差异分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%9ADESeq2%E5%B7%AE%E5%BC%82%E5%88%86%E6%9E%90%E6%B5%81%E7%A8%8B"><span class="nav-number">5.2.</span> <span class="nav-text">第二部分：DESeq2差异分析流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%EF%BC%9A%E5%B7%AE%E5%BC%82%E5%9F%BA%E5%9B%A0%E7%83%AD%E5%9B%BE%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-number">5.3.</span> <span class="nav-text">第三部分：差异基因热图可视化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%EF%BC%9A%E7%83%AD%E5%9B%BE%E7%BB%98%E5%88%B6%E5%92%8C%E7%BE%8E%E5%8C%96"><span class="nav-number">5.4.</span> <span class="nav-text">第四部分：热图绘制和美化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%EF%BC%9A%E9%87%8D%E5%A4%8D%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%E5%9F%BA%E8%B4%A8%E8%AF%84%E5%88%86"><span class="nav-number">5.5.</span> <span class="nav-text">第五部分：重复流程分析基质评分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%EF%BC%9A%E5%B7%AE%E5%BC%82%E5%9F%BA%E5%9B%A0%E4%BA%A4%E9%9B%86%E5%88%86%E6%9E%90"><span class="nav-number">5.6.</span> <span class="nav-text">第六部分：差异基因交集分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%EF%BC%9A%E5%8A%9F%E8%83%BD%E5%AF%8C%E9%9B%86%E5%88%86%E6%9E%90"><span class="nav-number">5.7.</span> <span class="nav-text">第七部分：功能富集分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AB%E9%83%A8%E5%88%86%EF%BC%9AGO%E5%92%8CKEGG%E5%AF%8C%E9%9B%86%E5%88%86%E6%9E%90"><span class="nav-number">5.8.</span> <span class="nav-text">第八部分：GO和KEGG富集分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B9%9D%E9%83%A8%E5%88%86%EF%BC%9A%E5%AF%8C%E9%9B%86%E7%BD%91%E7%BB%9C%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-number">5.9.</span> <span class="nav-text">第九部分：富集网络可视化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81-2"><span class="nav-number">5.10.</span> <span class="nav-text">完整代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%9F%E4%BF%A1%E9%80%9F%E9%80%9A%E4%B9%8B%E4%BA%94-PPI%E5%92%8CCOX"><span class="nav-number">6.</span> <span class="nav-text">生信速通之五 PPI和COX</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9APPI%E7%BD%91%E7%BB%9C%E5%88%86%E6%9E%90%E5%87%86%E5%A4%87"><span class="nav-number">6.1.</span> <span class="nav-text">第一部分：PPI网络分析准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%9A%E5%8D%95%E5%8F%98%E9%87%8FCox%E5%9B%9E%E5%BD%92%E5%88%86%E6%9E%90"><span class="nav-number">6.2.</span> <span class="nav-text">第二部分：单变量Cox回归分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%EF%BC%9A%E6%89%B9%E9%87%8F%E5%8D%95%E5%8F%98%E9%87%8FCox%E5%88%86%E6%9E%90"><span class="nav-number">6.3.</span> <span class="nav-text">第三部分：批量单变量Cox分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%EF%BC%9A%E6%98%BE%E8%91%97%E5%9F%BA%E5%9B%A0%E7%AD%9B%E9%80%89"><span class="nav-number">6.4.</span> <span class="nav-text">第四部分：显著基因筛选</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%EF%BC%9A%E6%A3%AE%E6%9E%97%E5%9B%BE%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="nav-number">6.5.</span> <span class="nav-text">第五部分：森林图数据准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%EF%BC%9A%E6%A3%AE%E6%9E%97%E5%9B%BE%E7%BB%98%E5%88%B6"><span class="nav-number">6.6.</span> <span class="nav-text">第六部分：森林图绘制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BC%98%E5%8C%96%E4%BB%A3%E7%A0%81-1"><span class="nav-number">6.7.</span> <span class="nav-text">完整优化代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%9F%E4%BF%A1%E9%80%9F%E9%80%9A%E4%B9%8B%E5%85%AD-BTK%E5%9C%A8%E8%82%BF%E7%98%A4%E6%A0%B7%E6%9C%AC%E4%B8%8E%E6%AD%A3%E5%B8%B8%E6%A0%B7%E6%9C%AC%E4%B8%AD%E7%9A%84%E8%A1%A8%E8%BE%BE%E5%B7%AE%E5%BC%82"><span class="nav-number">7.</span> <span class="nav-text">生信速通之六 BTK在肿瘤样本与正常样本中的表达差异</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9ABTK%E5%9C%A8%E8%82%BF%E7%98%A4vs%E6%AD%A3%E5%B8%B8%E6%A0%B7%E6%9C%AC%E4%B8%AD%E7%9A%84%E8%A1%A8%E8%BE%BE%E5%B7%AE%E5%BC%82"><span class="nav-number">7.1.</span> <span class="nav-text">第一部分：BTK在肿瘤vs正常样本中的表达差异</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%9A%E9%85%8D%E5%AF%B9%E6%A0%B7%E6%9C%AC%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="nav-number">7.2.</span> <span class="nav-text">第二部分：配对样本数据准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%EF%BC%9ABTK%E8%A1%A8%E8%BE%BE%E4%B8%8E%E7%94%9F%E5%AD%98%E5%88%86%E6%9E%90"><span class="nav-number">7.3.</span> <span class="nav-text">第三部分：BTK表达与生存分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%EF%BC%9A%E7%94%9F%E5%AD%98%E6%9B%B2%E7%BA%BF%E7%BB%98%E5%88%B6"><span class="nav-number">7.4.</span> <span class="nav-text">第四部分：生存曲线绘制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%EF%BC%9ABTK%E5%9C%A8%E4%B8%8D%E5%90%8C%E4%B8%B4%E5%BA%8A%E5%88%86%E6%9C%9F%E4%B8%AD%E7%9A%84%E8%A1%A8%E8%BE%BE"><span class="nav-number">7.5.</span> <span class="nav-text">第五部分：BTK在不同临床分期中的表达</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81-3"><span class="nav-number">7.6.</span> <span class="nav-text">完整代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%9F%E4%BF%A1%E9%80%9F%E9%80%9A%E4%B9%8B%E4%B8%83-BTK%E7%9B%B8%E5%85%B3%E5%B7%AE%E5%BC%82%E5%88%86%E6%9E%90%E5%92%8CGSEA%E5%AF%8C%E9%9B%86%E5%88%86%E6%9E%90"><span class="nav-number">8.</span> <span class="nav-text">生信速通之七 BTK相关差异分析和GSEA富集分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9A%E5%9F%BA%E4%BA%8EBTK%E8%A1%A8%E8%BE%BE%E7%9A%84%E5%B7%AE%E5%BC%82%E5%88%86%E6%9E%90"><span class="nav-number">8.1.</span> <span class="nav-text">第一部分：基于BTK表达的差异分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%9ADESeq2%E5%B7%AE%E5%BC%82%E5%88%86%E6%9E%90"><span class="nav-number">8.2.</span> <span class="nav-text">第二部分：DESeq2差异分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%EF%BC%9AGSEA%E5%88%86%E6%9E%90%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="nav-number">8.3.</span> <span class="nav-text">第三部分：GSEA分析数据准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%EF%BC%9AHallmark%E5%9F%BA%E5%9B%A0%E9%9B%86GSEA%E5%88%86%E6%9E%90"><span class="nav-number">8.4.</span> <span class="nav-text">第四部分：Hallmark基因集GSEA分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%EF%BC%9AGSEA%E7%BB%93%E6%9E%9C%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-number">8.5.</span> <span class="nav-text">第五部分：GSEA结果可视化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%EF%BC%9A%E5%85%8D%E7%96%AB%E5%9F%BA%E5%9B%A0%E9%9B%86GSEA%E5%88%86%E6%9E%90"><span class="nav-number">8.6.</span> <span class="nav-text">第六部分：免疫基因集GSEA分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81-4"><span class="nav-number">8.7.</span> <span class="nav-text">完整代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E4%BF%A1%E9%80%9F%E9%80%9A%E4%B9%8B%E5%85%AB-CIBERSORT%E5%85%8D%E7%96%AB%E7%BB%86%E8%83%9E%E6%B5%B8%E6%B6%A6%E5%88%86%E6%9E%90"><span class="nav-number">8.8.</span> <span class="nav-text">生信速通之八 CIBERSORT免疫细胞浸润分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9ACIBERSORT%E5%88%86%E6%9E%90%E6%89%A7%E8%A1%8C"><span class="nav-number">8.9.</span> <span class="nav-text">第一部分：CIBERSORT分析执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%9A%E5%85%8D%E7%96%AB%E7%BB%86%E8%83%9E%E6%AF%94%E4%BE%8B%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-number">8.10.</span> <span class="nav-text">第二部分：免疫细胞比例可视化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%EF%BC%9ABTK%E9%AB%98%E4%BD%8E%E7%BB%84%E7%9A%84%E5%85%8D%E7%96%AB%E7%BB%86%E8%83%9E%E5%B7%AE%E5%BC%82"><span class="nav-number">8.11.</span> <span class="nav-text">第三部分：BTK高低组的免疫细胞差异</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%EF%BC%9A%E5%85%8D%E7%96%AB%E7%BB%86%E8%83%9E%E7%9B%B8%E5%85%B3%E6%80%A7%E7%83%AD%E5%9B%BE"><span class="nav-number">8.12.</span> <span class="nav-text">第四部分：免疫细胞相关性热图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%EF%BC%9A%E5%9F%BA%E5%9B%A0%E4%B8%8E%E5%85%8D%E7%96%AB%E7%BB%86%E8%83%9E%E7%9B%B8%E5%85%B3%E6%80%A7%E6%95%A3%E7%82%B9%E5%9B%BE"><span class="nav-number">8.13.</span> <span class="nav-text">第五部分：基因与免疫细胞相关性散点图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81-5"><span class="nav-number">8.14.</span> <span class="nav-text">完整代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B0%BE%E8%A8%80"><span class="nav-number">9.</span> <span class="nav-text">尾言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#R%E8%AF%AD%E8%A8%80%E5%B0%86%E4%BC%9A%E8%87%AD%E5%90%8D%E6%98%AD%E8%91%97"><span class="nav-number">10.</span> <span class="nav-text">R语言将会臭名昭著</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">May_wind</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/10/12/EasyBioinformatics/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="May_wind">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="May_wind's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="生信速通 | May_wind's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          生信速通
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-10-12 10:00:00" itemprop="dateCreated datePublished" datetime="2025-10-12T10:00:00+08:00">2025-10-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-10-13 15:20:55" itemprop="dateModified" datetime="2025-10-13T15:20:55+08:00">2025-10-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%94%9F%E7%89%A9%E4%BF%A1%E6%81%AF%E5%AD%A6/" itemprop="url" rel="index"><span itemprop="name">生物信息学</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="生信速通之零：？？？"><a href="#生信速通之零：？？？" class="headerlink" title="生信速通之零：？？？"></a>生信速通之零：？？？</h1><p><del>其实本人是比较反感不求甚解的</del></p>
<p><del>但是总不能速通生物学有关内容、计算机组成原理、数学、编程吧</del></p>
<p>我们希望学习以下内容：</p>
<ul>
<li>R语言语法</li>
<li>各种图形的绘制</li>
<li>TCGA的使用</li>
<li>COX回归分析</li>
<li>GO KEGG GESA富集分析</li>
<li>……</li>
</ul>
<p>R这个东西在我看来根本不是一门编程语言，而是一个工具。看各种教程所谓各种函数满天飞，各种包满天飞，编程没有逻辑性，没有美感，只剩下机械的记忆。</p>
<p>B站的教程大多讲不清原理，或多或少地进行了关键部分的模糊和隐藏。令人汗颜！</p>
<p>可恶，然而……</p>
<hr>
<p>本篇旨在介绍一些基础概念和流程。您可以查看其他文章以获取更详细的信息。</p>
<p>呐，要开始了哟！</p>
<hr>
<h2 id="0-0测序过程"><a href="#0-0测序过程" class="headerlink" title="0.0测序过程"></a>0.0测序过程</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1v34y147nj">illumina技术原理</a></p>
<h2 id="0-1几个术语"><a href="#0-1几个术语" class="headerlink" title="0.1几个术语"></a>0.1几个术语</h2><ul>
<li>reads: 一个 read 是落到某个基因的一个DNA测序片段</li>
<li>counts：一个基因的 reads 总数即为该基因的 counts</li>
<li>基因长度：目标基因非重叠外显子长度之和（有几个碱基对）</li>
<li>测序深度：测序得到的基因总量（bp）与基因组（测序目标区域、转录组）的比值。</li>
</ul>
<hr>
<ul>
<li>RPK(每千个碱基的read数)<ul>
<li>$\text{RPK}_i = 10 ^ 3 \cdot \dfrac{n_i}{l_i}$</li>
<li>平衡掉基因长度的影响</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>RPKM<ul>
<li>$\text{RPKM}_i = 10 ^ 6 \cdot \dfrac{\text{RPK}_i}{\sum _j n_j}$</li>
<li>在RPK的基础上平衡掉基因深度的影响</li>
<li>RPKM是单端测序的概念，FPKM是双端测序的概念</li>
<li><strong>可以组内比较，无法组间比较</strong></li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>TPM<ul>
<li>$\text{TPM}_i = 10 ^ 6 \cdot \dfrac{\text{RPK}_i}{\sum _j \text{RPK}}_j$</li>
<li><strong>既可组内比较，也可组间比较</strong></li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>CPM<ul>
<li>$\text{CPM}_i = 10 ^ 6 \cdot \dfrac{n_i}{\sum _j n_j}$</li>
<li><strong>不可组内比较，可以组间比较</strong></li>
</ul>
</li>
</ul>
<h1 id="生信速通之一-TCGA数据下载和预处理"><a href="#生信速通之一-TCGA数据下载和预处理" class="headerlink" title="生信速通之一 TCGA数据下载和预处理"></a>生信速通之一 TCGA数据下载和预处理</h1><h2 id="第一部分：TCGA数据下载"><a href="#第一部分：TCGA数据下载" class="headerlink" title="第一部分：TCGA数据下载"></a>第一部分：TCGA数据下载</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">setwd<span class="punctuation">(</span><span class="string">&#x27;TCGA-LUAD&#x27;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGAdata&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span><span class="comment">#加载包</span></span><br><span class="line"><span class="comment">#安装TCGAbiolinks包</span></span><br><span class="line"><span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span>require<span class="punctuation">(</span><span class="string">&quot;BiocManager&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  install.packages<span class="punctuation">(</span><span class="string">&quot;BiocManager&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">library<span class="punctuation">(</span>BiocManager<span class="punctuation">)</span></span><br><span class="line">BiocManager<span class="operator">::</span>install<span class="punctuation">(</span><span class="string">&quot;BioinformaticsFMRP/TCGAbiolinksGUI.data&quot;</span><span class="punctuation">)</span></span><br><span class="line">BiocManager<span class="operator">::</span>install<span class="punctuation">(</span><span class="string">&quot;TCGAbiolinks&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>TCGAbiolinks<span class="punctuation">)</span></span><br><span class="line">cancer_type <span class="operator">=</span> <span class="string">&quot;TCGA-LUAD&quot;</span>   <span class="comment">#肿瘤类型，这里可修改癌症类型</span></span><br><span class="line"><span class="comment">#TCGA 肿瘤缩写：https://www.jianshu.com/p/3c0f74e85825</span></span><br><span class="line">expquery <span class="operator">&lt;-</span> GDCquery<span class="punctuation">(</span>project <span class="operator">=</span> cancer_type<span class="punctuation">,</span></span><br><span class="line">                     data.category <span class="operator">=</span> <span class="string">&quot;Transcriptome Profiling&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     data.type <span class="operator">=</span> <span class="string">&quot;Gene Expression Quantification&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     workflow.type <span class="operator">=</span> <span class="string">&quot;STAR - Counts&quot;</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line">GDCdownload<span class="punctuation">(</span>expquery<span class="punctuation">,</span>directory <span class="operator">=</span> <span class="string">&quot;GDCdata&quot;</span><span class="punctuation">)</span></span><br><span class="line">expquery2 <span class="operator">&lt;-</span> GDCprepare<span class="punctuation">(</span>expquery<span class="punctuation">,</span>directory <span class="operator">=</span> <span class="string">&quot;GDCdata&quot;</span><span class="punctuation">,</span>summarizedExperiment <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：从GDC数据库下载TCGA-LUAD的RNA-seq原始数据，使用STAR流程的counts数据。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>GDCquery()</code>: 构建数据查询，指定项目、数据类型和分析流程</li>
<li><code>GDCdownload()</code>: 下载查询到的数据到本地</li>
<li><code>GDCprepare()</code>: 将下载的数据转换为R可用的格式</li>
</ul>
<hr>
<h2 id="第二部分：基因注释信息提取"><a href="#第二部分：基因注释信息提取" class="headerlink" title="第二部分：基因注释信息提取"></a>第二部分：基因注释信息提取</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gene_annotation <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>rowData<span class="punctuation">(</span>expquery2<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">gene_annotation1 <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span></span><br><span class="line">  ENSEMBL <span class="operator">=</span> rownames<span class="punctuation">(</span>gene_annotation<span class="punctuation">)</span><span class="punctuation">,</span>  </span><br><span class="line">  symbol <span class="operator">=</span> gene_annotation<span class="operator">$</span>gene_name<span class="punctuation">,</span> </span><br><span class="line">  type <span class="operator">=</span> gene_annotation<span class="operator">$</span>gene_type<span class="punctuation">,</span> </span><br><span class="line">  stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span></span><br><span class="line"><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 保存</span></span><br><span class="line">save<span class="punctuation">(</span>gene_annotation1<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;gene_annotation_2022.rda&quot;</span><span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>expquery2<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;luad.gdc_2022.rda&quot;</span><span class="punctuation">)</span> <span class="comment"># 保存 rda格式</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：提取基因的ENSEMBL ID、基因符号和基因类型信息，为后续基因ID转换做准备。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>rowData()</code>: 提取SummarizedExperiment对象的行数据（基因信息）</li>
<li><code>stringsAsFactors = FALSE</code>: 防止字符向量自动转换为因子</li>
</ul>
<hr>
<h2 id="第三部分：Counts数据提取和处理"><a href="#第三部分：Counts数据提取和处理" class="headerlink" title="第三部分：Counts数据提取和处理"></a>第三部分：Counts数据提取和处理</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基因名称symbol ENSEMBL</span></span><br><span class="line">counts <span class="operator">&lt;-</span> expquery2<span class="operator">@</span>assays<span class="operator">@</span>data<span class="operator">@</span>listData<span class="punctuation">[[</span><span class="string">&quot;unstranded&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">colnames<span class="punctuation">(</span>counts<span class="punctuation">)</span> <span class="operator">&lt;-</span> expquery2<span class="operator">@</span>colData<span class="operator">@</span>rownames</span><br><span class="line">rownames<span class="punctuation">(</span>counts<span class="punctuation">)</span> <span class="operator">&lt;-</span> expquery2<span class="operator">@</span>rowRanges<span class="operator">@</span>ranges<span class="operator">@</span>NAMES</span><br><span class="line"><span class="comment">#基因ID转换</span></span><br><span class="line">counts <span class="operator">&lt;-</span> counts <span class="operator">%&gt;%</span> </span><br><span class="line">  as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  rownames_to_column<span class="punctuation">(</span><span class="string">&quot;ENSEMBL&quot;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  inner_join<span class="punctuation">(</span>gene_annotation_2022<span class="punctuation">,</span><span class="string">&quot;ENSEMBL&quot;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  .<span class="punctuation">[</span><span class="operator">!</span>duplicated<span class="punctuation">(</span>.<span class="operator">$</span>symbol<span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：从原始数据对象中提取raw counts数据，并将ENSEMBL ID转换为基因符号。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>@assays@data@listData[[&quot;unstranded&quot;]]</code>: 访问SummarizedExperiment对象的counts数据</li>
<li><code>inner_join()</code>: 内连接，基于ENSEMBL ID合并基因注释信息</li>
<li><code>!duplicated(.$symbol)</code>: 去除重复的基因符号，保留第一个出现</li>
</ul>
<hr>
<h2 id="第四部分：样本类型筛选"><a href="#第四部分：样本类型筛选" class="headerlink" title="第四部分：样本类型筛选"></a>第四部分：样本类型筛选</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把TCGA barcode切割为16位字符,并去除重复样本</span></span><br><span class="line">colnames<span class="punctuation">(</span>counts<span class="punctuation">)</span> <span class="operator">&lt;-</span> substring<span class="punctuation">(</span>colnames<span class="punctuation">(</span>counts<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">16</span><span class="punctuation">)</span></span><br><span class="line">counts <span class="operator">&lt;-</span> counts<span class="punctuation">[</span><span class="punctuation">,</span><span class="operator">!</span>duplicated<span class="punctuation">(</span>colnames<span class="punctuation">(</span>counts<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">table<span class="punctuation">(</span>substring<span class="punctuation">(</span>colnames<span class="punctuation">(</span>counts<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">14</span><span class="punctuation">,</span><span class="number">16</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment"># 保留01A  （注：可通过table(substring(colnames(counts),14,16))查看样本类型）</span></span><br><span class="line">counts01A <span class="operator">&lt;-</span> counts<span class="punctuation">[</span><span class="punctuation">,</span>substring<span class="punctuation">(</span>colnames<span class="punctuation">(</span>counts<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">14</span><span class="punctuation">,</span><span class="number">16</span><span class="punctuation">)</span> <span class="operator">==</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;01A&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line"><span class="comment"># 保留11A</span></span><br><span class="line">counts11A <span class="operator">&lt;-</span> counts<span class="punctuation">[</span><span class="punctuation">,</span>substring<span class="punctuation">(</span>colnames<span class="punctuation">(</span>counts<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">14</span><span class="punctuation">,</span><span class="number">16</span><span class="punctuation">)</span> <span class="operator">==</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;11A&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：根据TCGA样本barcode的第14-16位代码筛选特定样本类型：</p>
<ul>
<li>“01A”: 原发性肿瘤组织</li>
<li>“11A”: 癌旁正常组织</li>
</ul>
<p><strong>研究意义</strong>：分离肿瘤和正常样本，为后续差异分析提供对照。</p>
<hr>
<h2 id="第五部分：TPM数据提取和处理"><a href="#第五部分：TPM数据提取和处理" class="headerlink" title="第五部分：TPM数据提取和处理"></a>第五部分：TPM数据提取和处理</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####tpms####</span></span><br><span class="line"><span class="comment">#和counts基本一模一样</span></span><br><span class="line">tpms <span class="operator">&lt;-</span> expquery2<span class="operator">@</span>assays<span class="operator">@</span>data<span class="operator">@</span>listData<span class="punctuation">[[</span><span class="string">&quot;tpm_unstrand&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">colnames<span class="punctuation">(</span>tpms<span class="punctuation">)</span> <span class="operator">&lt;-</span> expquery2<span class="operator">@</span>colData<span class="operator">@</span>rownames</span><br><span class="line">rownames<span class="punctuation">(</span>tpms<span class="punctuation">)</span> <span class="operator">&lt;-</span> expquery2<span class="operator">@</span>rowRanges<span class="operator">@</span>ranges<span class="operator">@</span>NAMES</span><br><span class="line">tpms <span class="operator">&lt;-</span> tpms <span class="operator">%&gt;%</span> </span><br><span class="line">  as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  rownames_to_column<span class="punctuation">(</span><span class="string">&quot;ENSEMBL&quot;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  inner_join<span class="punctuation">(</span>gene_annotation_2022<span class="punctuation">,</span><span class="string">&quot;ENSEMBL&quot;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  .<span class="punctuation">[</span><span class="operator">!</span>duplicated<span class="punctuation">(</span>.<span class="operator">$</span>symbol<span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：提取TPM标准化表达数据，用于基因表达水平比较和可视化。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>tpm_unstrand</code>: TPM标准化表达值，便于样本间比较</li>
<li>处理流程与counts数据相同，确保数据一致性</li>
</ul>
<hr>
<h2 id="第六部分：数据验证和合并"><a href="#第六部分：数据验证和合并" class="headerlink" title="第六部分：数据验证和合并"></a>第六部分：数据验证和合并</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#判断counts和tpms的行列名是否一致</span></span><br><span class="line">identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>counts01A<span class="punctuation">)</span><span class="punctuation">,</span>rownames<span class="punctuation">(</span>counts11A<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>tpms01A<span class="punctuation">)</span><span class="punctuation">,</span>rownames<span class="punctuation">(</span>tpms11A<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>counts01A<span class="punctuation">)</span><span class="punctuation">,</span>rownames<span class="punctuation">(</span>tpms01A<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>colnames<span class="punctuation">(</span>counts01A<span class="punctuation">)</span><span class="punctuation">,</span>colnames<span class="punctuation">(</span>tpms01A<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>colnames<span class="punctuation">(</span>counts11A<span class="punctuation">)</span><span class="punctuation">,</span>colnames<span class="punctuation">(</span>tpms11A<span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：验证不同数据集间基因和样本的一致性，确保后续分析的可靠性。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>identical()</code>: 精确比较两个对象是否完全相同</li>
</ul>
<hr>
<h2 id="第七部分：数据标准化和保存"><a href="#第七部分：数据标准化和保存" class="headerlink" title="第七部分：数据标准化和保存"></a>第七部分：数据标准化和保存</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####tpms_log2####</span></span><br><span class="line"><span class="built_in">range</span><span class="punctuation">(</span>tpms<span class="punctuation">)</span><span class="comment">#查看数据范围</span></span><br><span class="line"><span class="built_in">range</span><span class="punctuation">(</span>tpms01A<span class="punctuation">)</span></span><br><span class="line"><span class="built_in">range</span><span class="punctuation">(</span>tpms11A<span class="punctuation">)</span></span><br><span class="line">tpms_log2 <span class="operator">&lt;-</span> log2<span class="punctuation">(</span>tpms<span class="operator">+</span><span class="number">1</span><span class="punctuation">)</span><span class="comment">#log2转换 为什么要加1</span></span><br><span class="line"><span class="built_in">range</span><span class="punctuation">(</span>tpms_log2<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：对TPM数据进行log2转换，使数据分布更接近正态分布，满足许多统计方法的假设。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>log2(tpms+1)</code>: 加1防止对0取对数，同时保持数据相对关系</li>
<li><code>range()</code>: 查看数据的最小值和最大值</li>
</ul>
<hr>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### TCGA数据下载和预处理 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&#x27;TCGA-LUAD/TCGAdata&#x27;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>TCGAbiolinks<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TCGA数据下载函数</span></span><br><span class="line">download_tcga_data <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>cancer_type <span class="operator">=</span> <span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  expquery <span class="operator">&lt;-</span> GDCquery<span class="punctuation">(</span></span><br><span class="line">    project <span class="operator">=</span> cancer_type<span class="punctuation">,</span></span><br><span class="line">    data.category <span class="operator">=</span> <span class="string">&quot;Transcriptome Profiling&quot;</span><span class="punctuation">,</span></span><br><span class="line">    data.type <span class="operator">=</span> <span class="string">&quot;Gene Expression Quantification&quot;</span><span class="punctuation">,</span></span><br><span class="line">    workflow.type <span class="operator">=</span> <span class="string">&quot;STAR - Counts&quot;</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  GDCdownload<span class="punctuation">(</span>expquery<span class="punctuation">,</span> directory <span class="operator">=</span> <span class="string">&quot;GDCdata&quot;</span><span class="punctuation">)</span></span><br><span class="line">  expquery2 <span class="operator">&lt;-</span> GDCprepare<span class="punctuation">(</span>expquery<span class="punctuation">,</span> directory <span class="operator">=</span> <span class="string">&quot;GDCdata&quot;</span><span class="punctuation">,</span> summarizedExperiment <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>expquery2<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基因注释提取函数</span></span><br><span class="line">extract_gene_annotation <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>exp_data<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  gene_annotation <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>rowData<span class="punctuation">(</span>exp_data<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  gene_annotation1 <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span></span><br><span class="line">    ENSEMBL <span class="operator">=</span> rownames<span class="punctuation">(</span>gene_annotation<span class="punctuation">)</span><span class="punctuation">,</span>  </span><br><span class="line">    symbol <span class="operator">=</span> gene_annotation<span class="operator">$</span>gene_name<span class="punctuation">,</span> </span><br><span class="line">    type <span class="operator">=</span> gene_annotation<span class="operator">$</span>gene_type<span class="punctuation">,</span> </span><br><span class="line">    stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>gene_annotation1<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 表达数据提取和转换函数</span></span><br><span class="line">process_expression_data <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>exp_data<span class="punctuation">,</span> annotation<span class="punctuation">,</span> data_type <span class="operator">=</span> <span class="string">&quot;unstranded&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 提取表达数据</span></span><br><span class="line">  <span class="keyword">if</span><span class="punctuation">(</span>data_type <span class="operator">==</span> <span class="string">&quot;unstranded&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    expr_data <span class="operator">&lt;-</span> exp_data<span class="operator">@</span>assays<span class="operator">@</span>data<span class="operator">@</span>listData<span class="punctuation">[[</span><span class="string">&quot;unstranded&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="punctuation">&#123;</span></span><br><span class="line">    expr_data <span class="operator">&lt;-</span> exp_data<span class="operator">@</span>assays<span class="operator">@</span>data<span class="operator">@</span>listData<span class="punctuation">[[</span><span class="string">&quot;tpm_unstrand&quot;</span><span class="punctuation">]</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 设置行列名</span></span><br><span class="line">  colnames<span class="punctuation">(</span>expr_data<span class="punctuation">)</span> <span class="operator">&lt;-</span> exp_data<span class="operator">@</span>colData<span class="operator">@</span>rownames</span><br><span class="line">  rownames<span class="punctuation">(</span>expr_data<span class="punctuation">)</span> <span class="operator">&lt;-</span> exp_data<span class="operator">@</span>rowRanges<span class="operator">@</span>ranges<span class="operator">@</span>NAMES</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 基因ID转换</span></span><br><span class="line">  expr_processed <span class="operator">&lt;-</span> expr_data <span class="operator">%&gt;%</span> </span><br><span class="line">    as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">    rownames_to_column<span class="punctuation">(</span><span class="string">&quot;ENSEMBL&quot;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">    inner_join<span class="punctuation">(</span>annotation<span class="punctuation">,</span> <span class="string">&quot;ENSEMBL&quot;</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">    .<span class="punctuation">[</span><span class="operator">!</span>duplicated<span class="punctuation">(</span>.<span class="operator">$</span>symbol<span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span> <span class="operator">%&gt;%</span> </span><br><span class="line">    column_to_rownames<span class="punctuation">(</span><span class="string">&quot;symbol&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>expr_processed<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 样本筛选函数</span></span><br><span class="line">filter_samples <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>expr_data<span class="punctuation">,</span> sample_type <span class="operator">=</span> <span class="string">&quot;01A&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 处理列名</span></span><br><span class="line">  colnames<span class="punctuation">(</span>expr_data<span class="punctuation">)</span> <span class="operator">&lt;-</span> substring<span class="punctuation">(</span>colnames<span class="punctuation">(</span>expr_data<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">16</span><span class="punctuation">)</span></span><br><span class="line">  expr_data <span class="operator">&lt;-</span> expr_data<span class="punctuation">[</span><span class="punctuation">,</span> <span class="operator">!</span>duplicated<span class="punctuation">(</span>colnames<span class="punctuation">(</span>expr_data<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 筛选特定样本类型</span></span><br><span class="line">  sample_code <span class="operator">&lt;-</span> substring<span class="punctuation">(</span>colnames<span class="punctuation">(</span>expr_data<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">14</span><span class="punctuation">,</span> <span class="number">16</span><span class="punctuation">)</span></span><br><span class="line">  filtered_data <span class="operator">&lt;-</span> expr_data<span class="punctuation">[</span><span class="punctuation">,</span> sample_code <span class="operator">==</span> sample_type<span class="punctuation">]</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>filtered_data<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主分析流程</span></span><br><span class="line"><span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span>file.exists<span class="punctuation">(</span><span class="string">&quot;luad.gdc_2022.rda&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 下载数据</span></span><br><span class="line">  expquery2 <span class="operator">&lt;-</span> download_tcga_data<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 提取基因注释</span></span><br><span class="line">  gene_annotation_2022 <span class="operator">&lt;-</span> extract_gene_annotation<span class="punctuation">(</span>expquery2<span class="punctuation">)</span></span><br><span class="line">  save<span class="punctuation">(</span>gene_annotation_2022<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;gene_annotation_2022.rda&quot;</span><span class="punctuation">)</span></span><br><span class="line">  save<span class="punctuation">(</span>expquery2<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;luad.gdc_2022.rda&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="punctuation">&#123;</span></span><br><span class="line">  load<span class="punctuation">(</span><span class="string">&quot;luad.gdc_2022.rda&quot;</span><span class="punctuation">)</span></span><br><span class="line">  load<span class="punctuation">(</span><span class="string">&quot;gene_annotation_2022.rda&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理counts数据</span></span><br><span class="line">counts_processed <span class="operator">&lt;-</span> process_expression_data<span class="punctuation">(</span>expquery2<span class="punctuation">,</span> gene_annotation_2022<span class="punctuation">,</span> <span class="string">&quot;unstranded&quot;</span><span class="punctuation">)</span></span><br><span class="line">counts_processed <span class="operator">&lt;-</span> counts_processed<span class="punctuation">[</span>counts_processed<span class="operator">$</span>type <span class="operator">==</span> <span class="string">&quot;protein_coding&quot;</span><span class="punctuation">,</span> <span class="operator">-</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> ncol<span class="punctuation">(</span>counts_processed<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 筛选样本</span></span><br><span class="line">counts01A <span class="operator">&lt;-</span> filter_samples<span class="punctuation">(</span>counts_processed<span class="punctuation">,</span> <span class="string">&quot;01A&quot;</span><span class="punctuation">)</span></span><br><span class="line">counts11A <span class="operator">&lt;-</span> filter_samples<span class="punctuation">(</span>counts_processed<span class="punctuation">,</span> <span class="string">&quot;11A&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理TPM数据</span></span><br><span class="line">tpms_processed <span class="operator">&lt;-</span> process_expression_data<span class="punctuation">(</span>expquery2<span class="punctuation">,</span> gene_annotation_2022<span class="punctuation">,</span> <span class="string">&quot;tpm_unstrand&quot;</span><span class="punctuation">)</span></span><br><span class="line">tpms_processed <span class="operator">&lt;-</span> tpms_processed<span class="punctuation">[</span>tpms_processed<span class="operator">$</span>type <span class="operator">==</span> <span class="string">&quot;protein_coding&quot;</span><span class="punctuation">,</span> <span class="operator">-</span><span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span> ncol<span class="punctuation">(</span>tpms_processed<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 筛选样本</span></span><br><span class="line">tpms01A <span class="operator">&lt;-</span> filter_samples<span class="punctuation">(</span>tpms_processed<span class="punctuation">,</span> <span class="string">&quot;01A&quot;</span><span class="punctuation">)</span></span><br><span class="line">tpms11A <span class="operator">&lt;-</span> filter_samples<span class="punctuation">(</span>tpms_processed<span class="punctuation">,</span> <span class="string">&quot;11A&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据验证</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;数据一致性检查:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;Counts01A和Counts11A基因一致:&quot;</span><span class="punctuation">,</span> identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>counts01A<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>counts11A<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;TPM01A和TPM11A基因一致:&quot;</span><span class="punctuation">,</span> identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>tpms01A<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>tpms11A<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;Counts01A和TPM01A基因一致:&quot;</span><span class="punctuation">,</span> identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>counts01A<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>tpms01A<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存原始数据</span></span><br><span class="line">write.table<span class="punctuation">(</span>counts01A<span class="punctuation">,</span> <span class="string">&quot;counts01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>counts11A<span class="punctuation">,</span> <span class="string">&quot;counts11A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>tpms01A<span class="punctuation">,</span> <span class="string">&quot;tpms01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>tpms11A<span class="punctuation">,</span> <span class="string">&quot;tpms11A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并数据</span></span><br><span class="line">counts_combined <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>counts01A<span class="punctuation">,</span> counts11A<span class="punctuation">)</span></span><br><span class="line">tpms_combined <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>tpms01A<span class="punctuation">,</span> tpms11A<span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>counts_combined<span class="punctuation">,</span> <span class="string">&quot;counts.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>tpms_combined<span class="punctuation">,</span> <span class="string">&quot;tpms.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># log2转换</span></span><br><span class="line">tpms_log2 <span class="operator">&lt;-</span> log2<span class="punctuation">(</span>tpms_combined <span class="operator">+</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">tpms01A_log2 <span class="operator">&lt;-</span> log2<span class="punctuation">(</span>tpms01A <span class="operator">+</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">tpms11A_log2 <span class="operator">&lt;-</span> log2<span class="punctuation">(</span>tpms11A <span class="operator">+</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;数据范围检查:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;TPM范围:&quot;</span><span class="punctuation">,</span> <span class="built_in">range</span><span class="punctuation">(</span>tpms_combined<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;TPM01A范围:&quot;</span><span class="punctuation">,</span> <span class="built_in">range</span><span class="punctuation">(</span>tpms01A<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;TPM11A范围:&quot;</span><span class="punctuation">,</span> <span class="built_in">range</span><span class="punctuation">(</span>tpms11A<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;log2TPM范围:&quot;</span><span class="punctuation">,</span> <span class="built_in">range</span><span class="punctuation">(</span>tpms_log2<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存log2转换数据</span></span><br><span class="line">write.table<span class="punctuation">(</span>tpms_log2<span class="punctuation">,</span> <span class="string">&quot;tpms_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>tpms01A_log2<span class="punctuation">,</span> <span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>tpms11A_log2<span class="punctuation">,</span> <span class="string">&quot;tpms11A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;TCGA数据预处理完成！\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;生成的文件:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- counts01A.txt: 肿瘤样本raw counts\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- counts11A.txt: 正常样本raw counts\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- tpms01A_log2.txt: 肿瘤样本log2(TPM+1)\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- tpms11A_log2.txt: 正常样本log2(TPM+1)\n&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>整体研究意义</strong>：这套流程完成了从TCGA数据库下载原始RNA-seq数据到生成可用于下游分析的标准化表达矩阵的全过程，为后续的差异表达分析、生存分析和功能富集分析提供了高质量的数据基础。</p>
<h1 id="生信速通之二-ESTIMATE生存分析"><a href="#生信速通之二-ESTIMATE生存分析" class="headerlink" title="生信速通之二 ESTIMATE生存分析"></a>生信速通之二 ESTIMATE生存分析</h1><h2 id="第一部分：ESTIMATE评分计算"><a href="#第一部分：ESTIMATE评分计算" class="headerlink" title="第一部分：ESTIMATE评分计算"></a>第一部分：ESTIMATE评分计算</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### Day3 ####</span></span><br><span class="line"><span class="comment">#### ESTIMATE ####</span></span><br><span class="line"><span class="comment"># 计算患者免疫评分与肿瘤纯度</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/ESTIMATE&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次性加载所有需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>utils<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>estimate<span class="punctuation">)</span>    <span class="comment"># 用于计算ESTIMATE评分</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span>   <span class="comment"># 数据清洗和整理</span></span><br><span class="line">library<span class="punctuation">(</span>survival<span class="punctuation">)</span>    <span class="comment"># 生存分析</span></span><br><span class="line">library<span class="punctuation">(</span>survminer<span class="punctuation">)</span>   <span class="comment"># 生存分析可视化</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取肿瘤患者01A表达谱</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                  check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：这部分是肿瘤微环境分析，通过ESTIMATE算法计算肿瘤纯度、免疫细胞和基质细胞评分。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>setwd()</code>: 设置工作目录</li>
<li><code>read.table()</code>: 读取表格文件，参数<code>row.names=1</code>表示第一列作为行名</li>
<li><code>check.names=F</code>: 保持列名原样，不自动修改特殊字符</li>
</ul>
<hr>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算免疫评分</span></span><br><span class="line">filterCommonGenes<span class="punctuation">(</span>input.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  output.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  id <span class="operator">=</span> <span class="string">&quot;GeneSymbol&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">estimateScore<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">              platform <span class="operator">=</span> <span class="string">&quot;affymetrix&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：ESTIMATE算法需要特定的基因集，第一步过滤共同基因，第二步计算评分。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li>这些都是<code>estimate</code>包的专用函数</li>
<li><code>platform=&quot;affymetrix&quot;</code>: 指定芯片平台类型</li>
</ul>
<hr>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提取结果并整理</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span>  <span class="comment"># 删除第一列</span></span><br><span class="line">colnames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span>  <span class="comment"># 第一行作为列名</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>t<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">[</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span>  <span class="comment"># 转置并删除第一行</span></span><br><span class="line">rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> colnames<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span>  <span class="comment"># 设置样本名为行名</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：整理ESTIMATE输出结果，使其成为标准的样本×评分的数据框。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>[,-1]</code>: 删除第一列</li>
<li><code>t()</code>: 矩阵转置</li>
<li><code>colnames()</code>, <code>rownames()</code>: 设置列名和行名</li>
</ul>
<hr>
<h2 id="第二部分：生存数据整合"><a href="#第二部分：生存数据整合" class="headerlink" title="第二部分：生存数据整合"></a>第二部分：生存数据整合</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### 生存信息整理 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../Survival_data&quot;</span><span class="punctuation">)</span>  <span class="comment"># 切换到上级目录的Survival_data文件夹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理生存数据</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span>  <span class="comment"># 只保留第2-3列</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival <span class="operator">%&gt;%</span> rownames_to_column<span class="punctuation">(</span><span class="string">&#x27;sample&#x27;</span><span class="punctuation">)</span>  <span class="comment"># 行名转为列</span></span><br><span class="line">survival<span class="operator">$</span>name <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span>survival<span class="operator">$</span>sample<span class="punctuation">,</span> <span class="string">&#x27;A&#x27;</span><span class="punctuation">)</span>  <span class="comment"># 添加&#x27;A&#x27;后缀匹配表达数据</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：临床生存数据通常需要与分子数据进行样本匹配。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>%&gt;%</code>: 管道操作符，将左侧结果传递给右侧函数</li>
<li><code>rownames_to_column()</code>: 将行名转为数据框的一列</li>
<li><code>paste0()</code>: 字符串连接函数</li>
</ul>
<hr>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 合并生存信息与表达谱</span></span><br><span class="line">tpms01A_log2 <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                           check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">a <span class="operator">&lt;-</span> intersect<span class="punctuation">(</span>colnames<span class="punctuation">(</span>tpms01A_log2<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>survival<span class="punctuation">)</span><span class="punctuation">)</span>  <span class="comment"># 找共同样本</span></span><br><span class="line">exp_01A <span class="operator">&lt;-</span> tpms01A_log2<span class="punctuation">[</span><span class="punctuation">,</span>a<span class="punctuation">]</span>  <span class="comment"># 提取共同样本的表达数据</span></span><br><span class="line">surv_01A <span class="operator">&lt;-</span> survival<span class="punctuation">[</span>a<span class="punctuation">,</span><span class="punctuation">]</span>     <span class="comment"># 提取共同样本的生存数据</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：确保表达数据和生存数据的样本完全对应，避免样本不匹配问题。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>intersect()</code>: 取两个向量的交集</li>
<li><code>[a]</code>: 按向量a中的元素进行子集选择</li>
</ul>
<hr>
<h2 id="第三部分：生存分析"><a href="#第三部分：生存分析" class="headerlink" title="第三部分：生存分析"></a>第三部分：生存分析</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### 根据ESTIMATE_result高低组做生存分析 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../survival&quot;</span><span class="punctuation">)</span></span><br><span class="line">surv <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;ESTIMATE_result_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                   check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">surv<span class="operator">$</span>OS.time <span class="operator">&lt;-</span> surv<span class="operator">$</span>OS.time <span class="operator">/</span> <span class="number">365</span>  <span class="comment"># 将天数转换为年</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：将生存时间从天数转换为年，便于理解和可视化。</p>
<hr>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建生存分析函数避免重复代码</span></span><br><span class="line">perform_survival_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">,</span> score_type<span class="punctuation">,</span> title<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 根据中位数分组</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&gt;</span> median<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Low&quot;</span><span class="punctuation">)</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>data<span class="operator">$</span>group<span class="punctuation">,</span> levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 生存差异检验</span></span><br><span class="line">  fitd <span class="operator">&lt;-</span> survdiff<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> data<span class="punctuation">,</span> na.action <span class="operator">=</span> na.exclude<span class="punctuation">)</span></span><br><span class="line">  pValue <span class="operator">&lt;-</span> 1 <span class="operator">-</span> pchisq<span class="punctuation">(</span>fitd<span class="operator">$</span>chisq<span class="punctuation">,</span> <span class="built_in">length</span><span class="punctuation">(</span>fitd<span class="operator">$</span>n<span class="punctuation">)</span> <span class="operator">-</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 拟合生存曲线</span></span><br><span class="line">  fit <span class="operator">&lt;-</span> survfit<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> data<span class="punctuation">)</span></span><br><span class="line">  p.lab <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;P&quot;</span><span class="punctuation">,</span> ifelse<span class="punctuation">(</span>pValue <span class="operator">&lt;</span> <span class="number">0.001</span><span class="punctuation">,</span> <span class="string">&quot; &lt; 0.001&quot;</span><span class="punctuation">,</span> paste0<span class="punctuation">(</span><span class="string">&quot; = &quot;</span><span class="punctuation">,</span> <span class="built_in">round</span><span class="punctuation">(</span>pValue<span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制生存曲线</span></span><br><span class="line">  ggsurvplot<span class="punctuation">(</span>fit<span class="punctuation">,</span></span><br><span class="line">             data <span class="operator">=</span> data<span class="punctuation">,</span></span><br><span class="line">             pval <span class="operator">=</span> p.lab<span class="punctuation">,</span></span><br><span class="line">             conf.int <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span>  <span class="comment"># 显示置信区间</span></span><br><span class="line">             risk.table <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span>  <span class="comment"># 显示风险表</span></span><br><span class="line">             palette <span class="operator">=</span> <span class="string">&quot;jco&quot;</span><span class="punctuation">,</span>  <span class="comment"># JCO杂志配色</span></span><br><span class="line">             legend.title <span class="operator">=</span> title<span class="punctuation">,</span></span><br><span class="line">             surv.median.line <span class="operator">=</span> <span class="string">&quot;hv&quot;</span><span class="punctuation">,</span>  <span class="comment"># 显示中位生存期</span></span><br><span class="line">             ylab <span class="operator">=</span> <span class="string">&quot;Survival probability (%)&quot;</span><span class="punctuation">,</span></span><br><span class="line">             xlab <span class="operator">=</span> <span class="string">&quot;Time (Years)&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：封装生存分析流程，便于对多个评分重复分析。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>function()</code>: 定义函数</li>
<li><code>data[[score_type]]</code>: 动态选择数据框的列</li>
<li><code>Surv()</code>: 创建生存对象</li>
<li><code>survdiff()</code>: 生存差异检验（log-rank test）</li>
<li><code>survfit()</code>: 拟合生存曲线</li>
</ul>
<hr>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对三个评分进行生存分析</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">)</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">)</span> </span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：分别分析免疫评分、基质评分和总评分对患者生存的影响。</p>
<p><strong>整体研究意义</strong>：通过这种分析可以评估肿瘤微环境特征（免疫细胞浸润、基质成分等）对肺癌患者预后的影响，为免疫治疗提供理论依据。</p>
<h2 id="完整代码-1"><a href="#完整代码-1" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### ESTIMATE ####</span></span><br><span class="line"><span class="comment"># 计算患者免疫评分与肿瘤纯度</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/ESTIMATE&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次性加载所有需要的包</span></span><br><span class="line">library<span class="punctuation">(</span>utils<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>estimate<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>survival<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>survminer<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取肿瘤患者01A表达谱</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                  check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算免疫评分</span></span><br><span class="line">filterCommonGenes<span class="punctuation">(</span>input.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  output.f <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  id <span class="operator">=</span> <span class="string">&quot;GeneSymbol&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">estimateScore<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.gct&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">              platform <span class="operator">=</span> <span class="string">&quot;affymetrix&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取结果并整理</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2_estimate_score.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="punctuation">,</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">]</span></span><br><span class="line">colnames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> ESTIMATE_result<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>t<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">[</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span> <span class="operator">&lt;-</span> colnames<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">            row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 生存信息整理 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../Survival_data&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载生存信息</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line">survival <span class="operator">&lt;-</span> survival <span class="operator">%&gt;%</span> rownames_to_column<span class="punctuation">(</span><span class="string">&#x27;sample&#x27;</span><span class="punctuation">)</span></span><br><span class="line">survival<span class="operator">$</span>name <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span>survival<span class="operator">$</span>sample<span class="punctuation">,</span> <span class="string">&#x27;A&#x27;</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>substring<span class="punctuation">(</span>survival<span class="operator">$</span>name<span class="punctuation">,</span> <span class="number">14</span><span class="punctuation">,</span> <span class="number">16</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>survival<span class="punctuation">)</span> <span class="operator">&lt;-</span> survival<span class="operator">$</span>name</span><br><span class="line">survival <span class="operator">&lt;-</span> survival<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">2</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并生存信息与表达谱</span></span><br><span class="line">tpms01A_log2 <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                           check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">a <span class="operator">&lt;-</span> intersect<span class="punctuation">(</span>colnames<span class="punctuation">(</span>tpms01A_log2<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>survival<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>substr<span class="punctuation">(</span>a<span class="punctuation">,</span> <span class="number">14</span><span class="punctuation">,</span> <span class="number">16</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">exp_01A <span class="operator">&lt;-</span> tpms01A_log2<span class="punctuation">[</span><span class="punctuation">,</span>a<span class="punctuation">]</span></span><br><span class="line">surv_01A <span class="operator">&lt;-</span> survival<span class="punctuation">[</span>a<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">exp_01A <span class="operator">&lt;-</span> exp_01A <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>exp_01A<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>surv_01A<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">exp_surv_01A <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>surv_01A<span class="punctuation">,</span> exp_01A<span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>exp_surv_01A<span class="punctuation">,</span> <span class="string">&quot;exp_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span></span><br><span class="line">            col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并生存信息与ESTIMATE</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>surv_01A<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">ESTIMATE_result_surv_01A <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>surv_01A<span class="punctuation">,</span> ESTIMATE_result<span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>ESTIMATE_result_surv_01A<span class="punctuation">,</span> <span class="string">&quot;ESTIMATE_result_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span></span><br><span class="line">            row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 根据ESTIMATE_result高低组做生存分析 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;../survival&quot;</span><span class="punctuation">)</span></span><br><span class="line">surv <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;ESTIMATE_result_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                   check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">surv<span class="operator">$</span>OS.time <span class="operator">&lt;-</span> surv<span class="operator">$</span>OS.time <span class="operator">/</span> <span class="number">365</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建生存分析函数避免重复代码</span></span><br><span class="line">perform_survival_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">,</span> score_type<span class="punctuation">,</span> title<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&gt;</span> median<span class="punctuation">(</span>data<span class="punctuation">[[</span>score_type<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Low&quot;</span><span class="punctuation">)</span></span><br><span class="line">  data<span class="operator">$</span>group <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>data<span class="operator">$</span>group<span class="punctuation">,</span> levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  fitd <span class="operator">&lt;-</span> survdiff<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span></span><br><span class="line">                   data <span class="operator">=</span> data<span class="punctuation">,</span></span><br><span class="line">                   na.action <span class="operator">=</span> na.exclude<span class="punctuation">)</span></span><br><span class="line">  pValue <span class="operator">&lt;-</span> 1 <span class="operator">-</span> pchisq<span class="punctuation">(</span>fitd<span class="operator">$</span>chisq<span class="punctuation">,</span> <span class="built_in">length</span><span class="punctuation">(</span>fitd<span class="operator">$</span>n<span class="punctuation">)</span> <span class="operator">-</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  fit <span class="operator">&lt;-</span> survfit<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> data<span class="punctuation">)</span></span><br><span class="line">  p.lab <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;P&quot;</span><span class="punctuation">,</span> ifelse<span class="punctuation">(</span>pValue <span class="operator">&lt;</span> <span class="number">0.001</span><span class="punctuation">,</span> <span class="string">&quot; &lt; 0.001&quot;</span><span class="punctuation">,</span> paste0<span class="punctuation">(</span><span class="string">&quot; = &quot;</span><span class="punctuation">,</span> <span class="built_in">round</span><span class="punctuation">(</span>pValue<span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  ggsurvplot<span class="punctuation">(</span>fit<span class="punctuation">,</span></span><br><span class="line">             data <span class="operator">=</span> data<span class="punctuation">,</span></span><br><span class="line">             pval <span class="operator">=</span> p.lab<span class="punctuation">,</span></span><br><span class="line">             conf.int <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             risk.table <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             risk.table.col <span class="operator">=</span> <span class="string">&quot;strata&quot;</span><span class="punctuation">,</span></span><br><span class="line">             palette <span class="operator">=</span> <span class="string">&quot;jco&quot;</span><span class="punctuation">,</span></span><br><span class="line">             legend.labs <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">             size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">             xlim <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">20</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">             break.time.by <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">             legend.title <span class="operator">=</span> title<span class="punctuation">,</span></span><br><span class="line">             surv.median.line <span class="operator">=</span> <span class="string">&quot;hv&quot;</span><span class="punctuation">,</span></span><br><span class="line">             ylab <span class="operator">=</span> <span class="string">&quot;Survival probability (%)&quot;</span><span class="punctuation">,</span></span><br><span class="line">             xlab <span class="operator">=</span> <span class="string">&quot;Time (Years)&quot;</span><span class="punctuation">,</span></span><br><span class="line">             ncensor.plot <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">             ncensor.plot.height <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span></span><br><span class="line">             risk.table.y.text <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对三个评分进行生存分析</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">)</span></span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">)</span> </span><br><span class="line">perform_survival_analysis<span class="punctuation">(</span>surv<span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ESTIMATEScore&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<h1 id="生信速通之三-TCGA临床信息整理"><a href="#生信速通之三-TCGA临床信息整理" class="headerlink" title="生信速通之三 TCGA临床信息整理"></a>生信速通之三 TCGA临床信息整理</h1><p>您说得对！我将按照正确的格式重新组织，在分段解释时附着对应的代码。</p>
<h2 id="TCGA临床数据整理代码详解"><a href="#TCGA临床数据整理代码详解" class="headerlink" title="TCGA临床数据整理代码详解"></a>TCGA临床数据整理代码详解</h2><h3 id="第一部分：数据加载和基础处理"><a href="#第一部分：数据加载和基础处理" class="headerlink" title="第一部分：数据加载和基础处理"></a>第一部分：数据加载和基础处理</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### Day4 ####</span></span><br><span class="line"><span class="comment">#### 整理TCGA临床信息 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/clinical&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;luad.gdc_2022.rda&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取临床信息</span></span><br><span class="line">clinical <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>expquery2<span class="operator">@</span>colData<span class="punctuation">)</span> <span class="operator">%&gt;%</span>   </span><br><span class="line">  .<span class="punctuation">[</span><span class="operator">!</span>duplicated<span class="punctuation">(</span>.<span class="operator">$</span>sample<span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取需要的临床信息数据</span></span><br><span class="line">clinical <span class="operator">&lt;-</span> clinical<span class="punctuation">[</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;gender&quot;</span><span class="punctuation">,</span> <span class="string">&quot;age_at_index&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_stage&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="string">&quot;ajcc_pathologic_t&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_n&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_m&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：从TCGA数据库的复杂数据结构中提取核心临床变量，用于后续的生存分析和临床特征关联研究。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>load()</code>: 加载R数据文件，通常包含TCGA的SummarizedExperiment对象</li>
<li><code>expquery2@colData</code>: 访问SummarizedExperiment对象的列数据（样本信息）</li>
<li><code>%&gt;% .[!duplicated(.$sample),]</code>: 管道操作符结合子集选择，去除重复样本</li>
</ul>
<hr>
<h3 id="第二部分：数据质量检查"><a href="#第二部分：数据质量检查" class="headerlink" title="第二部分：数据质量检查"></a>第二部分：数据质量检查</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 批量检查变量类型和频数</span></span><br><span class="line">check_clinical_variables <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">,</span> vars<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="keyword">for</span><span class="punctuation">(</span>var <span class="keyword">in</span> vars<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    cat<span class="punctuation">(</span><span class="string">&quot;Variable:&quot;</span><span class="punctuation">,</span> var<span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">    cat<span class="punctuation">(</span><span class="string">&quot;Class:&quot;</span><span class="punctuation">,</span> <span class="built_in">class</span><span class="punctuation">(</span>data<span class="punctuation">[[</span>var<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">    cat<span class="punctuation">(</span><span class="string">&quot;Table:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">    print<span class="punctuation">(</span>table<span class="punctuation">(</span>data<span class="punctuation">[[</span>var<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> useNA <span class="operator">=</span> <span class="string">&quot;always&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">    cat<span class="punctuation">(</span><span class="string">&quot;\n&quot;</span> <span class="operator">+</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="string">&quot;-&quot;</span><span class="punctuation">,</span> <span class="number">50</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="string">&quot;\n\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查所有临床变量</span></span><br><span class="line">clinical_vars <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;gender&quot;</span><span class="punctuation">,</span> <span class="string">&quot;age_at_index&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_stage&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="string">&quot;ajcc_pathologic_t&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_n&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_m&quot;</span><span class="punctuation">)</span></span><br><span class="line">check_clinical_variables<span class="punctuation">(</span>clinical<span class="punctuation">,</span> clinical_vars<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：系统检查每个临床变量的数据类型和分布，确保数据质量，发现可能的编码问题或缺失值。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>function()</code>: 创建可重用的函数</li>
<li><code>data[[var]]</code>: 动态访问数据框的列</li>
<li><code>class()</code>: 获取变量类型</li>
<li><code>table(useNA = &quot;always&quot;)</code>: 制作频数表并显示缺失值</li>
</ul>
<hr>
<h3 id="第三部分：数据清洗和标准化"><a href="#第三部分：数据清洗和标准化" class="headerlink" title="第三部分：数据清洗和标准化"></a>第三部分：数据清洗和标准化</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 批量清理临床分期数据</span></span><br><span class="line">clean_clinical_data <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 移除分期中的A/B子分类</span></span><br><span class="line">  data<span class="operator">$</span>ajcc_pathologic_stage <span class="operator">&lt;-</span> gsub<span class="punctuation">(</span><span class="string">&quot;[AB]&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> data<span class="operator">$</span>ajcc_pathologic_stage<span class="punctuation">)</span></span><br><span class="line">  <span class="comment"># 移除T/N/M分期中的a/b子分类</span></span><br><span class="line">  data<span class="operator">$</span>ajcc_pathologic_t <span class="operator">&lt;-</span> gsub<span class="punctuation">(</span><span class="string">&quot;[ab]&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> data<span class="operator">$</span>ajcc_pathologic_t<span class="punctuation">)</span></span><br><span class="line">  data<span class="operator">$</span>ajcc_pathologic_n <span class="operator">&lt;-</span> gsub<span class="punctuation">(</span><span class="string">&quot;[ab]&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> data<span class="operator">$</span>ajcc_pathologic_n<span class="punctuation">)</span> </span><br><span class="line">  data<span class="operator">$</span>ajcc_pathologic_m <span class="operator">&lt;-</span> gsub<span class="punctuation">(</span><span class="string">&quot;[ab]&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> data<span class="operator">$</span>ajcc_pathologic_m<span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>data<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">clinical <span class="operator">&lt;-</span> clean_clinical_data<span class="punctuation">(</span>clinical<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取01A临床数据</span></span><br><span class="line">rownames<span class="punctuation">(</span>clinical<span class="punctuation">)</span> <span class="operator">&lt;-</span> substring<span class="punctuation">(</span>rownames<span class="punctuation">(</span>clinical<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">16</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：统一AJCC癌症分期系统的编码，简化分期类别，便于后续统计分析。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>gsub(&quot;[AB]&quot;, &quot;&quot;, x)</code>: 使用正则表达式替换，<code>[AB]</code>匹配A或B字符</li>
<li><code>substring(x, 1, 16)</code>: 提取字符串的前16个字符，用于样本ID匹配</li>
</ul>
<hr>
<h3 id="第四部分：表达数据整合"><a href="#第四部分：表达数据整合" class="headerlink" title="第四部分：表达数据整合"></a>第四部分：表达数据整合</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 将基因表达谱和临床数据合并并保存</span></span><br><span class="line">exp01A <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                     check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">clinical01A <span class="operator">&lt;-</span> clinical<span class="punctuation">[</span>colnames<span class="punctuation">(</span>exp01A<span class="punctuation">)</span><span class="punctuation">,</span> <span class="punctuation">]</span>   </span><br><span class="line">exp01A <span class="operator">&lt;-</span> exp01A <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证样本匹配</span></span><br><span class="line"><span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span>identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>clinical01A<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>exp01A<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  warning<span class="punctuation">(</span><span class="string">&quot;临床数据和表达数据样本不匹配！&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="punctuation">&#123;</span></span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&quot;临床数据和表达数据样本完全匹配\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">clinical.expr01A <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>clinical01A<span class="punctuation">,</span> exp01A<span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>clinical.expr01A<span class="punctuation">,</span> <span class="string">&quot;clinical.expr01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：创建临床-表达联合数据集，用于研究基因表达与临床特征的关联。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>clinical[colnames(exp01A), ]</code>: 按表达数据的列名（样本）提取对应的临床数据</li>
<li><code>t()</code>: 矩阵转置，将基因×样本转为样本×基因</li>
<li><code>cbind()</code>: 按列合并数据框</li>
<li><code>identical()</code>: 精确比较两个对象是否完全相同</li>
</ul>
<hr>
<h3 id="第五部分：ESTIMATE评分整合"><a href="#第五部分：ESTIMATE评分整合" class="headerlink" title="第五部分：ESTIMATE评分整合"></a>第五部分：ESTIMATE评分整合</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 将ESTIMATE_result和临床数据合并并保存</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证样本匹配</span></span><br><span class="line"><span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span>identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>clinical01A<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  warning<span class="punctuation">(</span><span class="string">&quot;临床数据和ESTIMATE结果样本不匹配！&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="punctuation">&#123;</span></span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&quot;临床数据和ESTIMATE结果样本完全匹配\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">clinical.ESTIMATE_result01A <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>clinical01A<span class="punctuation">,</span> ESTIMATE_result<span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>clinical.ESTIMATE_result01A<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;clinical.ESTIMATE_result01A.csv&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：整合肿瘤微环境评分与临床信息，用于研究免疫/基质特征与临床预后的关系。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>write.csv()</code>: 写入CSV格式文件，更适合Excel打开查看</li>
</ul>
<hr>
<h3 id="第六部分：处理完成提示"><a href="#第六部分：处理完成提示" class="headerlink" title="第六部分：处理完成提示"></a>第六部分：处理完成提示</h3><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;数据处理完成！\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;生成的文件：\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- clinical.expr01A.txt: 临床数据+表达谱\n&quot;</span><span class="punctuation">)</span> </span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- clinical.ESTIMATE_result01A.csv: 临床数据+ESTIMATE评分\n&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：提供清晰的流程结束提示，帮助用户确认输出文件。</p>
<hr>
<h2 id="完整优化代码"><a href="#完整优化代码" class="headerlink" title="完整优化代码"></a>完整优化代码</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### Day4 ####</span></span><br><span class="line"><span class="comment">#### 整理TCGA临床信息 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/clinical&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">load<span class="punctuation">(</span><span class="string">&quot;luad.gdc_2022.rda&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取临床信息</span></span><br><span class="line">clinical <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>expquery2<span class="operator">@</span>colData<span class="punctuation">)</span> <span class="operator">%&gt;%</span>   </span><br><span class="line">  .<span class="punctuation">[</span><span class="operator">!</span>duplicated<span class="punctuation">(</span>.<span class="operator">$</span>sample<span class="punctuation">)</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取需要的临床信息数据</span></span><br><span class="line">clinical <span class="operator">&lt;-</span> clinical<span class="punctuation">[</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;gender&quot;</span><span class="punctuation">,</span> <span class="string">&quot;age_at_index&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_stage&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="string">&quot;ajcc_pathologic_t&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_n&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_m&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量检查变量类型和频数</span></span><br><span class="line">check_clinical_variables <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">,</span> vars<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="keyword">for</span><span class="punctuation">(</span>var <span class="keyword">in</span> vars<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    cat<span class="punctuation">(</span><span class="string">&quot;Variable:&quot;</span><span class="punctuation">,</span> var<span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">    cat<span class="punctuation">(</span><span class="string">&quot;Class:&quot;</span><span class="punctuation">,</span> <span class="built_in">class</span><span class="punctuation">(</span>data<span class="punctuation">[[</span>var<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">    cat<span class="punctuation">(</span><span class="string">&quot;Table:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">    print<span class="punctuation">(</span>table<span class="punctuation">(</span>data<span class="punctuation">[[</span>var<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> useNA <span class="operator">=</span> <span class="string">&quot;always&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">    cat<span class="punctuation">(</span><span class="string">&quot;\n&quot;</span> <span class="operator">+</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="string">&quot;-&quot;</span><span class="punctuation">,</span> <span class="number">50</span><span class="punctuation">)</span> <span class="operator">+</span> <span class="string">&quot;\n\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查所有临床变量</span></span><br><span class="line">clinical_vars <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;gender&quot;</span><span class="punctuation">,</span> <span class="string">&quot;age_at_index&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_stage&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="string">&quot;ajcc_pathologic_t&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_n&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ajcc_pathologic_m&quot;</span><span class="punctuation">)</span></span><br><span class="line">check_clinical_variables<span class="punctuation">(</span>clinical<span class="punctuation">,</span> clinical_vars<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量清理临床分期数据</span></span><br><span class="line">clean_clinical_data <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>data<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 移除分期中的A/B子分类</span></span><br><span class="line">  data<span class="operator">$</span>ajcc_pathologic_stage <span class="operator">&lt;-</span> gsub<span class="punctuation">(</span><span class="string">&quot;[AB]&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> data<span class="operator">$</span>ajcc_pathologic_stage<span class="punctuation">)</span></span><br><span class="line">  <span class="comment"># 移除T/N/M分期中的a/b子分类</span></span><br><span class="line">  data<span class="operator">$</span>ajcc_pathologic_t <span class="operator">&lt;-</span> gsub<span class="punctuation">(</span><span class="string">&quot;[ab]&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> data<span class="operator">$</span>ajcc_pathologic_t<span class="punctuation">)</span></span><br><span class="line">  data<span class="operator">$</span>ajcc_pathologic_n <span class="operator">&lt;-</span> gsub<span class="punctuation">(</span><span class="string">&quot;[ab]&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> data<span class="operator">$</span>ajcc_pathologic_n<span class="punctuation">)</span> </span><br><span class="line">  data<span class="operator">$</span>ajcc_pathologic_m <span class="operator">&lt;-</span> gsub<span class="punctuation">(</span><span class="string">&quot;[ab]&quot;</span><span class="punctuation">,</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span> data<span class="operator">$</span>ajcc_pathologic_m<span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>data<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">clinical <span class="operator">&lt;-</span> clean_clinical_data<span class="punctuation">(</span>clinical<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取01A临床数据</span></span><br><span class="line">rownames<span class="punctuation">(</span>clinical<span class="punctuation">)</span> <span class="operator">&lt;-</span> substring<span class="punctuation">(</span>rownames<span class="punctuation">(</span>clinical<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">16</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 将基因表达谱和临床数据合并并保存</span></span><br><span class="line">exp01A <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                     check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">clinical01A <span class="operator">&lt;-</span> clinical<span class="punctuation">[</span>colnames<span class="punctuation">(</span>exp01A<span class="punctuation">)</span><span class="punctuation">,</span> <span class="punctuation">]</span>   </span><br><span class="line">exp01A <span class="operator">&lt;-</span> exp01A <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证样本匹配</span></span><br><span class="line"><span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span>identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>clinical01A<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>exp01A<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  warning<span class="punctuation">(</span><span class="string">&quot;临床数据和表达数据样本不匹配！&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="punctuation">&#123;</span></span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&quot;临床数据和表达数据样本完全匹配\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">clinical.expr01A <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>clinical01A<span class="punctuation">,</span> exp01A<span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>clinical.expr01A<span class="punctuation">,</span> <span class="string">&quot;clinical.expr01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> </span><br><span class="line">            row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span> col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 将ESTIMATE_result和临床数据合并并保存</span></span><br><span class="line">ESTIMATE_result <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;../ESTIMATE/ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                              row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证样本匹配</span></span><br><span class="line"><span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span>identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>clinical01A<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>ESTIMATE_result<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  warning<span class="punctuation">(</span><span class="string">&quot;临床数据和ESTIMATE结果样本不匹配！&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="punctuation">&#123;</span></span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&quot;临床数据和ESTIMATE结果样本完全匹配\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">clinical.ESTIMATE_result01A <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>clinical01A<span class="punctuation">,</span> ESTIMATE_result<span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>clinical.ESTIMATE_result01A<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;clinical.ESTIMATE_result01A.csv&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;数据处理完成！\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;生成的文件：\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- clinical.expr01A.txt: 临床数据+表达谱\n&quot;</span><span class="punctuation">)</span> </span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- clinical.ESTIMATE_result01A.csv: 临床数据+ESTIMATE评分\n&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>整体研究意义</strong>：这个流程创建了两个关键数据集用于多组学分析：</p>
<ol>
<li><strong>临床+表达数据</strong>：研究基因表达与临床特征的关联</li>
<li><strong>临床+ESTIMATE评分</strong>：研究肿瘤微环境与临床预后的关系</li>
</ol>
<h1 id="生信速通之四-TCGA差异分析和富集分析"><a href="#生信速通之四-TCGA差异分析和富集分析" class="headerlink" title="生信速通之四 TCGA差异分析和富集分析"></a>生信速通之四 TCGA差异分析和富集分析</h1><h2 id="第一部分：免疫评分差异分析"><a href="#第一部分：免疫评分差异分析" class="headerlink" title="第一部分：免疫评分差异分析"></a>第一部分：免疫评分差异分析</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####差异分析####</span></span><br><span class="line"><span class="comment">####免疫评分####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;Immune_DEG&quot;</span><span class="punctuation">)</span> </span><br><span class="line">library<span class="punctuation">(</span>BiocManager<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#BiocManager::install(&#x27;DESeq2&#x27;)</span></span><br><span class="line">library<span class="punctuation">(</span>DESeq2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#TCGA差异分析用counts来做 因为是把01A患者分组做差异分析所以读取01A</span></span><br><span class="line">counts_01A <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;counts01A.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#因为是用免疫评分分组所以读取ESTIMATE_result</span></span><br><span class="line">estimate <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#整理分组信息</span></span><br><span class="line">x <span class="operator">&lt;-</span> <span class="string">&quot;ImmuneScore&quot;</span></span><br><span class="line">med <span class="operator">&lt;-</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>median<span class="punctuation">(</span>estimate<span class="punctuation">[</span><span class="punctuation">,</span>x<span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">estimate <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>t<span class="punctuation">(</span>estimate<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>colnames<span class="punctuation">(</span>counts_01A<span class="punctuation">)</span><span class="punctuation">,</span>colnames<span class="punctuation">(</span>estimate<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">conditions<span class="operator">=</span>data.frame<span class="punctuation">(</span>sample<span class="operator">=</span>colnames<span class="punctuation">(</span>counts_01A<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                      group<span class="operator">=</span>factor<span class="punctuation">(</span>ifelse<span class="punctuation">(</span>estimate<span class="punctuation">[</span>x<span class="punctuation">,</span><span class="punctuation">]</span><span class="operator">&gt;</span>med<span class="punctuation">,</span><span class="string">&quot;high&quot;</span><span class="punctuation">,</span><span class="string">&quot;low&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;low&quot;</span><span class="punctuation">,</span><span class="string">&quot;high&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  column_to_rownames<span class="punctuation">(</span><span class="string">&quot;sample&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：根据免疫评分中位数将患者分为高免疫组和低免疫组，为差异表达分析准备分组信息。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>median()</code>: 计算中位数作为分组阈值</li>
<li><code>ifelse()</code>: 条件判断，根据评分高低分组</li>
<li><code>factor(levels = c(&quot;low&quot;,&quot;high&quot;))</code>: 设置因子水平，确保low组作为参照</li>
</ul>
<hr>
<h2 id="第二部分：DESeq2差异分析流程"><a href="#第二部分：DESeq2差异分析流程" class="headerlink" title="第二部分：DESeq2差异分析流程"></a>第二部分：DESeq2差异分析流程</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#差异分析准备工作</span></span><br><span class="line">dds <span class="operator">&lt;-</span> DESeqDataSetFromMatrix<span class="punctuation">(</span></span><br><span class="line">  countData <span class="operator">=</span> counts_01A<span class="punctuation">,</span></span><br><span class="line">  colData <span class="operator">=</span> conditions<span class="punctuation">,</span></span><br><span class="line">  design <span class="operator">=</span> <span class="operator">~</span> group<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#开始差异分析</span></span><br><span class="line">dds <span class="operator">&lt;-</span> DESeq<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#这句很重要</span></span><br><span class="line">resultsNames<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#提取结果</span></span><br><span class="line">res <span class="operator">&lt;-</span> results<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>res<span class="punctuation">,</span>file<span class="operator">=</span><span class="string">&quot;DEG_ImmuneScore.Rda&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：使用DESeq2进行RNA-seq数据的差异表达分析，识别高免疫组vs低免疫组的差异表达基因。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>DESeqDataSetFromMatrix()</code>: 创建DESeq2数据对象</li>
<li><code>DESeq()</code>: 执行差异分析流程（标准化、离散度估计、统计检验）</li>
<li><code>resultsNames()</code>: 查看可提取的结果类型</li>
<li><code>results()</code>: 提取差异分析结果</li>
</ul>
<hr>
<h2 id="第三部分：差异基因热图可视化"><a href="#第三部分：差异基因热图可视化" class="headerlink" title="第三部分：差异基因热图可视化"></a>第三部分：差异基因热图可视化</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####热图绘制####</span></span><br><span class="line">DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>res<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#读取表达谱</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#添加上下调信息</span></span><br><span class="line">logFC_cutoff <span class="operator">&lt;-</span> 1</span><br><span class="line">type1 <span class="operator">=</span> <span class="punctuation">(</span>DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">)</span><span class="operator">&amp;</span><span class="punctuation">(</span>DEG<span class="operator">$</span>log2FoldChange <span class="operator">&lt;</span> <span class="operator">-</span>logFC_cutoff<span class="punctuation">)</span></span><br><span class="line">type2 <span class="operator">=</span> <span class="punctuation">(</span>DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">)</span><span class="operator">&amp;</span><span class="punctuation">(</span>DEG<span class="operator">$</span>log2FoldChange <span class="operator">&gt;</span> logFC_cutoff<span class="punctuation">)</span></span><br><span class="line">DEG<span class="operator">$</span>change <span class="operator">=</span> ifelse<span class="punctuation">(</span>type1<span class="punctuation">,</span><span class="string">&quot;DOWN&quot;</span><span class="punctuation">,</span>ifelse<span class="punctuation">(</span>type2<span class="punctuation">,</span><span class="string">&quot;UP&quot;</span><span class="punctuation">,</span><span class="string">&quot;NOT&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>DEG<span class="operator">$</span>change<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">library<span class="punctuation">(</span>pheatmap<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#提取差异基因表达谱</span></span><br><span class="line">a <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>DEG<span class="punctuation">,</span>change <span class="operator">==</span> <span class="string">&#x27;UP&#x27;</span><span class="punctuation">)</span></span><br><span class="line">b <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>DEG<span class="punctuation">,</span>change <span class="operator">==</span> <span class="string">&#x27;DOWN&#x27;</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">c</span> <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span>a<span class="punctuation">,</span>b<span class="punctuation">)</span></span><br><span class="line">d <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">)</span></span><br><span class="line">exp_diff <span class="operator">&lt;-</span> <span class="built_in">exp</span><span class="punctuation">[</span>d<span class="punctuation">,</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：筛选显著差异基因（|logFC|&gt;1且padj&lt;0.05）并提取其表达数据用于热图展示。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>padj</code>: 校正后的p值，控制假阳性率</li>
<li><code>log2FoldChange</code>: 对数倍变化，表示表达量差异程度</li>
<li><code>filter()</code>: 按条件筛选数据行</li>
</ul>
<hr>
<h2 id="第四部分：热图绘制和美化"><a href="#第四部分：热图绘制和美化" class="headerlink" title="第四部分：热图绘制和美化"></a>第四部分：热图绘制和美化</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#设置分组信息</span></span><br><span class="line">annotation_col <span class="operator">&lt;-</span> conditions</span><br><span class="line"><span class="comment">#对exp_diff 列的顺序进行处理</span></span><br><span class="line">a <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>annotation_col<span class="punctuation">,</span>group <span class="operator">==</span> <span class="string">&#x27;high&#x27;</span><span class="punctuation">)</span></span><br><span class="line">b <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>annotation_col<span class="punctuation">,</span>group <span class="operator">==</span> <span class="string">&#x27;low&#x27;</span><span class="punctuation">)</span></span><br><span class="line">exp_diff_high <span class="operator">&lt;-</span> exp_diff<span class="punctuation">[</span><span class="punctuation">,</span>rownames<span class="punctuation">(</span>a<span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">exp_diff_low <span class="operator">&lt;-</span> exp_diff<span class="punctuation">[</span><span class="punctuation">,</span>rownames<span class="punctuation">(</span>b<span class="punctuation">)</span><span class="punctuation">]</span></span><br><span class="line">exp_diff <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>exp_diff_high<span class="punctuation">,</span>exp_diff_low<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#开始画图</span></span><br><span class="line">pheatmap<span class="punctuation">(</span>exp_diff<span class="punctuation">,</span></span><br><span class="line">         annotation_col<span class="operator">=</span>annotation_col<span class="punctuation">,</span></span><br><span class="line">         scale <span class="operator">=</span> <span class="string">&quot;row&quot;</span><span class="punctuation">,</span></span><br><span class="line">         show_rownames <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         show_colnames <span class="operator">=</span><span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         color <span class="operator">=</span> colorRampPalette<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;navy&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">(</span><span class="number">50</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         cluster_cols <span class="operator">=</span><span class="built_in">F</span><span class="punctuation">,</span></span><br><span class="line">         cluster_rows <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span></span><br><span class="line">         fontsize <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">         fontsize_row<span class="operator">=</span><span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">         fontsize_col<span class="operator">=</span><span class="number">3</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：绘制分组热图，直观展示差异基因在不同免疫评分组中的表达模式。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>scale = &quot;row&quot;</code>: 按行标准化，便于观察基因表达模式</li>
<li><code>colorRampPalette()</code>: 创建颜色梯度</li>
<li><code>cluster_cols = F</code>: 不对列聚类，保持分组顺序</li>
</ul>
<hr>
<h2 id="第五部分：重复流程分析基质评分"><a href="#第五部分：重复流程分析基质评分" class="headerlink" title="第五部分：重复流程分析基质评分"></a>第五部分：重复流程分析基质评分</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####基质评分####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;Stromal_DEG&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#...与免疫评分相同的分析流程...</span></span><br><span class="line">x <span class="operator">&lt;-</span> <span class="string">&quot;StromalScore&quot;</span></span><br><span class="line">med <span class="operator">&lt;-</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>median<span class="punctuation">(</span>estimate<span class="punctuation">[</span><span class="punctuation">,</span>x<span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#...其余代码相同...</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：重复差异分析流程，但基于基质评分分组，识别与肿瘤基质微环境相关的差异基因。</p>
<hr>
<h2 id="第六部分：差异基因交集分析"><a href="#第六部分：差异基因交集分析" class="headerlink" title="第六部分：差异基因交集分析"></a>第六部分：差异基因交集分析</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####将两次差异分析的差异基因取交集####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;Immune_Stromal_DEG&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#打开DEG_ImmuneScore.rda</span></span><br><span class="line">DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>res<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#添加上下调信息</span></span><br><span class="line">logFC_cutoff <span class="operator">&lt;-</span> 1</span><br><span class="line">type1 <span class="operator">=</span> <span class="punctuation">(</span>DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">)</span><span class="operator">&amp;</span><span class="punctuation">(</span>DEG<span class="operator">$</span>log2FoldChange <span class="operator">&lt;</span> <span class="operator">-</span>logFC_cutoff<span class="punctuation">)</span></span><br><span class="line">type2 <span class="operator">=</span> <span class="punctuation">(</span>DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">)</span><span class="operator">&amp;</span><span class="punctuation">(</span>DEG<span class="operator">$</span>log2FoldChange <span class="operator">&gt;</span> logFC_cutoff<span class="punctuation">)</span></span><br><span class="line">DEG<span class="operator">$</span>change <span class="operator">=</span> ifelse<span class="punctuation">(</span>type1<span class="punctuation">,</span><span class="string">&quot;DOWN&quot;</span><span class="punctuation">,</span>ifelse<span class="punctuation">(</span>type2<span class="punctuation">,</span><span class="string">&quot;UP&quot;</span><span class="punctuation">,</span><span class="string">&quot;NOT&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>DEG<span class="operator">$</span>change<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#提取上下调基因</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">a <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>DEG<span class="punctuation">,</span>change <span class="operator">==</span> <span class="string">&#x27;UP&#x27;</span><span class="punctuation">)</span></span><br><span class="line">b <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>DEG<span class="punctuation">,</span>change <span class="operator">==</span> <span class="string">&#x27;DOWN&#x27;</span><span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>a<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;Immune_up.csv&quot;</span><span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>b<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;Immune_down.csv&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：分别保存免疫评分和基质评分相关的差异基因，为后续交集分析做准备。</p>
<hr>
<h2 id="第七部分：功能富集分析"><a href="#第七部分：功能富集分析" class="headerlink" title="第七部分：功能富集分析"></a>第七部分：功能富集分析</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####用交集差异基因做富集分析####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;FUJI_Immune_Stromal_DEG&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span><span class="string">&quot;BiocManager&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>org.Hs.eg.db<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>clusterProfiler<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#导入DEG_final.txt</span></span><br><span class="line"><span class="comment">#导入immune或stromal差异分析结果 均可</span></span><br><span class="line">DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>res<span class="punctuation">)</span></span><br><span class="line">DEG <span class="operator">&lt;-</span> DEG<span class="punctuation">[</span>DEG_final<span class="operator">$</span>SYMBOL<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">DEG <span class="operator">&lt;-</span> rownames_to_column<span class="punctuation">(</span>DEG<span class="punctuation">,</span><span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">)</span></span><br><span class="line">genelist <span class="operator">&lt;-</span> bitr<span class="punctuation">(</span>DEG<span class="operator">$</span>SYMBOL<span class="punctuation">,</span> fromType<span class="operator">=</span><span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                 toType<span class="operator">=</span><span class="string">&quot;ENTREZID&quot;</span><span class="punctuation">,</span> OrgDb<span class="operator">=</span><span class="string">&#x27;org.Hs.eg.db&#x27;</span><span class="punctuation">)</span></span><br><span class="line">DEG <span class="operator">&lt;-</span> inner_join<span class="punctuation">(</span>DEG<span class="punctuation">,</span>genelist<span class="punctuation">,</span>by<span class="operator">=</span><span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：将基因符号转换为ENTREZ ID，为GO和KEGG富集分析准备数据。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>bitr()</code>: 基因ID转换函数</li>
<li><code>inner_join()</code>: 内连接，保留两个数据框共有的行</li>
</ul>
<hr>
<h2 id="第八部分：GO和KEGG富集分析"><a href="#第八部分：GO和KEGG富集分析" class="headerlink" title="第八部分：GO和KEGG富集分析"></a>第八部分：GO和KEGG富集分析</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####GO####</span></span><br><span class="line">ego <span class="operator">&lt;-</span> enrichGO<span class="punctuation">(</span>gene <span class="operator">=</span> DEG<span class="operator">$</span>ENTREZID<span class="punctuation">,</span></span><br><span class="line">                OrgDb <span class="operator">=</span> org.Hs.eg.db<span class="punctuation">,</span> </span><br><span class="line">                ont <span class="operator">=</span> <span class="string">&quot;all&quot;</span><span class="punctuation">,</span></span><br><span class="line">                pAdjustMethod <span class="operator">=</span> <span class="string">&quot;BH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                minGSSize <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                pvalueCutoff <span class="operator">=</span><span class="number">0.05</span><span class="punctuation">,</span> </span><br><span class="line">                qvalueCutoff <span class="operator">=</span><span class="number">0.05</span><span class="punctuation">,</span></span><br><span class="line">                readable <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ego_res <span class="operator">&lt;-</span> ego<span class="operator">@</span>result</span><br><span class="line">save<span class="punctuation">(</span>ego<span class="punctuation">,</span>ego_res<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;GO_DEG_final.Rda&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">####KEGG####</span></span><br><span class="line">kk <span class="operator">&lt;-</span> enrichKEGG<span class="punctuation">(</span>gene         <span class="operator">=</span> DEG<span class="operator">$</span>ENTREZID<span class="punctuation">,</span></span><br><span class="line">                 organism     <span class="operator">=</span> <span class="string">&#x27;hsa&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                 pvalueCutoff <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span></span><br><span class="line">                 qvalueCutoff <span class="operator">=</span><span class="number">0.1</span><span class="punctuation">)</span></span><br><span class="line">kk_res <span class="operator">&lt;-</span> kk<span class="operator">@</span>result</span><br><span class="line">save<span class="punctuation">(</span>kk<span class="punctuation">,</span>kk_res<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;KEGG_DEG_final.Rda&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：识别差异基因显著富集的生物学过程和通路，揭示其潜在功能。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>enrichGO()</code>: GO富集分析，ont=”all”包含BP、CC、MF三个本体</li>
<li><code>enrichKEGG()</code>: KEGG通路富集分析</li>
<li><code>pAdjustMethod = &quot;BH&quot;</code>: Benjamini-Hochberg多重检验校正</li>
</ul>
<hr>
<h2 id="第九部分：富集网络可视化"><a href="#第九部分：富集网络可视化" class="headerlink" title="第九部分：富集网络可视化"></a>第九部分：富集网络可视化</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#网络图</span></span><br><span class="line">library<span class="punctuation">(</span>ggnewscale<span class="punctuation">)</span></span><br><span class="line">List <span class="operator">=</span> DEG<span class="operator">$</span>log2FoldChange</span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>List<span class="punctuation">)</span><span class="operator">=</span> DEG<span class="operator">$</span>ENTREZID</span><br><span class="line">head<span class="punctuation">(</span>List<span class="punctuation">)</span></span><br><span class="line">List <span class="operator">=</span> sort<span class="punctuation">(</span>List<span class="punctuation">,</span>decreasing <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#GO</span></span><br><span class="line">cnetplot<span class="punctuation">(</span>ego<span class="punctuation">,</span> foldChange <span class="operator">=</span> List<span class="punctuation">,</span> circular <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> colorEdge <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#KEGG</span></span><br><span class="line">cnetplot<span class="punctuation">(</span>kk<span class="punctuation">,</span> foldChange <span class="operator">=</span> List<span class="punctuation">,</span> circular <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> colorEdge <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：绘制基因-功能网络图，展示差异基因与富集功能项之间的关系。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>cnetplot()</code>: 基因-概念网络图</li>
<li><code>foldChange</code>: 添加基因表达变化信息</li>
<li><code>circular = TRUE</code>: 圆形布局，更美观</li>
</ul>
<hr>
<h2 id="完整代码-2"><a href="#完整代码-2" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### Day5 ####</span></span><br><span class="line"><span class="comment">#### 差异分析和富集分析 ####</span></span><br><span class="line">library<span class="punctuation">(</span>BiocManager<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>DESeq2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>pheatmap<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>clusterProfiler<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>org.Hs.eg.db<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggnewscale<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置差异分析函数</span></span><br><span class="line">perform_DEG_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>score_type<span class="punctuation">,</span> output_dir<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">  setwd<span class="punctuation">(</span>output_dir<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 读取数据</span></span><br><span class="line">  counts_01A <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;counts01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                           check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">  estimate <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;ESTIMATE_result.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> </span><br><span class="line">                         check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 整理分组信息</span></span><br><span class="line">  med <span class="operator">&lt;-</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>median<span class="punctuation">(</span>estimate<span class="punctuation">[</span><span class="punctuation">,</span> score_type<span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  estimate_t <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>t<span class="punctuation">(</span>estimate<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span>identical<span class="punctuation">(</span>colnames<span class="punctuation">(</span>counts_01A<span class="punctuation">)</span><span class="punctuation">,</span> colnames<span class="punctuation">(</span>estimate_t<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    stop<span class="punctuation">(</span><span class="string">&quot;表达数据和评分数据样本不匹配！&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  conditions <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span></span><br><span class="line">    sample <span class="operator">=</span> colnames<span class="punctuation">(</span>counts_01A<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    group <span class="operator">=</span> factor<span class="punctuation">(</span>ifelse<span class="punctuation">(</span>estimate_t<span class="punctuation">[</span>score_type<span class="punctuation">,</span> <span class="punctuation">]</span> <span class="operator">&gt;</span> med<span class="punctuation">,</span> <span class="string">&quot;high&quot;</span><span class="punctuation">,</span> <span class="string">&quot;low&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                   levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;high&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">%&gt;%</span> column_to_rownames<span class="punctuation">(</span><span class="string">&quot;sample&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># DESeq2差异分析</span></span><br><span class="line">  dds <span class="operator">&lt;-</span> DESeqDataSetFromMatrix<span class="punctuation">(</span></span><br><span class="line">    countData <span class="operator">=</span> counts_01A<span class="punctuation">,</span></span><br><span class="line">    colData <span class="operator">=</span> conditions<span class="punctuation">,</span></span><br><span class="line">    design <span class="operator">=</span> <span class="operator">~</span> group</span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  dds <span class="operator">&lt;-</span> DESeq<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line">  res <span class="operator">&lt;-</span> results<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line">  save<span class="punctuation">(</span>res<span class="punctuation">,</span> file <span class="operator">=</span> paste0<span class="punctuation">(</span><span class="string">&quot;DEG_&quot;</span><span class="punctuation">,</span> score_type<span class="punctuation">,</span> <span class="string">&quot;.Rda&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span><span class="built_in">list</span><span class="punctuation">(</span>res <span class="operator">=</span> res<span class="punctuation">,</span> conditions <span class="operator">=</span> conditions<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 热图绘制函数</span></span><br><span class="line">plot_heatmap <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>DEG_result<span class="punctuation">,</span> conditions<span class="punctuation">,</span> score_type<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>DEG_result<span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                   check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 筛选差异基因</span></span><br><span class="line">  logFC_cutoff <span class="operator">&lt;-</span> 1</span><br><span class="line">  DEG<span class="operator">$</span>change <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span></span><br><span class="line">    DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span> <span class="operator">&amp;</span> DEG<span class="operator">$</span>log2FoldChange <span class="operator">&lt;</span> <span class="operator">-</span>logFC_cutoff<span class="punctuation">,</span> <span class="string">&quot;DOWN&quot;</span><span class="punctuation">,</span></span><br><span class="line">    ifelse<span class="punctuation">(</span>DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span> <span class="operator">&amp;</span> DEG<span class="operator">$</span>log2FoldChange <span class="operator">&gt;</span> logFC_cutoff<span class="punctuation">,</span> <span class="string">&quot;UP&quot;</span><span class="punctuation">,</span> <span class="string">&quot;NOT&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  cat<span class="punctuation">(</span>score_type<span class="punctuation">,</span> <span class="string">&quot;差异基因统计:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">  print<span class="punctuation">(</span>table<span class="punctuation">(</span>DEG<span class="operator">$</span>change<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 提取差异基因表达谱</span></span><br><span class="line">  diff_genes <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>DEG<span class="punctuation">,</span> change <span class="operator">%in%</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;UP&quot;</span><span class="punctuation">,</span> <span class="string">&quot;DOWN&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  exp_diff <span class="operator">&lt;-</span> <span class="built_in">exp</span><span class="punctuation">[</span>rownames<span class="punctuation">(</span>diff_genes<span class="punctuation">)</span><span class="punctuation">,</span> <span class="punctuation">]</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 按分组排序</span></span><br><span class="line">  high_samples <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>filter<span class="punctuation">(</span>conditions<span class="punctuation">,</span> group <span class="operator">==</span> <span class="string">&#x27;high&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  low_samples <span class="operator">&lt;-</span> rownames<span class="punctuation">(</span>filter<span class="punctuation">(</span>conditions<span class="punctuation">,</span> group <span class="operator">==</span> <span class="string">&#x27;low&#x27;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  exp_diff_ordered <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>exp_diff<span class="punctuation">[</span><span class="punctuation">,</span> high_samples<span class="punctuation">]</span><span class="punctuation">,</span> exp_diff<span class="punctuation">[</span><span class="punctuation">,</span> low_samples<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制热图</span></span><br><span class="line">  pheatmap<span class="punctuation">(</span>exp_diff_ordered<span class="punctuation">,</span></span><br><span class="line">           annotation_col <span class="operator">=</span> conditions<span class="punctuation">,</span></span><br><span class="line">           scale <span class="operator">=</span> <span class="string">&quot;row&quot;</span><span class="punctuation">,</span></span><br><span class="line">           show_rownames <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           show_colnames <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           color <span class="operator">=</span> colorRampPalette<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;navy&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;red&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">(</span><span class="number">50</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           cluster_cols <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span></span><br><span class="line">           cluster_rows <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">           fontsize <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">           main <span class="operator">=</span> paste<span class="punctuation">(</span>score_type<span class="punctuation">,</span> <span class="string">&quot;DEG Heatmap&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行免疫评分和基质评分差异分析</span></span><br><span class="line">immune_result <span class="operator">&lt;-</span> perform_DEG_analysis<span class="punctuation">(</span><span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Immune_DEG&quot;</span><span class="punctuation">)</span></span><br><span class="line">stromal_result <span class="operator">&lt;-</span> perform_DEG_analysis<span class="punctuation">(</span><span class="string">&quot;StromalScore&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Stromal_DEG&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制热图</span></span><br><span class="line">plot_heatmap<span class="punctuation">(</span>immune_result<span class="operator">$</span>res<span class="punctuation">,</span> immune_result<span class="operator">$</span>conditions<span class="punctuation">,</span> <span class="string">&quot;ImmuneScore&quot;</span><span class="punctuation">)</span></span><br><span class="line">plot_heatmap<span class="punctuation">(</span>stromal_result<span class="operator">$</span>res<span class="punctuation">,</span> stromal_result<span class="operator">$</span>conditions<span class="punctuation">,</span> <span class="string">&quot;StromalScore&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存差异基因结果</span></span><br><span class="line">save_DEG_results <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>DEG_result<span class="punctuation">,</span> prefix<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>DEG_result<span class="punctuation">)</span></span><br><span class="line">  logFC_cutoff <span class="operator">&lt;-</span> 1</span><br><span class="line">  DEG<span class="operator">$</span>change <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span></span><br><span class="line">    DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span> <span class="operator">&amp;</span> DEG<span class="operator">$</span>log2FoldChange <span class="operator">&lt;</span> <span class="operator">-</span>logFC_cutoff<span class="punctuation">,</span> <span class="string">&quot;DOWN&quot;</span><span class="punctuation">,</span></span><br><span class="line">    ifelse<span class="punctuation">(</span>DEG<span class="operator">$</span>padj <span class="operator">&lt;</span> <span class="number">0.05</span> <span class="operator">&amp;</span> DEG<span class="operator">$</span>log2FoldChange <span class="operator">&gt;</span> logFC_cutoff<span class="punctuation">,</span> <span class="string">&quot;UP&quot;</span><span class="punctuation">,</span> <span class="string">&quot;NOT&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  up_genes <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>DEG<span class="punctuation">,</span> change <span class="operator">==</span> <span class="string">&#x27;UP&#x27;</span><span class="punctuation">)</span></span><br><span class="line">  down_genes <span class="operator">&lt;-</span> filter<span class="punctuation">(</span>DEG<span class="punctuation">,</span> change <span class="operator">==</span> <span class="string">&#x27;DOWN&#x27;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  write.csv<span class="punctuation">(</span>up_genes<span class="punctuation">,</span> file <span class="operator">=</span> paste0<span class="punctuation">(</span>prefix<span class="punctuation">,</span> <span class="string">&quot;_up.csv&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  write.csv<span class="punctuation">(</span>down_genes<span class="punctuation">,</span> file <span class="operator">=</span> paste0<span class="punctuation">(</span>prefix<span class="punctuation">,</span> <span class="string">&quot;_down.csv&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/Immune_Stromal_DEG&quot;</span><span class="punctuation">)</span></span><br><span class="line">save_DEG_results<span class="punctuation">(</span>immune_result<span class="operator">$</span>res<span class="punctuation">,</span> <span class="string">&quot;Immune&quot;</span><span class="punctuation">)</span></span><br><span class="line">save_DEG_results<span class="punctuation">(</span>stromal_result<span class="operator">$</span>res<span class="punctuation">,</span> <span class="string">&quot;Stromal&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 富集分析函数</span></span><br><span class="line">perform_enrichment_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>DEG_result<span class="punctuation">,</span> gene_symbols<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>DEG_result<span class="punctuation">)</span></span><br><span class="line">  DEG <span class="operator">&lt;-</span> DEG<span class="punctuation">[</span>gene_symbols<span class="punctuation">,</span> <span class="punctuation">]</span></span><br><span class="line">  DEG <span class="operator">&lt;-</span> rownames_to_column<span class="punctuation">(</span>DEG<span class="punctuation">,</span> <span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ID转换</span></span><br><span class="line">  genelist <span class="operator">&lt;-</span> bitr<span class="punctuation">(</span>DEG<span class="operator">$</span>SYMBOL<span class="punctuation">,</span> fromType <span class="operator">=</span> <span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">,</span></span><br><span class="line">                   toType <span class="operator">=</span> <span class="string">&quot;ENTREZID&quot;</span><span class="punctuation">,</span> OrgDb <span class="operator">=</span> <span class="string">&#x27;org.Hs.eg.db&#x27;</span><span class="punctuation">)</span></span><br><span class="line">  DEG <span class="operator">&lt;-</span> inner_join<span class="punctuation">(</span>DEG<span class="punctuation">,</span> genelist<span class="punctuation">,</span> by <span class="operator">=</span> <span class="string">&quot;SYMBOL&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># GO富集分析</span></span><br><span class="line">  ego <span class="operator">&lt;-</span> enrichGO<span class="punctuation">(</span>gene <span class="operator">=</span> DEG<span class="operator">$</span>ENTREZID<span class="punctuation">,</span></span><br><span class="line">                  OrgDb <span class="operator">=</span> org.Hs.eg.db<span class="punctuation">,</span></span><br><span class="line">                  ont <span class="operator">=</span> <span class="string">&quot;all&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  pAdjustMethod <span class="operator">=</span> <span class="string">&quot;BH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                  pvalueCutoff <span class="operator">=</span> <span class="number">0.05</span><span class="punctuation">,</span></span><br><span class="line">                  qvalueCutoff <span class="operator">=</span> <span class="number">0.05</span><span class="punctuation">,</span></span><br><span class="line">                  readable <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># KEGG富集分析</span></span><br><span class="line">  kk <span class="operator">&lt;-</span> enrichKEGG<span class="punctuation">(</span>gene <span class="operator">=</span> DEG<span class="operator">$</span>ENTREZID<span class="punctuation">,</span></span><br><span class="line">                   organism <span class="operator">=</span> <span class="string">&#x27;hsa&#x27;</span><span class="punctuation">,</span></span><br><span class="line">                   pvalueCutoff <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span></span><br><span class="line">                   qvalueCutoff <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span><span class="built_in">list</span><span class="punctuation">(</span>ego <span class="operator">=</span> ego<span class="punctuation">,</span> kk <span class="operator">=</span> kk<span class="punctuation">,</span> DEG <span class="operator">=</span> DEG<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行富集分析（需要先定义DEG_final）</span></span><br><span class="line"><span class="comment"># enrichment_results &lt;- perform_enrichment_analysis(res, DEG_final$SYMBOL)</span></span><br><span class="line"></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;差异分析和富集分析流程完成！\n&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>整体研究意义</strong>：这套流程系统分析了肿瘤微环境（免疫和基质成分）相关的分子特征，识别关键差异基因并揭示其生物学功能，为理解肿瘤微环境调控机制和发现潜在治疗靶点提供重要线索。</p>
<h1 id="生信速通之五-PPI和COX"><a href="#生信速通之五-PPI和COX" class="headerlink" title="生信速通之五 PPI和COX"></a>生信速通之五 PPI和COX</h1><h2 id="第一部分：PPI网络分析准备"><a href="#第一部分：PPI网络分析准备" class="headerlink" title="第一部分：PPI网络分析准备"></a>第一部分：PPI网络分析准备</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####Day6####</span></span><br><span class="line"><span class="comment">####PPI####</span></span><br><span class="line"><span class="comment">#String：https://cn.string-db.org/cgi/input?sessionId=bXmYsv7CnUrH&amp;input_page_active_form=multiple_identifiers</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：准备进行蛋白质-蛋白质相互作用网络分析，使用STRING数据库在线工具。</p>
<p><strong>研究意义</strong>：PPI分析有助于识别差异基因在蛋白质相互作用网络中的核心节点和功能模块，发现潜在的调控枢纽基因。</p>
<hr>
<h2 id="第二部分：单变量Cox回归分析"><a href="#第二部分：单变量Cox回归分析" class="headerlink" title="第二部分：单变量Cox回归分析"></a>第二部分：单变量Cox回归分析</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####COX####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;COX&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#安装加载R包</span></span><br><span class="line"><span class="comment">#install.packages(&quot;survival&quot;)</span></span><br><span class="line"><span class="comment">#install.packages(&quot;forestplot&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>survival<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>forestplot<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#读取文件</span></span><br><span class="line">exp_surv_01A <span class="operator">=</span> read.table<span class="punctuation">(</span><span class="string">&quot;exp_surv_01A.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#手动读取DEG_final.txt </span></span><br><span class="line"><span class="comment">#提取DEG_final</span></span><br><span class="line">surv.expr <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>exp_surv_01A<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">,</span>exp_surv_01A<span class="punctuation">[</span><span class="punctuation">,</span>DEG_final<span class="operator">$</span>SYMBOL<span class="punctuation">]</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：整合生存数据和差异基因表达数据，为Cox比例风险模型准备输入数据。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>cbind()</code>: 按列合并数据框，将生存时间/状态与基因表达数据合并</li>
<li><code>DEG_final$SYMBOL</code>: 假设DEG_final包含筛选出的差异基因符号</li>
</ul>
<hr>
<h2 id="第三部分：批量单变量Cox分析"><a href="#第三部分：批量单变量Cox分析" class="headerlink" title="第三部分：批量单变量Cox分析"></a>第三部分：批量单变量Cox分析</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Cox分析</span></span><br><span class="line">Coxoutput <span class="operator">&lt;-</span> <span class="literal">NULL</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span><span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">3</span><span class="operator">:</span>ncol<span class="punctuation">(</span>surv.expr<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">&#123;</span></span><br><span class="line">  g <span class="operator">&lt;-</span> colnames<span class="punctuation">(</span>surv.expr<span class="punctuation">)</span><span class="punctuation">[</span>i<span class="punctuation">]</span></span><br><span class="line">  cox <span class="operator">&lt;-</span> coxph<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span>OS<span class="punctuation">)</span> <span class="operator">~</span> surv.expr<span class="punctuation">[</span><span class="punctuation">,</span>i<span class="punctuation">]</span><span class="punctuation">,</span> data <span class="operator">=</span> surv.expr<span class="punctuation">)</span> <span class="comment"># 单变量cox模型</span></span><br><span class="line">  coxSummary <span class="operator">=</span> summary<span class="punctuation">(</span>cox<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  Coxoutput <span class="operator">&lt;-</span> rbind.data.frame<span class="punctuation">(</span>Coxoutput<span class="punctuation">,</span></span><br><span class="line">                                data.frame<span class="punctuation">(</span>gene <span class="operator">=</span> g<span class="punctuation">,</span></span><br><span class="line">                                           HR <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>coefficients<span class="punctuation">[</span><span class="punctuation">,</span><span class="string">&quot;exp(coef)&quot;</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                           z <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>coefficients<span class="punctuation">[</span><span class="punctuation">,</span><span class="string">&quot;z&quot;</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                           pvalue <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>coefficients<span class="punctuation">[</span><span class="punctuation">,</span><span class="string">&quot;Pr(&gt;|z|)&quot;</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                                           lower <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>conf.int<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                                           upper <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>conf.int<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                                           stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                                stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">Coxoutput <span class="operator">&lt;-</span> arrange<span class="punctuation">(</span>Coxoutput<span class="punctuation">,</span>pvalue<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：对每个差异基因进行单变量Cox回归分析，评估其对患者生存的影响。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>coxph(Surv(OS.time,OS) ~ surv.expr[,i])</code>: Cox比例风险模型</li>
<li><code>exp(coef)</code>: 风险比(HR)，HR&gt;1表示风险因素，HR&lt;1表示保护因素</li>
<li><code>conf.int</code>: 置信区间，评估HR估计的精确度</li>
<li><code>arrange(pvalue)</code>: 按p值升序排列，便于识别最显著的基因</li>
</ul>
<hr>
<h2 id="第四部分：显著基因筛选"><a href="#第四部分：显著基因筛选" class="headerlink" title="第四部分：显著基因筛选"></a>第四部分：显著基因筛选</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###筛选top基因</span></span><br><span class="line">gene_sig <span class="operator">&lt;-</span> Coxoutput<span class="punctuation">[</span>Coxoutput<span class="operator">$</span>pvalue <span class="operator">&lt;</span> <span class="number">0.005</span><span class="punctuation">,</span><span class="punctuation">]</span> <span class="comment"># 取出p值小于0.05的基因</span></span><br><span class="line">write.csv<span class="punctuation">(</span>gene_sig<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;gene_sig.csv&quot;</span><span class="punctuation">)</span></span><br><span class="line">topgene <span class="operator">&lt;-</span> gene_sig <span class="comment">#为了下面不改topgene</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：筛选具有显著预后价值的基因（p &lt; 0.005），用于后续可视化。</p>
<p><strong>研究意义</strong>：识别与患者总生存期显著相关的基因，这些基因可能作为潜在的预后标志物。</p>
<hr>
<h2 id="第五部分：森林图数据准备"><a href="#第五部分：森林图数据准备" class="headerlink" title="第五部分：森林图数据准备"></a>第五部分：森林图数据准备</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#3. 绘制森林图</span></span><br><span class="line"><span class="comment">##3.1 输入表格的制作</span></span><br><span class="line">tabletext <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span><span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Gene&quot;</span><span class="punctuation">,</span>topgene<span class="operator">$</span>gene<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;HR&quot;</span><span class="punctuation">,</span>format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>topgene<span class="operator">$</span>HR<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span>nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;lower 95%CI&quot;</span><span class="punctuation">,</span>format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>topgene<span class="operator">$</span>lower<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span>nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;upper 95%CI&quot;</span><span class="punctuation">,</span>format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>topgene<span class="operator">$</span>upper<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span>nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                   <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;pvalue&quot;</span><span class="punctuation">,</span>format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>topgene<span class="operator">$</span>p<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span>nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：准备森林图所需的文本标签，包括基因名、HR值、置信区间和p值。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>cbind()</code>: 按列组合向量创建矩阵</li>
<li><code>format(round(), nsmall = 3)</code>: 统一数字格式，保留3位小数</li>
<li><code>tabletext</code>: 森林图左侧的文本表格</li>
</ul>
<hr>
<h2 id="第六部分：森林图绘制"><a href="#第六部分：森林图绘制" class="headerlink" title="第六部分：森林图绘制"></a>第六部分：森林图绘制</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##3.2 绘制森林图</span></span><br><span class="line">forestplot<span class="punctuation">(</span>labeltext<span class="operator">=</span>tabletext<span class="punctuation">,</span></span><br><span class="line">           mean<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>topgene<span class="operator">$</span>HR<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           lower<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>topgene<span class="operator">$</span>lower<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">           upper<span class="operator">=</span><span class="built_in">c</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>topgene<span class="operator">$</span>upper<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           graph.pos<span class="operator">=</span><span class="number">5</span><span class="punctuation">,</span><span class="comment"># 图在表中的列位置</span></span><br><span class="line">           graphwidth <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">.25</span><span class="punctuation">,</span><span class="string">&quot;npc&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="comment"># 图在表中的宽度比</span></span><br><span class="line">           fn.ci_norm<span class="operator">=</span><span class="string">&quot;fpDrawDiamondCI&quot;</span><span class="punctuation">,</span><span class="comment"># box类型选择钻石</span></span><br><span class="line">           col<span class="operator">=</span>fpColors<span class="punctuation">(</span>box<span class="operator">=</span><span class="string">&quot;#00A896&quot;</span><span class="punctuation">,</span> lines<span class="operator">=</span><span class="string">&quot;#02C39A&quot;</span><span class="punctuation">,</span> zero <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="comment"># box颜色</span></span><br><span class="line">           </span><br><span class="line">           boxsize<span class="operator">=</span><span class="number">0.4</span><span class="punctuation">,</span><span class="comment"># box大小固定</span></span><br><span class="line">           lwd.ci<span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">           ci.vertices.height <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span>ci.vertices<span class="operator">=</span><span class="built_in">T</span><span class="punctuation">,</span><span class="comment"># 显示区间</span></span><br><span class="line">           zero<span class="operator">=</span><span class="number">1</span><span class="punctuation">,</span><span class="comment"># zero线横坐标</span></span><br><span class="line">           lwd.zero<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">,</span><span class="comment"># zero线宽</span></span><br><span class="line">           xticks <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.5</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">1.5</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="comment"># 横坐标刻度根据需要可随意设置</span></span><br><span class="line">           lwd.xaxis<span class="operator">=</span><span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">           xlab<span class="operator">=</span><span class="string">&quot;Hazard ratios&quot;</span><span class="punctuation">,</span></span><br><span class="line">           txt_gp<span class="operator">=</span>fpTxtGp<span class="punctuation">(</span>label<span class="operator">=</span>gpar<span class="punctuation">(</span>cex<span class="operator">=</span><span class="number">1.2</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="comment"># 各种字体大小设置</span></span><br><span class="line">                          ticks<span class="operator">=</span>gpar<span class="punctuation">(</span>cex<span class="operator">=</span><span class="number">0.85</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                          xlab<span class="operator">=</span>gpar<span class="punctuation">(</span>cex<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                          title<span class="operator">=</span>gpar<span class="punctuation">(</span>cex<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           hrzl_lines<span class="operator">=</span><span class="built_in">list</span><span class="punctuation">(</span><span class="string">&quot;1&quot;</span> <span class="operator">=</span> gpar<span class="punctuation">(</span>lwd<span class="operator">=</span><span class="number">2</span><span class="punctuation">,</span> col<span class="operator">=</span><span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># 在第一行上面画黑色实线</span></span><br><span class="line">                           <span class="string">&quot;2&quot;</span> <span class="operator">=</span> gpar<span class="punctuation">(</span>lwd<span class="operator">=</span><span class="number">1.5</span><span class="punctuation">,</span> col<span class="operator">=</span><span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># 在第一行标题行下画黑色实线</span></span><br><span class="line">                           <span class="string">&quot;53&quot;</span> <span class="operator">=</span> gpar<span class="punctuation">(</span>lwd<span class="operator">=</span><span class="number">2</span><span class="punctuation">,</span> col<span class="operator">=</span><span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># 在最后一行上画黑色实线</span></span><br><span class="line">           lineheight <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">.75</span><span class="punctuation">,</span><span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span><span class="comment"># 固定行高</span></span><br><span class="line">           colgap <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.3</span><span class="punctuation">,</span><span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           mar<span class="operator">=</span>unit<span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1.5</span><span class="punctuation">,</span> times <span class="operator">=</span> <span class="number">4</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">           new_page <span class="operator">=</span> <span class="built_in">F</span></span><br><span class="line"><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：绘制专业发表级的森林图，直观展示各基因的风险比及其置信区间。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>forestplot()</code>: 创建森林图的主要函数</li>
<li><code>graph.pos=5</code>: 森林图在第5列显示</li>
<li><code>fn.ci_norm=&quot;fpDrawDiamondCI&quot;</code>: 使用菱形表示点估计和置信区间</li>
<li><code>zero=1</code>: 参考线在HR=1的位置</li>
<li><code>hrzl_lines</code>: 添加水平分隔线增强可读性</li>
</ul>
<hr>
<h2 id="完整优化代码-1"><a href="#完整优化代码-1" class="headerlink" title="完整优化代码"></a>完整优化代码</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### Day6 ####</span></span><br><span class="line"><span class="comment">#### PPI和COX生存分析 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/COX&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载所需包</span></span><br><span class="line">library<span class="punctuation">(</span>survival<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>forestplot<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取整合的生存和表达数据</span></span><br><span class="line">exp_surv_01A <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;exp_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                          check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 单变量Cox回归分析函数</span></span><br><span class="line">perform_univariate_cox <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>surv_data<span class="punctuation">,</span> gene_symbols<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 提取生存数据和目标基因</span></span><br><span class="line">  surv.expr <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>surv_data<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">1</span><span class="operator">:</span><span class="number">2</span><span class="punctuation">]</span><span class="punctuation">,</span> surv_data<span class="punctuation">[</span><span class="punctuation">,</span> gene_symbols<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  Coxoutput <span class="operator">&lt;-</span> <span class="literal">NULL</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span><span class="punctuation">(</span>i <span class="keyword">in</span> <span class="number">3</span><span class="operator">:</span>ncol<span class="punctuation">(</span>surv.expr<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    g <span class="operator">&lt;-</span> colnames<span class="punctuation">(</span>surv.expr<span class="punctuation">)</span><span class="punctuation">[</span>i<span class="punctuation">]</span></span><br><span class="line">    cox <span class="operator">&lt;-</span> coxph<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> surv.expr<span class="punctuation">[</span><span class="punctuation">,</span> i<span class="punctuation">]</span><span class="punctuation">,</span> data <span class="operator">=</span> surv.expr<span class="punctuation">)</span></span><br><span class="line">    coxSummary <span class="operator">&lt;-</span> summary<span class="punctuation">(</span>cox<span class="punctuation">)</span></span><br><span class="line">    </span><br><span class="line">    Coxoutput <span class="operator">&lt;-</span> rbind.data.frame<span class="punctuation">(</span></span><br><span class="line">      Coxoutput<span class="punctuation">,</span></span><br><span class="line">      data.frame<span class="punctuation">(</span></span><br><span class="line">        gene <span class="operator">=</span> g<span class="punctuation">,</span></span><br><span class="line">        HR <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>coefficients<span class="punctuation">[</span><span class="punctuation">,</span> <span class="string">&quot;exp(coef)&quot;</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        z <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>coefficients<span class="punctuation">[</span><span class="punctuation">,</span> <span class="string">&quot;z&quot;</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        pvalue <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>coefficients<span class="punctuation">[</span><span class="punctuation">,</span> <span class="string">&quot;Pr(&gt;|z|)&quot;</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        lower <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>conf.int<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        upper <span class="operator">=</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>coxSummary<span class="operator">$</span>conf.int<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">4</span><span class="punctuation">]</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span></span><br><span class="line">      <span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">      stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span></span><br><span class="line">    <span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  Coxoutput <span class="operator">&lt;-</span> arrange<span class="punctuation">(</span>Coxoutput<span class="punctuation">,</span> pvalue<span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>Coxoutput<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 森林图绘制函数</span></span><br><span class="line">create_forest_plot <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>coxx_results<span class="punctuation">,</span> p_threshold <span class="operator">=</span> <span class="number">0.005</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 筛选显著基因</span></span><br><span class="line">  gene_sig <span class="operator">&lt;-</span> coxx_results<span class="punctuation">[</span>coxx_results<span class="operator">$</span>pvalue <span class="operator">&lt;</span> p_threshold<span class="punctuation">,</span> <span class="punctuation">]</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span><span class="punctuation">(</span>nrow<span class="punctuation">(</span>gene_sig<span class="punctuation">)</span> <span class="operator">==</span> <span class="number">0</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    warning<span class="punctuation">(</span><span class="string">&quot;没有找到符合显著性阈值的基因&quot;</span><span class="punctuation">)</span></span><br><span class="line">    <span class="built_in">return</span><span class="punctuation">(</span><span class="literal">NULL</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 准备森林图数据</span></span><br><span class="line">  tabletext <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span></span><br><span class="line">    <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Gene&quot;</span><span class="punctuation">,</span> gene_sig<span class="operator">$</span>gene<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;HR&quot;</span><span class="punctuation">,</span> format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>gene_sig<span class="operator">$</span>HR<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span> nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;lower 95%CI&quot;</span><span class="punctuation">,</span> format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>gene_sig<span class="operator">$</span>lower<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span> nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;upper 95%CI&quot;</span><span class="punctuation">,</span> format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>gene_sig<span class="operator">$</span>upper<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span> nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;pvalue&quot;</span><span class="punctuation">,</span> format<span class="punctuation">(</span><span class="built_in">round</span><span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span>gene_sig<span class="operator">$</span>pvalue<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">,</span> nsmall <span class="operator">=</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制森林图</span></span><br><span class="line">  forestplot<span class="punctuation">(</span></span><br><span class="line">    labeltext <span class="operator">=</span> tabletext<span class="punctuation">,</span></span><br><span class="line">    mean <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>gene_sig<span class="operator">$</span>HR<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    lower <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>gene_sig<span class="operator">$</span>lower<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    upper <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">as.numeric</span><span class="punctuation">(</span>gene_sig<span class="operator">$</span>upper<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    graph.pos <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    graphwidth <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.25</span><span class="punctuation">,</span> <span class="string">&quot;npc&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    fn.ci_norm <span class="operator">=</span> <span class="string">&quot;fpDrawDiamondCI&quot;</span><span class="punctuation">,</span></span><br><span class="line">    col <span class="operator">=</span> fpColors<span class="punctuation">(</span>box <span class="operator">=</span> <span class="string">&quot;#00A896&quot;</span><span class="punctuation">,</span> lines <span class="operator">=</span> <span class="string">&quot;#02C39A&quot;</span><span class="punctuation">,</span> zero <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    boxsize <span class="operator">=</span> <span class="number">0.4</span><span class="punctuation">,</span></span><br><span class="line">    lwd.ci <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    ci.vertices <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">    ci.vertices.height <span class="operator">=</span> <span class="number">0.1</span><span class="punctuation">,</span></span><br><span class="line">    zero <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    lwd.zero <span class="operator">=</span> <span class="number">1.5</span><span class="punctuation">,</span></span><br><span class="line">    xticks <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0.5</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">1.5</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    lwd.xaxis <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">    xlab <span class="operator">=</span> <span class="string">&quot;Hazard ratios&quot;</span><span class="punctuation">,</span></span><br><span class="line">    txt_gp <span class="operator">=</span> fpTxtGp<span class="punctuation">(</span></span><br><span class="line">      label <span class="operator">=</span> gpar<span class="punctuation">(</span>cex <span class="operator">=</span> <span class="number">1.2</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">      ticks <span class="operator">=</span> gpar<span class="punctuation">(</span>cex <span class="operator">=</span> <span class="number">0.85</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">      xlab <span class="operator">=</span> gpar<span class="punctuation">(</span>cex <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">      title <span class="operator">=</span> gpar<span class="punctuation">(</span>cex <span class="operator">=</span> <span class="number">1.5</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    hrzl_lines <span class="operator">=</span> <span class="built_in">list</span><span class="punctuation">(</span></span><br><span class="line">      <span class="string">&quot;1&quot;</span> <span class="operator">=</span> gpar<span class="punctuation">(</span>lwd <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> col <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;2&quot;</span> <span class="operator">=</span> gpar<span class="punctuation">(</span>lwd <span class="operator">=</span> <span class="number">1.5</span><span class="punctuation">,</span> col <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">      paste0<span class="punctuation">(</span>nrow<span class="punctuation">(</span>gene_sig<span class="punctuation">)</span> <span class="operator">+</span> <span class="number">2</span><span class="punctuation">)</span> <span class="operator">=</span> gpar<span class="punctuation">(</span>lwd <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> col <span class="operator">=</span> <span class="string">&quot;black&quot;</span><span class="punctuation">)</span></span><br><span class="line">    <span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    lineheight <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.75</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    colgap <span class="operator">=</span> unit<span class="punctuation">(</span><span class="number">0.3</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    mar <span class="operator">=</span> unit<span class="punctuation">(</span><span class="built_in">rep</span><span class="punctuation">(</span><span class="number">1.5</span><span class="punctuation">,</span> times <span class="operator">=</span> <span class="number">4</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;cm&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    new_page <span class="operator">=</span> <span class="literal">FALSE</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>gene_sig<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行分析流程</span></span><br><span class="line"><span class="comment"># 假设DEG_final已加载</span></span><br><span class="line"><span class="keyword">if</span><span class="punctuation">(</span>exists<span class="punctuation">(</span><span class="string">&quot;DEG_final&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 单变量Cox分析</span></span><br><span class="line">  cox_results <span class="operator">&lt;-</span> perform_univariate_cox<span class="punctuation">(</span>exp_surv_01A<span class="punctuation">,</span> DEG_final<span class="operator">$</span>SYMBOL<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 保存显著基因</span></span><br><span class="line">  write.csv<span class="punctuation">(</span>cox_results<span class="punctuation">,</span> <span class="string">&quot;all_coxx_genes.csv&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制森林图</span></span><br><span class="line">  significant_genes <span class="operator">&lt;-</span> create_forest_plot<span class="punctuation">(</span>cox_results<span class="punctuation">,</span> p_threshold <span class="operator">=</span> <span class="number">0.005</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span><span class="built_in">is.null</span><span class="punctuation">(</span>significant_genes<span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    write.csv<span class="punctuation">(</span>significant_genes<span class="punctuation">,</span> <span class="string">&quot;gene_sig.csv&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">    cat<span class="punctuation">(</span><span class="string">&quot;发现&quot;</span><span class="punctuation">,</span> nrow<span class="punctuation">(</span>significant_genes<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;个显著预后基因\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line"><span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="punctuation">&#123;</span></span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&quot;请先加载DEG_final数据\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;PPI和COX分析完成！\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;下一步：将显著基因列表上传至STRING数据库进行PPI网络分析\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;STRING网址: https://cn.string-db.org/\n&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>整体研究意义</strong>：这套流程通过单变量Cox回归识别具有独立预后价值的基因，并通过森林图直观展示结果。显著基因可进一步用于构建预后模型或作为PPI网络分析的输入，为理解肿瘤发生发展的分子机制和发现治疗靶点提供重要线索。</p>
<h1 id="生信速通之六-BTK在肿瘤样本与正常样本中的表达差异"><a href="#生信速通之六-BTK在肿瘤样本与正常样本中的表达差异" class="headerlink" title="生信速通之六 BTK在肿瘤样本与正常样本中的表达差异"></a>生信速通之六 BTK在肿瘤样本与正常样本中的表达差异</h1><h2 id="第一部分：BTK在肿瘤vs正常样本中的表达差异"><a href="#第一部分：BTK在肿瘤vs正常样本中的表达差异" class="headerlink" title="第一部分：BTK在肿瘤vs正常样本中的表达差异"></a>第一部分：BTK在肿瘤vs正常样本中的表达差异</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####Day7####</span></span><br><span class="line"><span class="comment">####BTK在肿瘤样本与正常样本中的表达差异####</span></span><br><span class="line"><span class="comment">####柱状图####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;BTK&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">tpms01A_log2 <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">tpms11A_log2 <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms11A_log2.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">gene <span class="operator">&lt;-</span> <span class="string">&quot;BTK&quot;</span><span class="comment">#以后修改这里即可</span></span><br><span class="line">a <span class="operator">&lt;-</span> tpms01A_log2<span class="punctuation">[</span>gene<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">b <span class="operator">&lt;-</span> tpms11A_log2<span class="punctuation">[</span>gene<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line"><span class="comment">#t转换</span></span><br><span class="line">a <span class="operator">&lt;-</span> a <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">b <span class="operator">&lt;-</span> b <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>a<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;BTK_01A.csv&quot;</span><span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>b<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;BTK_11A.csv&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：提取BTK基因在肿瘤样本和正常样本中的表达数据，为后续的差异表达分析准备数据。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>tpms01A_log2[gene,]</code>: 通过基因名提取该基因在所有样本中的表达值</li>
<li><code>t()</code>: 转置操作，将行向量转为列向量</li>
<li><code>as.data.frame()</code>: 转换为数据框格式便于后续分析</li>
</ul>
<hr>
<h2 id="第二部分：配对样本数据准备"><a href="#第二部分：配对样本数据准备" class="headerlink" title="第二部分：配对样本数据准备"></a>第二部分：配对样本数据准备</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####配对图绘制####</span></span><br><span class="line">tpms01A_log2 <span class="operator">&lt;-</span> tpms01A_log2 <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">tpms11A_log2 <span class="operator">&lt;-</span> tpms11A_log2 <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>tpms01A_log2<span class="punctuation">)</span> <span class="operator">&lt;-</span> substring<span class="punctuation">(</span>rownames<span class="punctuation">(</span>tpms01A_log2<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">12</span><span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>tpms11A_log2<span class="punctuation">)</span> <span class="operator">&lt;-</span> substring<span class="punctuation">(</span>rownames<span class="punctuation">(</span>tpms11A_log2<span class="punctuation">)</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">12</span><span class="punctuation">)</span></span><br><span class="line">a <span class="operator">&lt;-</span> intersect<span class="punctuation">(</span>rownames<span class="punctuation">(</span>tpms01A_log2<span class="punctuation">)</span><span class="punctuation">,</span>rownames<span class="punctuation">(</span>tpms11A_log2<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">tpms01A_log2 <span class="operator">&lt;-</span> tpms01A_log2<span class="punctuation">[</span>a<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">tpms11A_log2 <span class="operator">&lt;-</span> tpms11A_log2<span class="punctuation">[</span>a<span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">peidui <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>tpms11A_log2<span class="punctuation">[</span><span class="punctuation">,</span>gene<span class="punctuation">]</span><span class="punctuation">,</span>tpms01A_log2<span class="punctuation">[</span><span class="punctuation">,</span>gene<span class="punctuation">]</span><span class="punctuation">)</span><span class="comment">#11A放在前面</span></span><br><span class="line">peidui <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>peidui<span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>peidui<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;peidui.csv&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：准备配对样本数据，用于绘制肿瘤-正常配对图，这样可以更准确地评估同一患者肿瘤和正常组织的表达差异。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>substring(rownames(),1,12)</code>: 提取患者ID（前12位），用于匹配同一患者的肿瘤和正常样本</li>
<li><code>intersect()</code>: 找出同时有肿瘤和正常样本的患者</li>
<li><code>cbind()</code>: 按列合并，正常组织数据在前，肿瘤组织数据在后</li>
</ul>
<hr>
<h2 id="第三部分：BTK表达与生存分析"><a href="#第三部分：BTK表达与生存分析" class="headerlink" title="第三部分：BTK表达与生存分析"></a>第三部分：BTK表达与生存分析</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####根据BTK高低组做生存分析####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;survival&quot;</span><span class="punctuation">)</span></span><br><span class="line">surv <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;exp_surv_01A.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">surv<span class="operator">$</span>OS.time <span class="operator">&lt;-</span> surv<span class="operator">$</span>OS.time<span class="operator">/</span><span class="number">365</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#median 中位数</span></span><br><span class="line"><span class="comment">#BTK</span></span><br><span class="line">surv<span class="operator">$</span>group <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span>surv<span class="operator">$</span>BTK <span class="operator">&gt;</span> median<span class="punctuation">(</span>surv<span class="operator">$</span>BTK<span class="punctuation">)</span><span class="punctuation">,</span><span class="string">&quot;High&quot;</span><span class="punctuation">,</span><span class="string">&quot;Low&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">class</span><span class="punctuation">(</span>surv<span class="operator">$</span>group<span class="punctuation">)</span></span><br><span class="line">surv<span class="operator">$</span>group <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>surv<span class="operator">$</span>group<span class="punctuation">,</span> levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span><span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> </span><br><span class="line"><span class="built_in">class</span><span class="punctuation">(</span>surv<span class="operator">$</span>group<span class="punctuation">)</span></span><br><span class="line">table<span class="punctuation">(</span>surv<span class="operator">$</span>group<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：根据BTK表达的中位数将患者分为高表达组和低表达组，评估BTK表达水平对患者预后的影响。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>OS.time/365</code>: 将生存时间从天数转换为年，便于理解和可视化</li>
<li><code>ifelse()</code>: 条件分组，高于中位数为High组，低于中位数为Low组</li>
<li><code>factor(levels = c(&quot;Low&quot;,&quot;High&quot;))</code>: 设置因子水平，确保Low组作为参照组</li>
</ul>
<hr>
<h2 id="第四部分：生存曲线绘制"><a href="#第四部分：生存曲线绘制" class="headerlink" title="第四部分：生存曲线绘制"></a>第四部分：生存曲线绘制</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#install.packages(&quot;survival&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>survival<span class="punctuation">)</span></span><br><span class="line">fitd <span class="operator">&lt;-</span> survdiff<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span></span><br><span class="line">                 data      <span class="operator">=</span> surv<span class="punctuation">,</span></span><br><span class="line">                 na.action <span class="operator">=</span> na.exclude<span class="punctuation">)</span></span><br><span class="line">pValue <span class="operator">&lt;-</span> 1 <span class="operator">-</span> pchisq<span class="punctuation">(</span>fitd<span class="operator">$</span>chisq<span class="punctuation">,</span> <span class="built_in">length</span><span class="punctuation">(</span>fitd<span class="operator">$</span>n<span class="punctuation">)</span> <span class="operator">-</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.2 拟合生存曲线</span></span><br><span class="line">fit <span class="operator">&lt;-</span> survfit<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span><span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> surv<span class="punctuation">)</span></span><br><span class="line">summary<span class="punctuation">(</span>fit<span class="punctuation">)</span></span><br><span class="line">p.lab <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;P&quot;</span><span class="punctuation">,</span> ifelse<span class="punctuation">(</span>pValue <span class="operator">&lt;</span> <span class="number">0.001</span><span class="punctuation">,</span> <span class="string">&quot; &lt; 0.001&quot;</span><span class="punctuation">,</span> paste0<span class="punctuation">(</span><span class="string">&quot; = &quot;</span><span class="punctuation">,</span><span class="built_in">round</span><span class="punctuation">(</span>pValue<span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#install.packages(&quot;survminer&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>survminer<span class="punctuation">)</span></span><br><span class="line">ggsurvplot<span class="punctuation">(</span>fit<span class="punctuation">,</span></span><br><span class="line">           data <span class="operator">=</span> surv<span class="punctuation">,</span></span><br><span class="line">           pval <span class="operator">=</span> p.lab<span class="punctuation">,</span></span><br><span class="line">           conf.int <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> <span class="comment"># 显示置信区间</span></span><br><span class="line">           risk.table <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> <span class="comment"># 显示风险表</span></span><br><span class="line">           risk.table.col <span class="operator">=</span> <span class="string">&quot;strata&quot;</span><span class="punctuation">,</span></span><br><span class="line">           palette <span class="operator">=</span> <span class="string">&quot;jco&quot;</span><span class="punctuation">,</span> <span class="comment"># 配色采用jco</span></span><br><span class="line">           legend.labs <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># 图例</span></span><br><span class="line">           size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">           xlim <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">20</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># x轴长度</span></span><br><span class="line">           break.time.by <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span> <span class="comment"># x轴步长为5</span></span><br><span class="line">           legend.title <span class="operator">=</span> <span class="string">&quot;BTK&quot;</span><span class="punctuation">,</span></span><br><span class="line">           surv.median.line <span class="operator">=</span> <span class="string">&quot;hv&quot;</span><span class="punctuation">,</span> <span class="comment"># 限制垂直和水平的中位生存</span></span><br><span class="line">           ylab <span class="operator">=</span> <span class="string">&quot;Survival probability (%)&quot;</span><span class="punctuation">,</span> <span class="comment"># 修改y轴标签</span></span><br><span class="line">           xlab <span class="operator">=</span> <span class="string">&quot;Time (Years)&quot;</span><span class="punctuation">,</span> <span class="comment"># 修改x轴标签</span></span><br><span class="line">           ncensor.plot <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> <span class="comment"># 显示删失图块</span></span><br><span class="line">           ncensor.plot.height <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span></span><br><span class="line">           risk.table.y.text <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：绘制Kaplan-Meier生存曲线，直观展示BTK高表达组和低表达组的生存差异。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>survdiff()</code>: 生存差异检验（log-rank test）</li>
<li><code>survfit()</code>: 拟合生存曲线</li>
<li><code>ggsurvplot()</code>: 绘制发表级生存曲线图</li>
<li><code>conf.int = TRUE</code>: 显示置信区间</li>
<li><code>risk.table = TRUE</code>: 在下方显示风险表</li>
</ul>
<hr>
<h2 id="第五部分：BTK在不同临床分期中的表达"><a href="#第五部分：BTK在不同临床分期中的表达" class="headerlink" title="第五部分：BTK在不同临床分期中的表达"></a>第五部分：BTK在不同临床分期中的表达</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####不同分期BTK的表达####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;BTK&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">clinical.expr01A <span class="operator">=</span> read.table<span class="punctuation">(</span><span class="string">&quot;clinical.expr01A.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">gene <span class="operator">&lt;-</span> <span class="string">&quot;BTK&quot;</span></span><br><span class="line">clinical_BTK <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>clinical.expr01A<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">,</span>clinical.expr01A<span class="punctuation">[</span><span class="punctuation">,</span>gene<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">write.csv<span class="punctuation">(</span>clinical_BTK<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;clinical_BTK.csv&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：整合BTK表达数据与临床分期信息，用于分析BTK表达与肿瘤进展的关系。</p>
<p><strong>研究意义</strong>：探索BTK是否在不同肿瘤分期中表达有差异，可能提示其在肿瘤进展中的作用。</p>
<hr>
<h2 id="完整代码-3"><a href="#完整代码-3" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### BTK基因表达分析和生存分析 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/BTK&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>survival<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>survminer<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基因表达分析函数</span></span><br><span class="line">analyze_gene_expression <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>gene_name <span class="operator">=</span> <span class="string">&quot;BTK&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 读取表达数据</span></span><br><span class="line">  tpms01A_log2 <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                            check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">  tpms11A_log2 <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms11A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                            check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 提取目标基因表达数据</span></span><br><span class="line">  tumor_expr <span class="operator">&lt;-</span> tpms01A_log2<span class="punctuation">[</span>gene_name<span class="punctuation">,</span> <span class="punctuation">]</span> <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  normal_expr <span class="operator">&lt;-</span> tpms11A_log2<span class="punctuation">[</span>gene_name<span class="punctuation">,</span> <span class="punctuation">]</span> <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 保存表达数据</span></span><br><span class="line">  write.csv<span class="punctuation">(</span>tumor_expr<span class="punctuation">,</span> file <span class="operator">=</span> paste0<span class="punctuation">(</span>gene_name<span class="punctuation">,</span> <span class="string">&quot;_01A.csv&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  write.csv<span class="punctuation">(</span>normal_expr<span class="punctuation">,</span> file <span class="operator">=</span> paste0<span class="punctuation">(</span>gene_name<span class="punctuation">,</span> <span class="string">&quot;_11A.csv&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 准备配对数据</span></span><br><span class="line">  tumor_transposed <span class="operator">&lt;-</span> tpms01A_log2 <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  normal_transposed <span class="operator">&lt;-</span> tpms11A_log2 <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  rownames<span class="punctuation">(</span>tumor_transposed<span class="punctuation">)</span> <span class="operator">&lt;-</span> substring<span class="punctuation">(</span>rownames<span class="punctuation">(</span>tumor_transposed<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">12</span><span class="punctuation">)</span></span><br><span class="line">  rownames<span class="punctuation">(</span>normal_transposed<span class="punctuation">)</span> <span class="operator">&lt;-</span> substring<span class="punctuation">(</span>rownames<span class="punctuation">(</span>normal_transposed<span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="number">12</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  common_patients <span class="operator">&lt;-</span> intersect<span class="punctuation">(</span>rownames<span class="punctuation">(</span>tumor_transposed<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>normal_transposed<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  tumor_paired <span class="operator">&lt;-</span> tumor_transposed<span class="punctuation">[</span>common_patients<span class="punctuation">,</span> <span class="punctuation">]</span></span><br><span class="line">  normal_paired <span class="operator">&lt;-</span> normal_transposed<span class="punctuation">[</span>common_patients<span class="punctuation">,</span> <span class="punctuation">]</span></span><br><span class="line">  </span><br><span class="line">  paired_data <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>normal_paired<span class="punctuation">[</span><span class="punctuation">,</span> gene_name<span class="punctuation">]</span><span class="punctuation">,</span> tumor_paired<span class="punctuation">[</span><span class="punctuation">,</span> gene_name<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  paired_data <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>paired_data<span class="punctuation">)</span></span><br><span class="line">  colnames<span class="punctuation">(</span>paired_data<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Normal&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Tumor&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  write.csv<span class="punctuation">(</span>paired_data<span class="punctuation">,</span> file <span class="operator">=</span> <span class="string">&quot;paired_data.csv&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span><span class="built_in">list</span><span class="punctuation">(</span></span><br><span class="line">    tumor_expr <span class="operator">=</span> tumor_expr<span class="punctuation">,</span></span><br><span class="line">    normal_expr <span class="operator">=</span> normal_expr<span class="punctuation">,</span></span><br><span class="line">    paired_data <span class="operator">=</span> paired_data</span><br><span class="line">  <span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生存分析函数</span></span><br><span class="line">perform_survival_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>gene_name <span class="operator">=</span> <span class="string">&quot;BTK&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  setwd<span class="punctuation">(</span><span class="string">&quot;../survival&quot;</span><span class="punctuation">)</span></span><br><span class="line">  surv <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;exp_surv_01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                    check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">  surv<span class="operator">$</span>OS.time <span class="operator">&lt;-</span> surv<span class="operator">$</span>OS.time <span class="operator">/</span> <span class="number">365</span>  <span class="comment"># 转换为年</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 分组</span></span><br><span class="line">  surv<span class="operator">$</span>group <span class="operator">&lt;-</span> ifelse<span class="punctuation">(</span>surv<span class="punctuation">[[</span>gene_name<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&gt;</span> median<span class="punctuation">(</span>surv<span class="punctuation">[[</span>gene_name<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> na.rm <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="string">&quot;High&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Low&quot;</span><span class="punctuation">)</span></span><br><span class="line">  surv<span class="operator">$</span>group <span class="operator">&lt;-</span> factor<span class="punctuation">(</span>surv<span class="operator">$</span>group<span class="punctuation">,</span> levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&quot;分组情况:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">  print<span class="punctuation">(</span>table<span class="punctuation">(</span>surv<span class="operator">$</span>group<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 生存差异检验</span></span><br><span class="line">  fitd <span class="operator">&lt;-</span> survdiff<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> surv<span class="punctuation">,</span> na.action <span class="operator">=</span> na.exclude<span class="punctuation">)</span></span><br><span class="line">  pValue <span class="operator">&lt;-</span> 1 <span class="operator">-</span> pchisq<span class="punctuation">(</span>fitd<span class="operator">$</span>chisq<span class="punctuation">,</span> <span class="built_in">length</span><span class="punctuation">(</span>fitd<span class="operator">$</span>n<span class="punctuation">)</span> <span class="operator">-</span> <span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 拟合生存曲线</span></span><br><span class="line">  fit <span class="operator">&lt;-</span> survfit<span class="punctuation">(</span>Surv<span class="punctuation">(</span>OS.time<span class="punctuation">,</span> OS<span class="punctuation">)</span> <span class="operator">~</span> group<span class="punctuation">,</span> data <span class="operator">=</span> surv<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 格式化p值</span></span><br><span class="line">  p.lab <span class="operator">&lt;-</span> paste0<span class="punctuation">(</span><span class="string">&quot;P&quot;</span><span class="punctuation">,</span> ifelse<span class="punctuation">(</span>pValue <span class="operator">&lt;</span> <span class="number">0.001</span><span class="punctuation">,</span> <span class="string">&quot; &lt; 0.001&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                             paste0<span class="punctuation">(</span><span class="string">&quot; = &quot;</span><span class="punctuation">,</span> <span class="built_in">round</span><span class="punctuation">(</span>pValue<span class="punctuation">,</span> <span class="number">3</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制生存曲线</span></span><br><span class="line">  survival_plot <span class="operator">&lt;-</span> ggsurvplot<span class="punctuation">(</span></span><br><span class="line">    fit<span class="punctuation">,</span></span><br><span class="line">    data <span class="operator">=</span> surv<span class="punctuation">,</span></span><br><span class="line">    pval <span class="operator">=</span> p.lab<span class="punctuation">,</span></span><br><span class="line">    conf.int <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">    risk.table <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">    risk.table.col <span class="operator">=</span> <span class="string">&quot;strata&quot;</span><span class="punctuation">,</span></span><br><span class="line">    palette <span class="operator">=</span> <span class="string">&quot;jco&quot;</span><span class="punctuation">,</span></span><br><span class="line">    legend.labs <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;Low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;High&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    size <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    xlim <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">20</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    break.time.by <span class="operator">=</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    legend.title <span class="operator">=</span> gene_name<span class="punctuation">,</span></span><br><span class="line">    surv.median.line <span class="operator">=</span> <span class="string">&quot;hv&quot;</span><span class="punctuation">,</span></span><br><span class="line">    ylab <span class="operator">=</span> <span class="string">&quot;Survival probability (%)&quot;</span><span class="punctuation">,</span></span><br><span class="line">    xlab <span class="operator">=</span> <span class="string">&quot;Time (Years)&quot;</span><span class="punctuation">,</span></span><br><span class="line">    ncensor.plot <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">    ncensor.plot.height <span class="operator">=</span> <span class="number">0.25</span><span class="punctuation">,</span></span><br><span class="line">    risk.table.y.text <span class="operator">=</span> <span class="literal">FALSE</span></span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 保存图片</span></span><br><span class="line">  ggsave<span class="punctuation">(</span>paste0<span class="punctuation">(</span>gene_name<span class="punctuation">,</span> <span class="string">&quot;_survival_plot.png&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> survival_plot<span class="operator">$</span>plot<span class="punctuation">,</span></span><br><span class="line">         width <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span> dpi <span class="operator">=</span> <span class="number">300</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span><span class="built_in">list</span><span class="punctuation">(</span></span><br><span class="line">    survival_data <span class="operator">=</span> surv<span class="punctuation">,</span></span><br><span class="line">    p_value <span class="operator">=</span> pValue<span class="punctuation">,</span></span><br><span class="line">    plot <span class="operator">=</span> survival_plot</span><br><span class="line">  <span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 临床分期分析函数</span></span><br><span class="line">analyze_clinical_stage <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>gene_name <span class="operator">=</span> <span class="string">&quot;BTK&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  setwd<span class="punctuation">(</span><span class="string">&quot;../BTK&quot;</span><span class="punctuation">)</span></span><br><span class="line">  clinical.expr01A <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;clinical.expr01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                                check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 提取临床数据和基因表达</span></span><br><span class="line">  clinical_gene <span class="operator">&lt;-</span> cbind<span class="punctuation">(</span>clinical.expr01A<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">1</span><span class="operator">:</span><span class="number">6</span><span class="punctuation">]</span><span class="punctuation">,</span> clinical.expr01A<span class="punctuation">[</span><span class="punctuation">,</span> gene_name<span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  colnames<span class="punctuation">(</span>clinical_gene<span class="punctuation">)</span><span class="punctuation">[</span>ncol<span class="punctuation">(</span>clinical_gene<span class="punctuation">)</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> gene_name</span><br><span class="line">  </span><br><span class="line">  write.csv<span class="punctuation">(</span>clinical_gene<span class="punctuation">,</span> file <span class="operator">=</span> paste0<span class="punctuation">(</span><span class="string">&quot;clinical_&quot;</span><span class="punctuation">,</span> gene_name<span class="punctuation">,</span> <span class="string">&quot;.csv&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 统计各分期的样本数</span></span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&quot;各临床分期样本数:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">  print<span class="punctuation">(</span>table<span class="punctuation">(</span>clinical_gene<span class="operator">$</span>ajcc_pathologic_stage<span class="punctuation">,</span> useNA <span class="operator">=</span> <span class="string">&quot;always&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>clinical_gene<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主分析流程</span></span><br><span class="line">gene_name <span class="operator">&lt;-</span> <span class="string">&quot;BTK&quot;</span></span><br><span class="line"></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;开始分析基因:&quot;</span><span class="punctuation">,</span> gene_name<span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 表达差异分析</span></span><br><span class="line">expr_results <span class="operator">&lt;-</span> analyze_gene_expression<span class="punctuation">(</span>gene_name<span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;表达数据分析完成\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 生存分析</span></span><br><span class="line">survival_results <span class="operator">&lt;-</span> perform_survival_analysis<span class="punctuation">(</span>gene_name<span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;生存分析完成，p值 =&quot;</span><span class="punctuation">,</span> survival_results<span class="operator">$</span>p_value<span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 临床分期分析</span></span><br><span class="line">clinical_data <span class="operator">&lt;-</span> analyze_clinical_stage<span class="punctuation">(</span>gene_name<span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;临床分期分析完成\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成分析报告</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;\n=== 分析总结 ===\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;分析的基因:&quot;</span><span class="punctuation">,</span> gene_name<span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;肿瘤样本数:&quot;</span><span class="punctuation">,</span> nrow<span class="punctuation">(</span>expr_results<span class="operator">$</span>tumor_expr<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;正常样本数:&quot;</span><span class="punctuation">,</span> nrow<span class="punctuation">(</span>expr_results<span class="operator">$</span>normal_expr<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;配对样本数:&quot;</span><span class="punctuation">,</span> nrow<span class="punctuation">(</span>expr_results<span class="operator">$</span>paired_data<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;生存分析显著性:&quot;</span><span class="punctuation">,</span> ifelse<span class="punctuation">(</span>survival_results<span class="operator">$</span>p_value <span class="operator">&lt;</span> <span class="number">0.05</span><span class="punctuation">,</span> <span class="string">&quot;显著&quot;</span><span class="punctuation">,</span> <span class="string">&quot;不显著&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;生成的文件:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;-&quot;</span><span class="punctuation">,</span> paste0<span class="punctuation">(</span>gene_name<span class="punctuation">,</span> <span class="string">&quot;_01A.csv: 肿瘤样本表达数据\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;-&quot;</span><span class="punctuation">,</span> paste0<span class="punctuation">(</span>gene_name<span class="punctuation">,</span> <span class="string">&quot;_11A.csv: 正常样本表达数据\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- paired_data.csv: 配对样本数据\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;-&quot;</span><span class="punctuation">,</span> paste0<span class="punctuation">(</span>gene_name<span class="punctuation">,</span> <span class="string">&quot;_survival_plot.png: 生存曲线图\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;-&quot;</span><span class="punctuation">,</span> paste0<span class="punctuation">(</span><span class="string">&quot;clinical_&quot;</span><span class="punctuation">,</span> gene_name<span class="punctuation">,</span> <span class="string">&quot;.csv: 临床分期数据\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;BTK基因分析流程完成！\n&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>整体研究意义</strong>：这套流程系统分析了BTK基因在肺癌中的表达模式、预后价值和临床相关性，为理解BTK在肿瘤发生发展中的作用提供了全面的证据，可能提示BTK作为潜在的治疗靶点或预后标志物。</p>
<h1 id="生信速通之七-BTK相关差异分析和GSEA富集分析"><a href="#生信速通之七-BTK相关差异分析和GSEA富集分析" class="headerlink" title="生信速通之七 BTK相关差异分析和GSEA富集分析"></a>生信速通之七 BTK相关差异分析和GSEA富集分析</h1><h2 id="第一部分：基于BTK表达的差异分析"><a href="#第一部分：基于BTK表达的差异分析" class="headerlink" title="第一部分：基于BTK表达的差异分析"></a>第一部分：基于BTK表达的差异分析</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####Day8####</span></span><br><span class="line"><span class="comment">####BTK差异分析####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;BTK_DEG&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>DESeq2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">counts_01A <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;counts01A.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>colnames<span class="punctuation">(</span>counts_01A<span class="punctuation">)</span><span class="punctuation">,</span>colnames<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="comment">#习惯性判断以防万一</span></span><br><span class="line">gene <span class="operator">&lt;-</span> <span class="string">&quot;BTK&quot;</span><span class="comment">#每次运行只改这个基因名</span></span><br><span class="line">med<span class="operator">=</span>median<span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">[</span>gene<span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">conditions<span class="operator">=</span>data.frame<span class="punctuation">(</span>sample<span class="operator">=</span>colnames<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                      group<span class="operator">=</span>factor<span class="punctuation">(</span>ifelse<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">[</span>gene<span class="punctuation">,</span><span class="punctuation">]</span><span class="operator">&gt;</span>med<span class="punctuation">,</span><span class="string">&quot;high&quot;</span><span class="punctuation">,</span><span class="string">&quot;low&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;low&quot;</span><span class="punctuation">,</span><span class="string">&quot;high&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> </span><br><span class="line">  column_to_rownames<span class="punctuation">(</span><span class="string">&quot;sample&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：根据BTK表达水平的中位数将肿瘤样本分为高BTK组和低BTK组，用于识别与BTK表达相关的差异表达基因。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>median(as.numeric(exp[gene,]))</code>: 计算BTK基因在所有样本中的表达中位数</li>
<li><code>ifelse(exp[gene,]&gt;med,&quot;high&quot;,&quot;low&quot;)</code>: 根据BTK表达水平分组</li>
<li><code>factor(levels = c(&quot;low&quot;,&quot;high&quot;))</code>: 设置因子水平，确保low组作为参照</li>
</ul>
<hr>
<h2 id="第二部分：DESeq2差异分析"><a href="#第二部分：DESeq2差异分析" class="headerlink" title="第二部分：DESeq2差异分析"></a>第二部分：DESeq2差异分析</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dds <span class="operator">&lt;-</span> DESeqDataSetFromMatrix<span class="punctuation">(</span></span><br><span class="line">  countData <span class="operator">=</span> counts_01A<span class="punctuation">,</span></span><br><span class="line">  colData <span class="operator">=</span> conditions<span class="punctuation">,</span></span><br><span class="line">  design <span class="operator">=</span> <span class="operator">~</span> group<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">dds <span class="operator">&lt;-</span> DESeq<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">resultsNames<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line">res <span class="operator">&lt;-</span> results<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>res<span class="punctuation">,</span>file<span class="operator">=</span><span class="string">&quot;DEG_BTK.Rda&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：使用DESeq2进行RNA-seq差异分析，识别在高BTK表达组和低BTK表达组中差异表达的基因。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>DESeqDataSetFromMatrix()</code>: 创建DESeq2数据对象</li>
<li><code>DESeq()</code>: 执行完整的差异分析流程</li>
<li><code>results()</code>: 提取差异分析结果</li>
</ul>
<hr>
<h2 id="第三部分：GSEA分析数据准备"><a href="#第三部分：GSEA分析数据准备" class="headerlink" title="第三部分：GSEA分析数据准备"></a>第三部分：GSEA分析数据准备</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####GSEA####</span></span><br><span class="line">library<span class="punctuation">(</span>org.Hs.eg.db<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>clusterProfiler<span class="punctuation">)</span></span><br><span class="line">DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>res<span class="punctuation">)</span><span class="operator">%&gt;%</span> arrange<span class="punctuation">(</span>padj<span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line">DEG <span class="operator">&lt;-</span> DEG <span class="operator">%&gt;%</span> rownames_to_column<span class="punctuation">(</span><span class="string">&quot;Gene&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">geneList <span class="operator">=</span> DEG<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">]</span></span><br><span class="line"><span class="built_in">names</span><span class="punctuation">(</span>geneList<span class="punctuation">)</span> <span class="operator">=</span> <span class="built_in">as.character</span><span class="punctuation">(</span>DEG<span class="punctuation">[</span><span class="punctuation">,</span><span class="string">&#x27;Gene&#x27;</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">head<span class="punctuation">(</span>geneList<span class="punctuation">)</span></span><br><span class="line">geneList <span class="operator">=</span> sort<span class="punctuation">(</span>geneList<span class="punctuation">,</span> decreasing <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">head<span class="punctuation">(</span>geneList<span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：准备GSEA分析所需的排序基因列表，基因按log2FoldChange从大到小排序。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>arrange(padj)</code>: 按校正p值升序排列</li>
<li><code>geneList = DEG[,3]</code>: 提取log2FoldChange列（通常是第3列）</li>
<li><code>sort(geneList, decreasing = TRUE)</code>: 按log2FC降序排列，这是GSEA分析的要求</li>
</ul>
<hr>
<h2 id="第四部分：Hallmark基因集GSEA分析"><a href="#第四部分：Hallmark基因集GSEA分析" class="headerlink" title="第四部分：Hallmark基因集GSEA分析"></a>第四部分：Hallmark基因集GSEA分析</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#GSEA基因集：https://zhuanlan.zhihu.com/p/504101161</span></span><br><span class="line"></span><br><span class="line">msigdb_GMTs <span class="operator">&lt;-</span> <span class="string">&quot;msigdb_v7.0_GMTs&quot;</span></span><br><span class="line">msigdb <span class="operator">&lt;-</span> <span class="string">&quot;h.all.v7.0.symbols.gmt&quot;</span>    </span><br><span class="line"><span class="comment">#读取上面指定的gmt文件</span></span><br><span class="line">kegmt <span class="operator">&lt;-</span> read.gmt<span class="punctuation">(</span>file.path<span class="punctuation">(</span>msigdb_GMTs<span class="punctuation">,</span>msigdb<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">set.seed<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span> <span class="comment">#设置种子</span></span><br><span class="line">gsea <span class="operator">&lt;-</span>GSEA<span class="punctuation">(</span>geneList<span class="punctuation">,</span>TERM2GENE <span class="operator">=</span> kegmt<span class="punctuation">)</span> <span class="comment">#GSEA分析</span></span><br><span class="line"><span class="comment">#转换成数据框</span></span><br><span class="line">gsea_result_df <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>gsea<span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>gsea<span class="punctuation">,</span>gsea_result_df<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;GSEA_BTK_h.all.rda&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：使用MSigDB的Hallmark基因集进行GSEA分析，识别在BTK高表达样本中协同上调或下调的生物学通路。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>read.gmt()</code>: 读取GMT格式的基因集文件</li>
<li><code>GSEA()</code>: 执行基因集富集分析</li>
<li><code>set.seed(1)</code>: 设置随机种子保证结果可重复</li>
</ul>
<hr>
<h2 id="第五部分：GSEA结果可视化"><a href="#第五部分：GSEA结果可视化" class="headerlink" title="第五部分：GSEA结果可视化"></a>第五部分：GSEA结果可视化</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#绘图</span></span><br><span class="line">library<span class="punctuation">(</span>enrichplot<span class="punctuation">)</span></span><br><span class="line"><span class="comment">#单个结果绘制</span></span><br><span class="line">gseaplot2<span class="punctuation">(</span>gsea<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>color<span class="operator">=</span><span class="string">&quot;red&quot;</span><span class="punctuation">,</span>pvalue_table <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#多个结果绘制</span></span><br><span class="line"><span class="comment">#A</span></span><br><span class="line">gseaplot2<span class="punctuation">(</span>gsea<span class="punctuation">,</span> geneSetID <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">8</span><span class="punctuation">,</span><span class="number">10</span><span class="punctuation">)</span><span class="punctuation">,</span> subplots <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#B</span></span><br><span class="line">gseaplot2<span class="punctuation">(</span>gsea<span class="punctuation">,</span> geneSetID <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">7</span><span class="punctuation">,</span><span class="number">9</span><span class="punctuation">,</span><span class="number">11</span><span class="punctuation">,</span><span class="number">13</span><span class="punctuation">,</span><span class="number">14</span><span class="punctuation">,</span><span class="number">16</span><span class="punctuation">,</span><span class="number">17</span><span class="punctuation">)</span><span class="punctuation">,</span> subplots <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">gseaplot2<span class="punctuation">(</span>gsea<span class="punctuation">,</span> geneSetID <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">10</span><span class="punctuation">,</span> subplots <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">)</span></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：可视化GSEA分析结果，展示基因集在排序基因列表中的富集情况。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>gseaplot2()</code>: 绘制GSEA富集图</li>
<li><code>geneSetID</code>: 指定要绘制的基因集ID</li>
<li><code>subplots = 1:3</code>: 显示三个子图（富集图、排名图、基因表）</li>
</ul>
<hr>
<h2 id="第六部分：免疫基因集GSEA分析"><a href="#第六部分：免疫基因集GSEA分析" class="headerlink" title="第六部分：免疫基因集GSEA分析"></a>第六部分：免疫基因集GSEA分析</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####换C7跑####</span></span><br><span class="line">msigdb_GMTs <span class="operator">&lt;-</span> <span class="string">&quot;msigdb_v7.0_GMTs&quot;</span></span><br><span class="line">msigdb <span class="operator">&lt;-</span> <span class="string">&quot;c7.all.v7.0.symbols.gmt&quot;</span>    </span><br><span class="line"><span class="comment">#读取上面指定的gmt文件</span></span><br><span class="line">kegmt <span class="operator">&lt;-</span> read.gmt<span class="punctuation">(</span>file.path<span class="punctuation">(</span>msigdb_GMTs<span class="punctuation">,</span>msigdb<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">set.seed<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span> <span class="comment">#设置种子</span></span><br><span class="line">gsea <span class="operator">&lt;-</span>GSEA<span class="punctuation">(</span>geneList<span class="punctuation">,</span>TERM2GENE <span class="operator">=</span> kegmt<span class="punctuation">)</span> <span class="comment">#GSEA分析</span></span><br><span class="line"><span class="comment">#转换成数据框</span></span><br><span class="line">gsea_result_df <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>gsea<span class="punctuation">)</span></span><br><span class="line">save<span class="punctuation">(</span>gsea<span class="punctuation">,</span>gsea_result_df<span class="punctuation">,</span>file <span class="operator">=</span> <span class="string">&quot;GSEA_BTK_c7.rda&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：使用MSigDB的C7免疫基因集进行GSEA分析，特别关注BTK与免疫相关通路的关联。</p>
<p><strong>研究意义</strong>：C7基因集包含免疫系统相关的基因签名，适合分析BTK这种免疫相关基因的功能。</p>
<hr>
<h2 id="完整代码-4"><a href="#完整代码-4" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### Day8 ####</span></span><br><span class="line"><span class="comment">#### BTK相关差异分析和GSEA富集分析 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/BTK_DEG&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>DESeq2<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>clusterProfiler<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>enrichplot<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>org.Hs.eg.db<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于基因表达的差异分析函数</span></span><br><span class="line">perform_gene_based_DEG <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>gene_name <span class="operator">=</span> <span class="string">&quot;BTK&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 读取数据</span></span><br><span class="line">  counts_01A <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;counts01A.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                          check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                   check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 数据验证</span></span><br><span class="line">  <span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span>identical<span class="punctuation">(</span>colnames<span class="punctuation">(</span>counts_01A<span class="punctuation">)</span><span class="punctuation">,</span> colnames<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    stop<span class="punctuation">(</span><span class="string">&quot;counts和TPM数据的样本不匹配！&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 计算目标基因的中位数并分组</span></span><br><span class="line">  med <span class="operator">&lt;-</span> median<span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">[</span>gene_name<span class="punctuation">,</span> <span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> na.rm <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  conditions <span class="operator">&lt;-</span> data.frame<span class="punctuation">(</span></span><br><span class="line">    sample <span class="operator">=</span> colnames<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    group <span class="operator">=</span> factor<span class="punctuation">(</span>ifelse<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">[</span>gene_name<span class="punctuation">,</span> <span class="punctuation">]</span> <span class="operator">&gt;</span> med<span class="punctuation">,</span> <span class="string">&quot;high&quot;</span><span class="punctuation">,</span> <span class="string">&quot;low&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                   levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;high&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">)</span> <span class="operator">%&gt;%</span> column_to_rownames<span class="punctuation">(</span><span class="string">&quot;sample&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&quot;分组情况:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">  print<span class="punctuation">(</span>table<span class="punctuation">(</span>conditions<span class="operator">$</span>group<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># DESeq2差异分析</span></span><br><span class="line">  dds <span class="operator">&lt;-</span> DESeqDataSetFromMatrix<span class="punctuation">(</span></span><br><span class="line">    countData <span class="operator">=</span> counts_01A<span class="punctuation">,</span></span><br><span class="line">    colData <span class="operator">=</span> conditions<span class="punctuation">,</span></span><br><span class="line">    design <span class="operator">=</span> <span class="operator">~</span> group</span><br><span class="line">  <span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  dds <span class="operator">&lt;-</span> DESeq<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line">  res <span class="operator">&lt;-</span> results<span class="punctuation">(</span>dds<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 保存结果</span></span><br><span class="line">  save<span class="punctuation">(</span>res<span class="punctuation">,</span> file <span class="operator">=</span> paste0<span class="punctuation">(</span><span class="string">&quot;DEG_&quot;</span><span class="punctuation">,</span> gene_name<span class="punctuation">,</span> <span class="string">&quot;.Rda&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>res<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GSEA分析函数</span></span><br><span class="line">perform_GSEA_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>DEG_results<span class="punctuation">,</span> geneset_type <span class="operator">=</span> <span class="string">&quot;h.all&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 准备基因列表</span></span><br><span class="line">  DEG <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>DEG_results<span class="punctuation">)</span> <span class="operator">%&gt;%</span> arrange<span class="punctuation">(</span>padj<span class="punctuation">)</span></span><br><span class="line">  DEG <span class="operator">&lt;-</span> DEG <span class="operator">%&gt;%</span> rownames_to_column<span class="punctuation">(</span><span class="string">&quot;Gene&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  geneList <span class="operator">&lt;-</span> DEG<span class="operator">$</span>log2FoldChange</span><br><span class="line">  <span class="built_in">names</span><span class="punctuation">(</span>geneList<span class="punctuation">)</span> <span class="operator">&lt;-</span> <span class="built_in">as.character</span><span class="punctuation">(</span>DEG<span class="operator">$</span>Gene<span class="punctuation">)</span></span><br><span class="line">  geneList <span class="operator">&lt;-</span> sort<span class="punctuation">(</span>geneList<span class="punctuation">,</span> decreasing <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 选择基因集</span></span><br><span class="line">  msigdb_GMTs <span class="operator">&lt;-</span> <span class="string">&quot;msigdb_v7.0_GMTs&quot;</span></span><br><span class="line">  <span class="keyword">if</span><span class="punctuation">(</span>geneset_type <span class="operator">==</span> <span class="string">&quot;h.all&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    msigdb <span class="operator">&lt;-</span> <span class="string">&quot;h.all.v7.0.symbols.gmt&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="keyword">if</span><span class="punctuation">(</span>geneset_type <span class="operator">==</span> <span class="string">&quot;c7&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    msigdb <span class="operator">&lt;-</span> <span class="string">&quot;c7.all.v7.0.symbols.gmt&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span> <span class="keyword">else</span> <span class="punctuation">&#123;</span></span><br><span class="line">    stop<span class="punctuation">(</span><span class="string">&quot;不支持的基因集类型&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 读取基因集</span></span><br><span class="line">  <span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span>file.exists<span class="punctuation">(</span>file.path<span class="punctuation">(</span>msigdb_GMTs<span class="punctuation">,</span> msigdb<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    stop<span class="punctuation">(</span>paste<span class="punctuation">(</span><span class="string">&quot;基因集文件不存在:&quot;</span><span class="punctuation">,</span> file.path<span class="punctuation">(</span>msigdb_GMTs<span class="punctuation">,</span> msigdb<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  kegmt <span class="operator">&lt;-</span> read.gmt<span class="punctuation">(</span>file.path<span class="punctuation">(</span>msigdb_GMTs<span class="punctuation">,</span> msigdb<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 执行GSEA分析</span></span><br><span class="line">  set.seed<span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span></span><br><span class="line">  gsea <span class="operator">&lt;-</span> GSEA<span class="punctuation">(</span>geneList<span class="punctuation">,</span> TERM2GENE <span class="operator">=</span> kegmt<span class="punctuation">,</span> pvalueCutoff <span class="operator">=</span> <span class="number">0.05</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 保存结果</span></span><br><span class="line">  gsea_result_df <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>gsea<span class="punctuation">)</span></span><br><span class="line">  save<span class="punctuation">(</span>gsea<span class="punctuation">,</span> gsea_result_df<span class="punctuation">,</span> file <span class="operator">=</span> paste0<span class="punctuation">(</span><span class="string">&quot;GSEA_BTK_&quot;</span><span class="punctuation">,</span> geneset_type<span class="punctuation">,</span> <span class="string">&quot;.rda&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&quot;GSEA分析完成，发现&quot;</span><span class="punctuation">,</span> nrow<span class="punctuation">(</span>gsea_result_df<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;个显著富集的基因集\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span><span class="built_in">list</span><span class="punctuation">(</span>gsea <span class="operator">=</span> gsea<span class="punctuation">,</span> results <span class="operator">=</span> gsea_result_df<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GSEA结果可视化函数</span></span><br><span class="line">visualize_GSEA_results <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>gsea_results<span class="punctuation">,</span> geneset_type <span class="operator">=</span> <span class="string">&quot;h.all&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  gsea <span class="operator">&lt;-</span> gsea_results<span class="operator">$</span>gsea</span><br><span class="line">  results_df <span class="operator">&lt;-</span> gsea_results<span class="operator">$</span>results</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 选择最显著的基因集进行可视化</span></span><br><span class="line">  top_pathways <span class="operator">&lt;-</span> head<span class="punctuation">(</span>results_df<span class="punctuation">,</span> <span class="number">10</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&quot;Top 10 显著富集通路:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">  print<span class="punctuation">(</span>top_pathways<span class="punctuation">[</span><span class="punctuation">,</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;ID&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Description&quot;</span><span class="punctuation">,</span> <span class="string">&quot;pvalue&quot;</span><span class="punctuation">,</span> <span class="string">&quot;p.adjust&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制多个GSEA图</span></span><br><span class="line">  <span class="keyword">if</span><span class="punctuation">(</span>nrow<span class="punctuation">(</span>top_pathways<span class="punctuation">)</span> <span class="operator">&gt;=</span> <span class="number">3</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment"># 绘制前3个最显著通路</span></span><br><span class="line">    gsea_plot <span class="operator">&lt;-</span> gseaplot2<span class="punctuation">(</span>gsea<span class="punctuation">,</span> geneSetID <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="built_in">min</span><span class="punctuation">(</span><span class="number">3</span><span class="punctuation">,</span> nrow<span class="punctuation">(</span>top_pathways<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">                          subplots <span class="operator">=</span> <span class="number">1</span><span class="operator">:</span><span class="number">3</span><span class="punctuation">,</span> pvalue_table <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 保存图片</span></span><br><span class="line">    ggsave<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;GSEA_&quot;</span><span class="punctuation">,</span> geneset_type<span class="punctuation">,</span> <span class="string">&quot;_top3.png&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> gsea_plot<span class="punctuation">,</span></span><br><span class="line">           width <span class="operator">=</span> <span class="number">12</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span> dpi <span class="operator">=</span> <span class="number">300</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制所有显著通路的点图</span></span><br><span class="line">  <span class="keyword">if</span><span class="punctuation">(</span>nrow<span class="punctuation">(</span>results_df<span class="punctuation">)</span> <span class="operator">&gt;</span> <span class="number">0</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    dot_plot <span class="operator">&lt;-</span> dotplot<span class="punctuation">(</span>gsea<span class="punctuation">,</span> showCategory <span class="operator">=</span> <span class="number">15</span><span class="punctuation">)</span> <span class="operator">+</span> </span><br><span class="line">      ggtitle<span class="punctuation">(</span>paste<span class="punctuation">(</span><span class="string">&quot;GSEA -&quot;</span><span class="punctuation">,</span> geneset_type<span class="punctuation">,</span> <span class="string">&quot;Gene Sets&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">    </span><br><span class="line">    ggsave<span class="punctuation">(</span>paste0<span class="punctuation">(</span><span class="string">&quot;GSEA_&quot;</span><span class="punctuation">,</span> geneset_type<span class="punctuation">,</span> <span class="string">&quot;_dotplot.png&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span> dot_plot<span class="punctuation">,</span></span><br><span class="line">           width <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span> dpi <span class="operator">=</span> <span class="number">300</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主分析流程</span></span><br><span class="line">gene_name <span class="operator">&lt;-</span> <span class="string">&quot;BTK&quot;</span></span><br><span class="line"></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;开始基于&quot;</span><span class="punctuation">,</span> gene_name<span class="punctuation">,</span> <span class="string">&quot;表达的差异分析和GSEA分析\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 执行差异分析</span></span><br><span class="line">DEG_results <span class="operator">&lt;-</span> perform_gene_based_DEG<span class="punctuation">(</span>gene_name<span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;差异分析完成\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Hallmark基因集GSEA分析</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;进行Hallmark基因集GSEA分析...\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">h_all_gsea <span class="operator">&lt;-</span> perform_GSEA_analysis<span class="punctuation">(</span>DEG_results<span class="punctuation">,</span> <span class="string">&quot;h.all&quot;</span><span class="punctuation">)</span></span><br><span class="line">visualize_GSEA_results<span class="punctuation">(</span>h_all_gsea<span class="punctuation">,</span> <span class="string">&quot;h.all&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 免疫基因集GSEA分析</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;进行免疫基因集GSEA分析...\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">c7_gsea <span class="operator">&lt;-</span> perform_GSEA_analysis<span class="punctuation">(</span>DEG_results<span class="punctuation">,</span> <span class="string">&quot;c7&quot;</span><span class="punctuation">)</span></span><br><span class="line">visualize_GSEA_results<span class="punctuation">(</span>c7_gsea<span class="punctuation">,</span> <span class="string">&quot;c7&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成分析报告</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;\n=== 分析总结 ===\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;目标基因:&quot;</span><span class="punctuation">,</span> gene_name<span class="punctuation">,</span> <span class="string">&quot;\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;差异分析: DEG_BTK.Rda\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;Hallmark GSEA: GSEA_BTK_h.all.rda\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;免疫基因集 GSEA: GSEA_BTK_c7.rda\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;生成的可视化文件:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- GSEA_h.all_top3.png: Hallmark top3通路\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- GSEA_h.all_dotplot.png: Hallmark通路点图\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- GSEA_c7_top3.png: 免疫top3通路\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- GSEA_c7_dotplot.png: 免疫通路点图\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;BTK相关分析流程完成！\n&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>整体研究意义</strong>：这套流程通过将样本按BTK表达水平分组，识别与BTK表达相关的差异基因，并通过GSEA分析揭示这些基因富集的生物学通路。特别地，使用Hallmark和免疫基因集可以全面了解BTK在肿瘤生物学和免疫调控中的作用，为理解BTK的功能机制和潜在治疗价值提供重要线索。</p>
<h2 id="生信速通之八-CIBERSORT免疫细胞浸润分析"><a href="#生信速通之八-CIBERSORT免疫细胞浸润分析" class="headerlink" title="生信速通之八 CIBERSORT免疫细胞浸润分析"></a>生信速通之八 CIBERSORT免疫细胞浸润分析</h2><h2 id="第一部分：CIBERSORT分析执行"><a href="#第一部分：CIBERSORT分析执行" class="headerlink" title="第一部分：CIBERSORT分析执行"></a>第一部分：CIBERSORT分析执行</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####Day9####</span></span><br><span class="line"><span class="comment">####cibersort####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD&quot;</span><span class="punctuation">)</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;CIBERSORT&quot;</span><span class="punctuation">)</span>   </span><br><span class="line"><span class="comment">#install.packages(&#x27;e1071&#x27;)</span></span><br><span class="line"><span class="comment">#install.packages(&#x27;parallel&#x27;)</span></span><br><span class="line"><span class="comment">#BiocManager::install(&quot;preprocessCore&quot;, version = &quot;3.17&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>e1071<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>parallel<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>preprocessCore<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">source<span class="punctuation">(</span><span class="string">&quot;CIBERSORT.R&quot;</span><span class="punctuation">)</span>   </span><br><span class="line">sig_matrix <span class="operator">&lt;-</span> <span class="string">&quot;LM22.txt&quot;</span>   </span><br><span class="line">mixture_file <span class="operator">=</span> <span class="string">&#x27;tpms01A_log2.txt&#x27;</span>   <span class="comment">#肿瘤患者表达谱</span></span><br><span class="line">res_cibersort <span class="operator">&lt;-</span> CIBERSORT<span class="punctuation">(</span>sig_matrix<span class="punctuation">,</span> mixture_file<span class="punctuation">,</span> perm<span class="operator">=</span><span class="number">100</span><span class="punctuation">,</span> QN<span class="operator">=</span><span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">res_cibersort <span class="operator">&lt;-</span> res_cibersort<span class="punctuation">[</span><span class="punctuation">,</span><span class="number">1</span><span class="operator">:</span><span class="number">22</span><span class="punctuation">]</span>   </span><br><span class="line">ciber.res <span class="operator">&lt;-</span> res_cibersort<span class="punctuation">[</span><span class="punctuation">,</span>colSums<span class="punctuation">(</span>res_cibersort<span class="punctuation">)</span> <span class="operator">&gt;</span> <span class="number">0</span><span class="punctuation">]</span>   <span class="comment">#去除丰度全为0的细胞</span></span><br><span class="line">ciber.res <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span></span><br><span class="line">write.table<span class="punctuation">(</span>ciber.res<span class="punctuation">,</span><span class="string">&quot;ciber.res.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span>col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span><span class="built_in">quote</span> <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：使用CIBERSORT算法基于基因表达数据反卷积计算22种免疫细胞在肿瘤样本中的相对比例。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>source(&quot;CIBERSORT.R&quot;)</code>: 加载CIBERSORT算法源代码</li>
<li><code>LM22.txt</code>: 包含22种免疫细胞特征基因的签名矩阵</li>
<li><code>perm=100</code>: 置换检验次数，用于计算p值</li>
<li><code>QN=TRUE</code>: 执行分位数标准化</li>
</ul>
<hr>
<h2 id="第二部分：免疫细胞比例可视化"><a href="#第二部分：免疫细胞比例可视化" class="headerlink" title="第二部分：免疫细胞比例可视化"></a>第二部分：免疫细胞比例可视化</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####cibersort彩虹图 代码无需掌握####</span></span><br><span class="line">mycol <span class="operator">&lt;-</span> ggplot2<span class="operator">::</span>alpha<span class="punctuation">(</span>rainbow<span class="punctuation">(</span>ncol<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">0.7</span><span class="punctuation">)</span> <span class="comment">#创建彩虹色板（带70%透明度）</span></span><br><span class="line">par<span class="punctuation">(</span>bty<span class="operator">=</span><span class="string">&quot;o&quot;</span><span class="punctuation">,</span> mgp <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">2.5</span><span class="punctuation">,</span><span class="number">0.3</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span> mar <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">2.1</span><span class="punctuation">,</span><span class="number">4.1</span><span class="punctuation">,</span><span class="number">2.1</span><span class="punctuation">,</span><span class="number">10.1</span><span class="punctuation">)</span><span class="punctuation">,</span>tcl<span class="operator">=</span><span class="operator">-</span><span class="number">.25</span><span class="punctuation">,</span>las <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>xpd <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">)</span></span><br><span class="line">barplot<span class="punctuation">(</span>as.matrix<span class="punctuation">(</span>t<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        border <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="comment"># 柱子无边框</span></span><br><span class="line">        names.arg <span class="operator">=</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span>nrow<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># 无横坐标样本名</span></span><br><span class="line">        yaxt <span class="operator">=</span> <span class="string">&quot;n&quot;</span><span class="punctuation">,</span> <span class="comment"># 先不绘制y轴</span></span><br><span class="line">        ylab <span class="operator">=</span> <span class="string">&quot;Relative percentage&quot;</span><span class="punctuation">,</span> <span class="comment"># 修改y轴标签</span></span><br><span class="line">        col <span class="operator">=</span> mycol<span class="punctuation">)</span> <span class="comment"># 采用彩虹色板</span></span><br><span class="line">axis<span class="punctuation">(</span>side <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> at <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0.2</span><span class="punctuation">,</span><span class="number">0.4</span><span class="punctuation">,</span><span class="number">0.6</span><span class="punctuation">,</span><span class="number">0.8</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="comment"># 补齐y轴添加百分号</span></span><br><span class="line">     labels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;0%&quot;</span><span class="punctuation">,</span><span class="string">&quot;20%&quot;</span><span class="punctuation">,</span><span class="string">&quot;40%&quot;</span><span class="punctuation">,</span><span class="string">&quot;60%&quot;</span><span class="punctuation">,</span><span class="string">&quot;80%&quot;</span><span class="punctuation">,</span><span class="string">&quot;100%&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">legend<span class="punctuation">(</span>par<span class="punctuation">(</span><span class="string">&quot;usr&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span><span class="operator">-</span><span class="number">20</span><span class="punctuation">,</span> <span class="comment"># </span></span><br><span class="line">       par<span class="punctuation">(</span><span class="string">&quot;usr&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">4</span><span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line">       legend <span class="operator">=</span> colnames<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">       xpd <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">,</span></span><br><span class="line">       fill <span class="operator">=</span> mycol<span class="punctuation">,</span></span><br><span class="line">       cex <span class="operator">=</span> <span class="number">0.6</span><span class="punctuation">,</span> </span><br><span class="line">       border <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> </span><br><span class="line">       y.intersp <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">       x.intersp <span class="operator">=</span> <span class="number">0.2</span><span class="punctuation">,</span></span><br><span class="line">       bty <span class="operator">=</span> <span class="string">&quot;n&quot;</span><span class="punctuation">)</span></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span>   <span class="comment">#关闭画板</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：绘制堆叠柱状图展示每个样本中各种免疫细胞的相对比例，直观显示肿瘤微环境的免疫组成。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>rainbow()</code>: 生成彩虹色系</li>
<li><code>par()</code>: 设置图形参数，如边距、坐标轴样式等</li>
<li><code>barplot()</code>: 绘制堆叠柱状图</li>
<li><code>legend()</code>: 添加图例，显示各种免疫细胞类型</li>
</ul>
<hr>
<h2 id="第三部分：BTK高低组的免疫细胞差异"><a href="#第三部分：BTK高低组的免疫细胞差异" class="headerlink" title="第三部分：BTK高低组的免疫细胞差异"></a>第三部分：BTK高低组的免疫细胞差异</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#分组比较图</span></span><br><span class="line">a <span class="operator">&lt;-</span> ciber.res</span><br><span class="line"><span class="comment">#读取肿瘤患者01A表达谱</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">med<span class="operator">=</span>median<span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">[</span><span class="string">&quot;BTK&quot;</span><span class="punctuation">,</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> <span class="built_in">exp</span> <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> <span class="built_in">exp</span> <span class="operator">%&gt;%</span> mutate<span class="punctuation">(</span>group<span class="operator">=</span>factor<span class="punctuation">(</span>ifelse<span class="punctuation">(</span><span class="built_in">exp</span><span class="operator">$</span>BTK<span class="operator">&gt;</span>med<span class="punctuation">,</span><span class="string">&quot;high&quot;</span><span class="punctuation">,</span><span class="string">&quot;low&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;low&quot;</span><span class="punctuation">,</span><span class="string">&quot;high&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">class</span><span class="punctuation">(</span><span class="built_in">exp</span><span class="operator">$</span>group<span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>a<span class="punctuation">)</span><span class="punctuation">,</span>rownames<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">a<span class="operator">$</span>group <span class="operator">&lt;-</span> <span class="built_in">exp</span><span class="operator">$</span>group</span><br><span class="line">a <span class="operator">&lt;-</span> a <span class="operator">%&gt;%</span> rownames_to_column<span class="punctuation">(</span><span class="string">&quot;sample&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggsci<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggpubr<span class="punctuation">)</span></span><br><span class="line">b <span class="operator">&lt;-</span> gather<span class="punctuation">(</span>a<span class="punctuation">,</span>key<span class="operator">=</span>CIBERSORT<span class="punctuation">,</span>value <span class="operator">=</span> Fraction<span class="punctuation">,</span><span class="operator">-</span><span class="built_in">c</span><span class="punctuation">(</span>group<span class="punctuation">,</span>sample<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">ggboxplot<span class="punctuation">(</span>b<span class="punctuation">,</span> x <span class="operator">=</span> <span class="string">&quot;CIBERSORT&quot;</span><span class="punctuation">,</span> y <span class="operator">=</span> <span class="string">&quot;Fraction&quot;</span><span class="punctuation">,</span></span><br><span class="line">          fill <span class="operator">=</span> <span class="string">&quot;group&quot;</span><span class="punctuation">,</span> palette <span class="operator">=</span> <span class="string">&quot;lancet&quot;</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  stat_compare_means<span class="punctuation">(</span>aes<span class="punctuation">(</span>group <span class="operator">=</span> group<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                     method <span class="operator">=</span> <span class="string">&quot;wilcox.test&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     label <span class="operator">=</span> <span class="string">&quot;p.signif&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     symnum.args<span class="operator">=</span><span class="built_in">list</span><span class="punctuation">(</span>cutpoints <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">0.001</span><span class="punctuation">,</span> <span class="number">0.01</span><span class="punctuation">,</span> <span class="number">0.05</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                                      symbols <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;***&quot;</span><span class="punctuation">,</span> <span class="string">&quot;**&quot;</span><span class="punctuation">,</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ns&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="operator">+</span></span><br><span class="line">  theme<span class="punctuation">(</span>text <span class="operator">=</span> element_text<span class="punctuation">(</span>size<span class="operator">=</span><span class="number">10</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">        axis.text.x <span class="operator">=</span> element_text<span class="punctuation">(</span>angle<span class="operator">=</span><span class="number">45</span><span class="punctuation">,</span> hjust<span class="operator">=</span><span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span> </span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：比较BTK高表达组和低表达组在各种免疫细胞浸润水平上的差异，探索BTK与免疫微环境的关联。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>gather()</code>: 将宽数据转换为长数据，便于ggplot2绘图</li>
<li><code>ggboxplot()</code>: 绘制分组箱线图</li>
<li><code>stat_compare_means()</code>: 添加组间统计检验结果</li>
<li><code>palette = &quot;lancet&quot;</code>: 使用柳叶刀杂志配色</li>
</ul>
<hr>
<h2 id="第四部分：免疫细胞相关性热图"><a href="#第四部分：免疫细胞相关性热图" class="headerlink" title="第四部分：免疫细胞相关性热图"></a>第四部分：免疫细胞相关性热图</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####相关性热图####</span></span><br><span class="line"><span class="comment">#install.packages(&quot;ggstatsplot&quot;)</span></span><br><span class="line"><span class="comment">#install.packages(&quot;ggcorrplot&quot;)</span></span><br><span class="line"><span class="comment">#install.packages(&quot;corrplot&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>ggstatsplot<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggcorrplot<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>corrplot<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">cor<span class="operator">&lt;-</span>sapply<span class="punctuation">(</span>ciber.res<span class="punctuation">,</span><span class="keyword">function</span><span class="punctuation">(</span>x<span class="punctuation">,</span>y<span class="punctuation">)</span> cor<span class="punctuation">(</span>x<span class="punctuation">,</span>y<span class="punctuation">,</span>method<span class="operator">=</span><span class="string">&quot;spearman&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span>ciber.res<span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>cor<span class="punctuation">)</span><span class="operator">&lt;-</span>colnames<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">ggcorrplot<span class="punctuation">(</span>cor<span class="punctuation">,</span> </span><br><span class="line">           hc.order <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> <span class="comment">#使用hc.order进行排序</span></span><br><span class="line">           type <span class="operator">=</span> <span class="string">&quot;upper&quot;</span><span class="punctuation">,</span> <span class="comment">#图片位置</span></span><br><span class="line">           outline.color <span class="operator">=</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span><span class="comment">#轮廓颜色</span></span><br><span class="line">           lab <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span><span class="comment">#true为在图上添加相关系数</span></span><br><span class="line">           ggtheme <span class="operator">=</span> ggplot2<span class="operator">::</span>theme_gray<span class="punctuation">,</span> <span class="comment">#指ggplot2函数对象，默认值为thememinimal</span></span><br><span class="line">           colors <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;#01468b&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;#ee0000&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：展示不同免疫细胞类型之间的相关性，识别共现或互斥的免疫细胞群体。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>sapply()</code>: 对数据框的每列应用函数计算相关性</li>
<li><code>ggcorrplot()</code>: 绘制相关性热图</li>
<li><code>hc.order = TRUE</code>: 使用层次聚类对行列进行排序</li>
<li><code>type = &quot;upper&quot;</code>: 只显示上三角部分</li>
</ul>
<hr>
<h2 id="第五部分：基因与免疫细胞相关性散点图"><a href="#第五部分：基因与免疫细胞相关性散点图" class="headerlink" title="第五部分：基因与免疫细胞相关性散点图"></a>第五部分：基因与免疫细胞相关性散点图</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">####基因与cibersort相关性散点图####</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">=</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line"><span class="built_in">exp</span> <span class="operator">&lt;-</span> <span class="built_in">exp</span><span class="punctuation">[</span><span class="string">&quot;BTK&quot;</span><span class="punctuation">,</span><span class="punctuation">]</span></span><br><span class="line">ciber <span class="operator">=</span> read.table<span class="punctuation">(</span><span class="string">&quot;ciber.res.txt&quot;</span><span class="punctuation">,</span>sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span>row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span>check.names <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>stringsAsFactors <span class="operator">=</span> <span class="built_in">F</span><span class="punctuation">,</span>header <span class="operator">=</span> <span class="built_in">T</span><span class="punctuation">)</span></span><br><span class="line">ciber <span class="operator">&lt;-</span> ciber <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">rownames<span class="punctuation">(</span>ciber<span class="punctuation">)</span> <span class="operator">&lt;-</span> gsub<span class="punctuation">(</span><span class="string">&quot; &quot;</span><span class="punctuation">,</span><span class="string">&quot;.&quot;</span><span class="punctuation">,</span>rownames<span class="punctuation">(</span>ciber<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">identical<span class="punctuation">(</span>colnames<span class="punctuation">(</span>ciber<span class="punctuation">)</span><span class="punctuation">,</span>colnames<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">exp_ciber <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">,</span>ciber<span class="punctuation">)</span></span><br><span class="line">exp_ciber <span class="operator">&lt;-</span> exp_ciber <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"><span class="comment">#install.packages(&quot;ggside&quot;)</span></span><br><span class="line">library<span class="punctuation">(</span>ggstatsplot<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggside<span class="punctuation">)</span></span><br><span class="line">ggscatterstats<span class="punctuation">(</span>data <span class="operator">=</span> exp_ciber<span class="punctuation">,</span> <span class="comment">#要分析的数据</span></span><br><span class="line">               y <span class="operator">=</span> BTK<span class="punctuation">,</span> <span class="comment">#设置Y轴</span></span><br><span class="line">               x <span class="operator">=</span> B.cells.naive<span class="punctuation">,</span><span class="comment">#设置X轴</span></span><br><span class="line">               type <span class="operator">=</span> <span class="string">&quot;nonparametric&quot;</span><span class="punctuation">,</span> </span><br><span class="line">               margins <span class="operator">=</span> <span class="string">&quot;both&quot;</span><span class="punctuation">,</span><span class="comment">#是否显示 边缘，默认为true                                      </span></span><br><span class="line">               xfill <span class="operator">=</span> <span class="string">&quot;#01468b&quot;</span><span class="punctuation">,</span> <span class="comment">#x轴边缘图形的颜色</span></span><br><span class="line">               yfill <span class="operator">=</span> <span class="string">&quot;#ee0000&quot;</span><span class="punctuation">,</span> <span class="comment">#y轴边缘图形的颜色</span></span><br><span class="line">               marginal.type <span class="operator">=</span> <span class="string">&quot;densigram&quot;</span><span class="punctuation">)</span><span class="comment">#在图片坐标轴边缘添加图形类型</span></span><br></pre></td></tr></table></figure>
<p><strong>实际应用</strong>：可视化BTK表达与特定免疫细胞（如初始B细胞）浸润水平的相关性，并显示统计检验结果。</p>
<p><strong>R语法说明</strong>：</p>
<ul>
<li><code>gsub(&quot; &quot;,&quot;.&quot;,rownames(ciber))</code>: 替换空格为点号，避免列名问题</li>
<li><code>ggscatterstats()</code>: 绘制带统计信息的散点图</li>
<li><code>marginals = &quot;both&quot;</code>: 在x轴和y轴显示边缘分布</li>
<li><code>marginal.type = &quot;densigram&quot;</code>: 边缘显示密度分布图</li>
</ul>
<hr>
<h2 id="完整代码-5"><a href="#完整代码-5" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### Day9 ####</span></span><br><span class="line"><span class="comment">#### CIBERSORT免疫细胞浸润分析 ####</span></span><br><span class="line">setwd<span class="punctuation">(</span><span class="string">&quot;TCGA-LUAD/CIBERSORT&quot;</span><span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>e1071<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>parallel<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>preprocessCore<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyverse<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggsci<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>tidyr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggpubr<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggcorrplot<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggstatsplot<span class="punctuation">)</span></span><br><span class="line">library<span class="punctuation">(</span>ggside<span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CIBERSORT分析函数</span></span><br><span class="line">perform_CIBERSORT_analysis <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>sig_matrix <span class="operator">=</span> <span class="string">&quot;LM22.txt&quot;</span><span class="punctuation">,</span> </span><br><span class="line">                                      mixture_file <span class="operator">=</span> <span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                      perm <span class="operator">=</span> <span class="number">100</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 加载CIBERSORT算法</span></span><br><span class="line">  source<span class="punctuation">(</span><span class="string">&quot;CIBERSORT.R&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 执行CIBERSORT分析</span></span><br><span class="line">  res_cibersort <span class="operator">&lt;-</span> CIBERSORT<span class="punctuation">(</span>sig_matrix<span class="punctuation">,</span> mixture_file<span class="punctuation">,</span> perm <span class="operator">=</span> perm<span class="punctuation">,</span> QN <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 提取细胞比例数据（前22列）</span></span><br><span class="line">  res_cibersort <span class="operator">&lt;-</span> res_cibersort<span class="punctuation">[</span><span class="punctuation">,</span> <span class="number">1</span><span class="operator">:</span><span class="number">22</span><span class="punctuation">]</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 去除丰度全为0的细胞类型</span></span><br><span class="line">  ciber.res <span class="operator">&lt;-</span> res_cibersort<span class="punctuation">[</span><span class="punctuation">,</span> colSums<span class="punctuation">(</span>res_cibersort<span class="punctuation">)</span> <span class="operator">&gt;</span> <span class="number">0</span><span class="punctuation">]</span></span><br><span class="line">  ciber.res <span class="operator">&lt;-</span> as.data.frame<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 保存结果</span></span><br><span class="line">  write.table<span class="punctuation">(</span>ciber.res<span class="punctuation">,</span> <span class="string">&quot;ciber.res.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span> </span><br><span class="line">              col.names <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span> <span class="built_in">quote</span> <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  cat<span class="punctuation">(</span><span class="string">&quot;CIBERSORT分析完成，检测到&quot;</span><span class="punctuation">,</span> ncol<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span><span class="punctuation">,</span> <span class="string">&quot;种免疫细胞\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>ciber.res<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 免疫细胞比例堆叠图</span></span><br><span class="line">plot_immune_composition <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>ciber.res<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  mycol <span class="operator">&lt;-</span> ggplot2<span class="operator">::</span>alpha<span class="punctuation">(</span>rainbow<span class="punctuation">(</span>ncol<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="number">0.7</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 设置图形参数</span></span><br><span class="line">  par<span class="punctuation">(</span>bty <span class="operator">=</span> <span class="string">&quot;o&quot;</span><span class="punctuation">,</span> mgp <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">2.5</span><span class="punctuation">,</span> <span class="number">0.3</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">      mar <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">2.1</span><span class="punctuation">,</span> <span class="number">4.1</span><span class="punctuation">,</span> <span class="number">2.1</span><span class="punctuation">,</span> <span class="number">10.1</span><span class="punctuation">)</span><span class="punctuation">,</span> </span><br><span class="line">      tcl <span class="operator">=</span> <span class="operator">-</span><span class="number">0.25</span><span class="punctuation">,</span> las <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span> xpd <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制堆叠柱状图</span></span><br><span class="line">  barplot<span class="punctuation">(</span>as.matrix<span class="punctuation">(</span>t<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">          border <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span></span><br><span class="line">          names.arg <span class="operator">=</span> <span class="built_in">rep</span><span class="punctuation">(</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span> nrow<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">          yaxt <span class="operator">=</span> <span class="string">&quot;n&quot;</span><span class="punctuation">,</span></span><br><span class="line">          ylab <span class="operator">=</span> <span class="string">&quot;Relative percentage&quot;</span><span class="punctuation">,</span></span><br><span class="line">          col <span class="operator">=</span> mycol<span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 添加y轴</span></span><br><span class="line">  axis<span class="punctuation">(</span>side <span class="operator">=</span> <span class="number">2</span><span class="punctuation">,</span> at <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">0.2</span><span class="punctuation">,</span> <span class="number">0.4</span><span class="punctuation">,</span> <span class="number">0.6</span><span class="punctuation">,</span> <span class="number">0.8</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">       labels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;0%&quot;</span><span class="punctuation">,</span> <span class="string">&quot;20%&quot;</span><span class="punctuation">,</span> <span class="string">&quot;40%&quot;</span><span class="punctuation">,</span> <span class="string">&quot;60%&quot;</span><span class="punctuation">,</span> <span class="string">&quot;80%&quot;</span><span class="punctuation">,</span> <span class="string">&quot;100%&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 添加图例</span></span><br><span class="line">  legend<span class="punctuation">(</span>par<span class="punctuation">(</span><span class="string">&quot;usr&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">2</span><span class="punctuation">]</span> <span class="operator">-</span> <span class="number">20</span><span class="punctuation">,</span> par<span class="punctuation">(</span><span class="string">&quot;usr&quot;</span><span class="punctuation">)</span><span class="punctuation">[</span><span class="number">4</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">         legend <span class="operator">=</span> colnames<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">         xpd <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">         fill <span class="operator">=</span> mycol<span class="punctuation">,</span></span><br><span class="line">         cex <span class="operator">=</span> <span class="number">0.6</span><span class="punctuation">,</span></span><br><span class="line">         border <span class="operator">=</span> <span class="literal">NA</span><span class="punctuation">,</span></span><br><span class="line">         y.intersp <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">         x.intersp <span class="operator">=</span> <span class="number">0.2</span><span class="punctuation">,</span></span><br><span class="line">         bty <span class="operator">=</span> <span class="string">&quot;n&quot;</span><span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分组比较分析</span></span><br><span class="line">compare_immune_by_gene <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>ciber.res<span class="punctuation">,</span> gene_name <span class="operator">=</span> <span class="string">&quot;BTK&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 读取表达数据</span></span><br><span class="line">  <span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                   check.names <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 根据基因表达分组</span></span><br><span class="line">  med <span class="operator">&lt;-</span> median<span class="punctuation">(</span><span class="built_in">as.numeric</span><span class="punctuation">(</span><span class="built_in">exp</span><span class="punctuation">[</span>gene_name<span class="punctuation">,</span> <span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">,</span> na.rm <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">  exp_t <span class="operator">&lt;-</span> <span class="built_in">exp</span> <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  exp_t <span class="operator">&lt;-</span> exp_t <span class="operator">%&gt;%</span> </span><br><span class="line">    mutate<span class="punctuation">(</span>group <span class="operator">=</span> factor<span class="punctuation">(</span>ifelse<span class="punctuation">(</span>exp_t<span class="punctuation">[[</span>gene_name<span class="punctuation">]</span><span class="punctuation">]</span> <span class="operator">&gt;</span> med<span class="punctuation">,</span> <span class="string">&quot;high&quot;</span><span class="punctuation">,</span> <span class="string">&quot;low&quot;</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                         levels <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;low&quot;</span><span class="punctuation">,</span> <span class="string">&quot;high&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 验证样本匹配</span></span><br><span class="line">  <span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span>identical<span class="punctuation">(</span>rownames<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>exp_t<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    stop<span class="punctuation">(</span><span class="string">&quot;免疫细胞数据与表达数据样本不匹配&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 合并数据</span></span><br><span class="line">  ciber_with_group <span class="operator">&lt;-</span> ciber.res</span><br><span class="line">  ciber_with_group<span class="operator">$</span>group <span class="operator">&lt;-</span> exp_t<span class="operator">$</span>group</span><br><span class="line">  ciber_with_group <span class="operator">&lt;-</span> ciber_with_group <span class="operator">%&gt;%</span> rownames_to_column<span class="punctuation">(</span><span class="string">&quot;sample&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 转换为长格式</span></span><br><span class="line">  ciber_long <span class="operator">&lt;-</span> gather<span class="punctuation">(</span>ciber_with_group<span class="punctuation">,</span> key <span class="operator">=</span> <span class="string">&quot;CellType&quot;</span><span class="punctuation">,</span> value <span class="operator">=</span> <span class="string">&quot;Fraction&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      <span class="operator">-</span><span class="built_in">c</span><span class="punctuation">(</span>group<span class="punctuation">,</span> sample<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制分组箱线图</span></span><br><span class="line">  p <span class="operator">&lt;-</span> ggboxplot<span class="punctuation">(</span>ciber_long<span class="punctuation">,</span> x <span class="operator">=</span> <span class="string">&quot;CellType&quot;</span><span class="punctuation">,</span> y <span class="operator">=</span> <span class="string">&quot;Fraction&quot;</span><span class="punctuation">,</span></span><br><span class="line">                fill <span class="operator">=</span> <span class="string">&quot;group&quot;</span><span class="punctuation">,</span> palette <span class="operator">=</span> <span class="string">&quot;lancet&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    stat_compare_means<span class="punctuation">(</span>aes<span class="punctuation">(</span>group <span class="operator">=</span> group<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                      method <span class="operator">=</span> <span class="string">&quot;wilcox.test&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      label <span class="operator">=</span> <span class="string">&quot;p.signif&quot;</span><span class="punctuation">,</span></span><br><span class="line">                      symnum.args <span class="operator">=</span> <span class="built_in">list</span><span class="punctuation">(</span></span><br><span class="line">                        cutpoints <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">,</span> <span class="number">0.001</span><span class="punctuation">,</span> <span class="number">0.01</span><span class="punctuation">,</span> <span class="number">0.05</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                        symbols <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;***&quot;</span><span class="punctuation">,</span> <span class="string">&quot;**&quot;</span><span class="punctuation">,</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span> <span class="string">&quot;ns&quot;</span><span class="punctuation">)</span></span><br><span class="line">                      <span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    theme<span class="punctuation">(</span>text <span class="operator">=</span> element_text<span class="punctuation">(</span>size <span class="operator">=</span> <span class="number">10</span><span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">          axis.text.x <span class="operator">=</span> element_text<span class="punctuation">(</span>angle <span class="operator">=</span> <span class="number">45</span><span class="punctuation">,</span> hjust <span class="operator">=</span> <span class="number">1</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    labs<span class="punctuation">(</span>title <span class="operator">=</span> paste<span class="punctuation">(</span><span class="string">&quot;免疫细胞浸润比较 -&quot;</span><span class="punctuation">,</span> gene_name<span class="punctuation">,</span> <span class="string">&quot;高低表达组&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>p<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 免疫细胞相关性热图</span></span><br><span class="line">plot_immune_correlation <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>ciber.res<span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 计算Spearman相关性</span></span><br><span class="line">  cor_matrix <span class="operator">&lt;-</span> cor<span class="punctuation">(</span>ciber.res<span class="punctuation">,</span> method <span class="operator">=</span> <span class="string">&quot;spearman&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制相关性热图</span></span><br><span class="line">  p <span class="operator">&lt;-</span> ggcorrplot<span class="punctuation">(</span>cor_matrix<span class="punctuation">,</span></span><br><span class="line">                 hc.order <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">                 type <span class="operator">=</span> <span class="string">&quot;upper&quot;</span><span class="punctuation">,</span></span><br><span class="line">                 outline.color <span class="operator">=</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span></span><br><span class="line">                 lab <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">,</span></span><br><span class="line">                 ggtheme <span class="operator">=</span> ggplot2<span class="operator">::</span>theme_gray<span class="punctuation">,</span></span><br><span class="line">                 colors <span class="operator">=</span> <span class="built_in">c</span><span class="punctuation">(</span><span class="string">&quot;#01468b&quot;</span><span class="punctuation">,</span> <span class="string">&quot;white&quot;</span><span class="punctuation">,</span> <span class="string">&quot;#ee0000&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    labs<span class="punctuation">(</span>title <span class="operator">=</span> <span class="string">&quot;免疫细胞类型相关性热图&quot;</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>p<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基因与免疫细胞相关性分析</span></span><br><span class="line">plot_gene_immune_correlation <span class="operator">&lt;-</span> <span class="keyword">function</span><span class="punctuation">(</span>gene_name <span class="operator">=</span> <span class="string">&quot;BTK&quot;</span><span class="punctuation">,</span> cell_type <span class="operator">=</span> <span class="string">&quot;B.cells.naive&quot;</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment"># 读取数据</span></span><br><span class="line">  <span class="built_in">exp</span> <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;tpms01A_log2.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                   check.names <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">  ciber <span class="operator">&lt;-</span> read.table<span class="punctuation">(</span><span class="string">&quot;ciber.res.txt&quot;</span><span class="punctuation">,</span> sep <span class="operator">=</span> <span class="string">&quot;\t&quot;</span><span class="punctuation">,</span> row.names <span class="operator">=</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                     check.names <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> stringsAsFactors <span class="operator">=</span> <span class="literal">FALSE</span><span class="punctuation">,</span> header <span class="operator">=</span> <span class="literal">TRUE</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 提取目标基因表达</span></span><br><span class="line">  gene_exp <span class="operator">&lt;-</span> <span class="built_in">exp</span><span class="punctuation">[</span>gene_name<span class="punctuation">,</span> <span class="punctuation">]</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 处理细胞类型名称</span></span><br><span class="line">  ciber_t <span class="operator">&lt;-</span> ciber <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  rownames<span class="punctuation">(</span>ciber_t<span class="punctuation">)</span> <span class="operator">&lt;-</span> gsub<span class="punctuation">(</span><span class="string">&quot; &quot;</span><span class="punctuation">,</span> <span class="string">&quot;.&quot;</span><span class="punctuation">,</span> rownames<span class="punctuation">(</span>ciber_t<span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 合并数据</span></span><br><span class="line">  <span class="keyword">if</span><span class="punctuation">(</span><span class="operator">!</span>identical<span class="punctuation">(</span>colnames<span class="punctuation">(</span>gene_exp<span class="punctuation">)</span><span class="punctuation">,</span> colnames<span class="punctuation">(</span>ciber_t<span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">)</span> <span class="punctuation">&#123;</span></span><br><span class="line">    stop<span class="punctuation">(</span><span class="string">&quot;基因表达数据与免疫细胞数据样本不匹配&quot;</span><span class="punctuation">)</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line">  </span><br><span class="line">  combined_data <span class="operator">&lt;-</span> rbind<span class="punctuation">(</span>gene_exp<span class="punctuation">,</span> ciber_t<span class="punctuation">)</span> <span class="operator">%&gt;%</span> t<span class="punctuation">(</span><span class="punctuation">)</span> <span class="operator">%&gt;%</span> as.data.frame<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line">  colnames<span class="punctuation">(</span>combined_data<span class="punctuation">)</span><span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="operator">&lt;-</span> gene_name</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 绘制相关性散点图</span></span><br><span class="line">  p <span class="operator">&lt;-</span> ggscatterstats<span class="punctuation">(</span>data <span class="operator">=</span> combined_data<span class="punctuation">,</span></span><br><span class="line">                     y <span class="operator">=</span> <span class="operator">!</span><span class="operator">!</span>sym<span class="punctuation">(</span>gene_name<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                     x <span class="operator">=</span> <span class="operator">!</span><span class="operator">!</span>sym<span class="punctuation">(</span>cell_type<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">                     type <span class="operator">=</span> <span class="string">&quot;nonparametric&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     margins <span class="operator">=</span> <span class="string">&quot;both&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     xfill <span class="operator">=</span> <span class="string">&quot;#01468b&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     yfill <span class="operator">=</span> <span class="string">&quot;#ee0000&quot;</span><span class="punctuation">,</span></span><br><span class="line">                     marginal.type <span class="operator">=</span> <span class="string">&quot;densigram&quot;</span><span class="punctuation">)</span> <span class="operator">+</span></span><br><span class="line">    labs<span class="punctuation">(</span>title <span class="operator">=</span> paste<span class="punctuation">(</span>gene_name<span class="punctuation">,</span> <span class="string">&quot;vs&quot;</span><span class="punctuation">,</span> cell_type<span class="punctuation">,</span> <span class="string">&quot;相关性分析&quot;</span><span class="punctuation">)</span><span class="punctuation">)</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">return</span><span class="punctuation">(</span>p<span class="punctuation">)</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主分析流程</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;开始CIBERSORT免疫细胞浸润分析\n&quot;</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 执行CIBERSORT分析</span></span><br><span class="line">ciber.res <span class="operator">&lt;-</span> perform_CIBERSORT_analysis<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 绘制免疫细胞组成图</span></span><br><span class="line">png<span class="punctuation">(</span><span class="string">&quot;immune_composition.png&quot;</span><span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">1200</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">800</span><span class="punctuation">)</span></span><br><span class="line">plot_immune_composition<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span></span><br><span class="line">dev.off<span class="punctuation">(</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. BTK分组比较</span></span><br><span class="line">btk_comparison <span class="operator">&lt;-</span> compare_immune_by_gene<span class="punctuation">(</span>ciber.res<span class="punctuation">,</span> <span class="string">&quot;BTK&quot;</span><span class="punctuation">)</span></span><br><span class="line">ggsave<span class="punctuation">(</span><span class="string">&quot;BTK_immune_comparison.png&quot;</span><span class="punctuation">,</span> btk_comparison<span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">12</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span> dpi <span class="operator">=</span> <span class="number">300</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 免疫细胞相关性热图</span></span><br><span class="line">correlation_heatmap <span class="operator">&lt;-</span> plot_immune_correlation<span class="punctuation">(</span>ciber.res<span class="punctuation">)</span></span><br><span class="line">ggsave<span class="punctuation">(</span><span class="string">&quot;immune_correlation_heatmap.png&quot;</span><span class="punctuation">,</span> correlation_heatmap<span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span> dpi <span class="operator">=</span> <span class="number">300</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. BTK与B细胞相关性</span></span><br><span class="line">btk_bcell_corr <span class="operator">&lt;-</span> plot_gene_immune_correlation<span class="punctuation">(</span><span class="string">&quot;BTK&quot;</span><span class="punctuation">,</span> <span class="string">&quot;B.cells.naive&quot;</span><span class="punctuation">)</span></span><br><span class="line">ggsave<span class="punctuation">(</span><span class="string">&quot;BTK_Bcell_correlation.png&quot;</span><span class="punctuation">,</span> btk_bcell_corr<span class="punctuation">,</span> width <span class="operator">=</span> <span class="number">10</span><span class="punctuation">,</span> height <span class="operator">=</span> <span class="number">8</span><span class="punctuation">,</span> dpi <span class="operator">=</span> <span class="number">300</span><span class="punctuation">)</span></span><br><span class="line"></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;CIBERSORT分析完成！\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;生成的文件:\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- ciber.res.txt: CIBERSORT结果\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- immune_composition.png: 免疫细胞组成图\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- BTK_immune_comparison.png: BTK分组比较\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- immune_correlation_heatmap.png: 免疫细胞相关性\n&quot;</span><span class="punctuation">)</span></span><br><span class="line">cat<span class="punctuation">(</span><span class="string">&quot;- BTK_Bcell_correlation.png: BTK与B细胞相关性\n&quot;</span><span class="punctuation">)</span></span><br></pre></td></tr></table></figure>
<p><strong>整体研究意义</strong>：这套流程全面分析了肿瘤微环境中的免疫细胞组成，特别关注BTK表达与免疫浸润的关系，为理解BTK在肿瘤免疫调控中的作用提供了重要证据，可能提示BTK作为免疫治疗反应的潜在生物标志物。</p>
<h1 id="尾言"><a href="#尾言" class="headerlink" title="尾言"></a>尾言</h1><p>终于，结束了吗？</p>
<p>并没有，一切只是新的开始。</p>
<p>从一开始的一头雾水，到懵懂地跑着代码，再到熟练地操作这些对象……您已经迈出了生信的第一步，也是最重要的一步。</p>
<p><em>知识理应共享</em></p>
<p>最后，让我们高呼：</p>
<p><strong>R，你乱搞&lt;-和=的事迹将会被天下的使用者怀恨在心！！！</strong></p>
<h1 id="R语言将会臭名昭著"><a href="#R语言将会臭名昭著" class="headerlink" title="R语言将会臭名昭著"></a><del>R语言将会臭名昭著</del></h1>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%94%9F%E7%89%A9%E4%BF%A1%E6%81%AF%E5%AD%A6/" rel="tag"># 生物信息学</a>
              <a href="/tags/TCGA/" rel="tag"># TCGA</a>
              <a href="/tags/%E6%9E%81%E9%80%9F%E7%89%88/" rel="tag"># 极速版</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/10/12/RegionalAnatomy/" rel="prev" title="局部解剖学札记">
                  <i class="fa fa-angle-left"></i> 局部解剖学札记
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/10/12/Rgrammar/" rel="next" title="R语言语法">
                  R语言语法 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">May_wind</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

<script type="text/javascript" async
  src="/js/mathjax/es5/tex-chtml.js">
</script>
<script type="text/x-mathjax-config">
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
